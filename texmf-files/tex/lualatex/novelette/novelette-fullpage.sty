%% This is file `novelette-fullpage.sty', part of `novelette' document class.
%% Copyright 2024 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-fullpage.sty}%
[2024/02/07 v0.38b LaTeX file (fullpage environment).]
%%

%% This file is loaded AtEndPreamble, when processing interior (not cover).


%%% The fullpage environment.
%   Each fullpage environment begins a new page. After it ends, the following
% material begins a new page. Although a fullpage environment is normally
% used for just one page at a time, it can extend to more than one page.
%   You may nest an upperpage environment at the top of fullpage or contents.
% This is helpful if the lower portion of that page contains on-grid text.
%   Commands \name, \subname, and \format may be used anywhere in fullpage.
% Default page style is empty (no printed header or footer), but you may
% locally over-ride using \thispagestyle.
%   Do not confuse fullpage environment with a full-page floated image.
\newenvironment{fullpage}{% May extend to second page.
  \clearpage%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \thispagestyle{empty}% May over-ride.
  \null\vspace*{-\@leading}% Helps \vfil, if used.
  \begingroup%
  \setlength\parindent{0pt}%
  \full@pagetrue\allow@icontrue\allow@imagetrue\prevent@floattrue\zm@rktrue%
}{% End the environment:
  \ifvmode\else\par\fi%
  \endgroup% No need to restore line grid.
  \clearpage%
}
%%

%% The legal environment. Useful for copyright page.
\newenvironment{legal}{
%  \iffull@page%
%    \fatal@err{You cannot place the legal environment within fullpage,^^J%
%      because legal creates its own fullpage. Easy fix is to remove the ^^J%
%      fullpage environment that currently surrounds legal.}%
%  \fi%
  \begin{fullpage}%
  \full@pagefalse\allow@imagefalse% Prevents use of \format, etc.
  \vfil%
  \nvt@center%
  \begingroup%
  \setlength\parskip{\@leading}%
  \pretolerance=10000% No hyphenation.
  \catcode`\"=12%
  \add@font@feature{Ligatures=ResetAll,Numbers=ResetAll,RawFeature={-tlig}}%
}{
  \ifvmode\else\par\fi%
  \endgroup%
  \nvt@endcenter%
  \vfil%
  \end{fullpage}%
}
%%

%% Simple dedication. Put it within fullpage:
\newcommand\dedication[1]{%
  \iffull@page%
    \begin{center}%
    \def\baselinestretch{1.14}%
    \itshape\add@font@feature{ScaleAgain=1.14,LetterSpace=2}%
    \spaceskip=1.14\fontdimen2\font %
      plus 1.14\fontdimen3\font minus 1.14\fontdimen4\font#1%
    \end{center}%
  \else%
    \nvt@err{\string\dedication\space may only be used within fullpage}%
      {The \string\dedication\space does not print anything unless you^^J%
       write it within a fullpage environment.}%
  \fi%
}
%%

%% Tools for constructing a table of contents, within fullpage.
\def\tc@gap{0} \let\tc@font\relax \def\tc@scale{1.4}
\DeclareDocumentCommand\contents{O{}m}{
  \@oktrue%
  \iffull@page\else\@okfalse\fi%
  \iffront@matter\else\@okfalse\fi%
  \ifodd\c@page\else\@okfalse\fi%
  \if@ok%
    \begingroup%
    \StrDel{#1,}{ }[\temp@s]%
    \check@fonts% In novelette-settings.
    \if@ok\xdef\tc@lf{\temp@d}\fi%
    \check@scale% In novelette-settings.
    \if@ok\xdef\tc@scale{\temp@d}\fi%
    \StrBehind{\temp@s}{gap=}[\temp@d]%
    \StrBefore{\temp@d}{,}[\temp@d]%
    \IfDecimal{\temp@d}{%
      \comp@re{\temp@d<0}{\@okfalse}{}%
      \comp@re{\temp@d>1}{\@okfalse}{}%
    }{
      \IfNada{\temp@d}{}{\@okfalse}%
    }%
    \if@ok\xdef\tc@gap{\temp@d}\fi%
    \if@ok%
      \ifvmode\else\par\fi%
      \ifthenelse{\equal{\tc@lf}{light}}{\f@light}{}%
      \ifthenelse{\equal{\tc@lf}{book}}{\f@book}{}%
      \ifthenelse{\equal{\tc@lf}{med}}{\f@med}{}%
      \ifthenelse{\equal{\tc@lf}{dark}}{\f@dark}{}%
      \addfontfeature{ScaleAgain=\tc@scale}%
      {\centering#2\par}%
      \null%
    \else%
      \nvt@err{Bad optional setting for \string\contents, page \this@page}%
        {\string\contents[gap=G,font=F,scale=S]{Title of Contents}^^J%
         G is a number, 0 to 1. Added line gap between entries. Default 0.^^J%
         F is one of main,light,book,med,dark. Default main.^^J%
         S is scale of table title. Default 1.4.}%
    \fi%
    \endgroup%
  \else%
    \nvt@err{Only use \string\contents\space in frontmatter fullpage}%
      {\string\contents\space may only be used within frontmatter,^^J%
       within a fullpage environment. It must begin on a recto (odd) page.}% 
  \fi%
}
\LetLtxMacro\content\contents\relax
%%
\newcommand\entry[2]{% {chapter}{page} Not automated! Do it yourself!
  \@oktrue%
  \iffull@page\else\@okfalse\fi%
  \iffront@matter\else\@okfalse\fi%
  \ifodd\c@page\else\@okfalse\fi%
  \if@ok%
    \ifvmode\else\par\fi%
    {\centering#1\space\space. . . \space#2\par}%
    \vspace{\tc@gap\@leading}%
  \else%
    \nvt@err{Only use \string\entry\space beneath \string\contents}%
      {\entry{chapter name}{page number} is for a table of contents.^^J%
       It may only be used in frontmatter fullpage recto, beneath^^J%
       \string\contents[options]{Title of Table}.}%
  \fi%
}
%%

%%
\def\start@align#1{%
  \ifthenelse{\equal{#1}{c}\OR\equal{#1}{}}{\nvt@center}{}%
  \ifthenelse{\equal{#1}{l}}{%
    \begin{flushleft}\setlength\leftskip{\block@left}%
  }{}%
  \ifthenelse{\equal{#1}{r}}{%
    \begin{flushright}\setlength\rightskip{\block@right}%
  }{}%
  \ifthenelse{\equal{#1}{o}}{%
    \ifodd\c@page%
      \begin{flushright}\setlength\rightskip{\block@right}%
    \else%
      \begin{flushleft}\setlength\leftskip{\block@left}%
    \fi%
  }{}%
  \ifthenelse{\equal{#1}{i}}{%
    \ifodd\c@page%
      \begin{flushleft}\setlength\leftskip{\block@left}%
    \else%
      \begin{flushright}\setlength\rightskip{\block@right}%
    \fi%
  }{}%
}
\def\stop@align#1{%
  \ifthenelse{\equal{#1}{c}\OR\equal{#1}{}}{\nvt@endcenter}{}%
  \ifthenelse{\equal{#1}{l}}{\end{flushleft}}{}%
  \ifthenelse{\equal{#1}{r}}{\end{flushright}}{}%
  \ifthenelse{\equal{#1}{o}}{%
    \ifodd\c@page\end{flushright}\else\end{flushleft}\fi%
  }{}%
  \ifthenelse{\equal{#1}{i}}{%
    \ifodd\c@page\end{flushleft}\else\end{flushright}\fi%
  }{}%
}
%%

%% The \format[options]{text} command may only be used in fullpage.
\def\f@scale{1} \def\f@lf{main} \def\f@align{c} \let\f@font\relax
\DeclareDocumentCommand\format{O{}m}{%
  \iffull@page%
    \begingroup\upshape\@oktrue%
    \ifvmode\else\strut\par\fi%
    \allow@imagefalse\prevent@floattrue%
    \pretolerance=10000% No hyphenation.
    \setlength\parindent{0pt}%
    \StrDel{#1,}{ }[\temp@s]%
    \check@fonts% In novelette-settings.sty.
    \if@ok\xdef\f@lf{\temp@d}\fi%
    \check@align% In novelette-settings.sty.
    \edef\f@align{\temp@d}%
    \check@scale% In novelette-settings.sty.
    \xdef\f@scale{\temp@d}%
    \if@ok%
      \def\baselinestretch{\f@scale}%
      \ifin@center\else\start@align{\f@align}\fi%
      \edef\temp@d{\fpeval{\f@scale*\@leading}}%
      \rule{0pt}{\temp@d pt}%
      \ifthenelse{\equal{\f@lf}{light}}{\f@light}{}%
      \ifthenelse{\equal{\f@lf}{book}}{\f@book}{}%
      \ifthenelse{\equal{\f@lf}{med}}{\f@med}{}%
      \ifthenelse{\equal{\f@lf}{dark}}{\f@dark}{}%
      \add@font@feature{ScaleAgain=\f@scale,%
        Numbers=ResetAll, LetterSpace=2}#2%
      \edef\temp@d{\fpeval{.3*\f@scale*\@leading}}%
      \rule{0pt}{\temp@d pt}%
      \ifin@center\else\stop@align{\f@align}\fi%
    \else%
      \nvt@err{Bad option for \string\format, page \this@page}%
        {The \string\format\space command uses this syntax:^^J%
         \string\format[align=A,scale=S,font=F]{text}^^J%
         A is one of l c r o i. Alignment. Default c.^^J%
         S is a number between .75 and 6. Scale. Default 1.^^J%
         F is one of main,light,book,med,dark. Default main.}%
    \fi%
    \endgroup%
  \else%
    \nvt@err{\string\format, page \this@page, disallowed there}%
      {\string\format\space commands are only allowed in fullpage.^^J%
       You used it somewhere else.}%
    \ifvmode\else\strut\par\fi#1\ifvmode\else\strut\par\fi%
  \fi%
}
%%


%%
\endinput
%%
%% End of file `novelette-fullpage.sty'.
