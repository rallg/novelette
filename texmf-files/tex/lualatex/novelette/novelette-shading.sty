%% This is file `novelette-shading.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-shading.sty}%
[2023/09/26 v0.17 LaTeX file (shadings for margins and guides).]
%%


%% This file is not loaded unless mode is shade. Never loaded for cover.


%% SHADE MODE
% Novelette provides \mode{shade} for ensuring that your printed content
% is aligned with your intended page layout. When using \mode{shade}:
%   1. Draft mode is also set.
%   2. The four margins are shaded gray.
%   3. If there is a header, the space between the header baseline and the
%      top of main text is shaded light gray. If the header has descenders
%      (oldstyle numerals, vertical bar, descending letters) then the
%      descenders will drop into this area. This is normal.
%        Note that "top of main text" is where the tallest Latin-1 letters,
%      Agrave and Aring, would rise. This applies whether or not those
%      letters are used. This is also where the top edge of top-aligned
%      images will sit.
%   4. The space below the last line of main text is shaded light gray.
%      With no footer, this space is the descender depth, or slightly more.
%      With footer, this space also includes the footer.
%   5. If you set guides, they appear as small light gray rectangles in
%      the side margins. Bottom of rectangle is as text baseline. Height of
%      rectangle is the lowercase x-height. These rectangles do not enlarge
%      for enlarged text.
%   6. A dark gray bar, at inside margin, shows the nominal area reserved
%      for spine glue. Its width is the difference between side margin widths.
%%


%% Most commands have each line ending in percent (without preceding space).

 
%% PAGE POSITIONS
\def\book@LL#1{% Lower left of booksize.
  \put(.5\pagewidth-.5\book@w,-.5\pageheight-.5\book@h){#1}%
}
\def\print@UL#1{% Upper left of printable area.
  \setlength\temp@l{.5\pagewidth-.5\book@w}%
  \ifodd\c@page%
    \put(\temp@l+\m@ins,-.5\pageheight+.5\book@h-\m@top){#1}%
  \else%
    \put(\temp@l+\m@out,-.5\pageheight+.5\book@h-\m@top){#1}%
  \fi%
}
\def\print@LL#1{% Lower left of printable area.
  \setlength\temp@l{.5\pagewidth-.5\book@w}%
  \ifodd\c@page%
    \put(\temp@l+\m@ins,-.5\pageheight-.5\book@h+\m@bot){#1}%
  \else%
    \put(\temp@l+\m@out,-.5\pageheight-.5\book@h+\m@bot){#1}%
  \fi%
}
%%


%% SHADING
\pretocmd\@kernel@before@shipout@background{%
  \ifhe@der%
    \print@UL{{\gr@y{.9}%
      \rule[-\headheight-\headsep]%
        {\textwidth}{\headheight+\headsep-\chars@ht}%
    }}%
  \fi%
  \iff@@ter%
    \print@LL{{\gr@y{.9}%
      \rule{\textwidth}{\le@ding+\footskip+\@slop}%
    }}%
  \else%
    \print@LL{{\gr@y{.9}%
      \rule{\textwidth}{\@slop}%
    }}%
  \fi%
  \book@LL{{\gr@y{.6}\rule{\book@w}{\m@bot}}}%
  \book@LL{{\gr@y{.6}%
    \rule[\book@h-\m@top]{\book@w}{\m@top}%
  }}%
  \ifodd\c@page%
    \book@LL{{\gr@y{.6}\rule{\m@ins}{\book@h}}}%
    \book@LL{\hspace*{\book@w-\m@out}{\gr@y{.6}%
      \rule{\m@out}{\book@h}%
    }}%
  \else%
    \book@LL{{\gr@y{.6}\rule{\m@out}{\book@h}}}%
    \book@LL{\hspace*{\book@w-\m@ins}{\gr@y{.6}%
      \rule{\m@ins}{\book@h}%
    }}%
  \fi%
  \place@guides%
  \ifthenelse{\dimtest{\m@ins}{>}{\m@out}}{%
    \ifodd\c@page\else\rule{\book@w-\m@ins+\m@out}{0pt}\fi%
    \book@LL{{\gr@y{.4}\rule{\m@ins-\m@out}{\book@h}}}%
  }{}%
}{\typeout{Shading applied.}}{\typeout{Shading failed.}}% Part of \pretocmd.
%%


%%
\def\process@guides{
  \fl@gtrue
  \StrDel{\@guides,}{ }[\temp@s]
  \StrCut{\temp@s}{,}{\temp@n}{\temp@d}
  \IfInteger{\temp@n}{
    \setlength\temp@l{\temp@n\le@ding+\chars@ht-\le@ding+\headheight+\headsep}
    \xdef\@guidea{-\the\temp@l}
  }{\ifthenelse{\equal{\temp@n}{}}{}{\fl@gfalse}}
  \StrCut{\temp@d}{,}{\temp@n}{\temp@s}
  \IfInteger{\temp@n}{
    \setlength\temp@l{\temp@n\le@ding+\chars@ht-\le@ding+\headheight+\headsep}
    \xdef\@guideb{-\the\temp@l}
  }{\ifthenelse{\equal{\temp@n}{}}{}{\fl@gfalse}}
  \StrCut{\temp@s}{,}{\temp@n}{\temp@d}
  \IfInteger{\temp@n}{
    \setlength\temp@l{\temp@n\le@ding+\chars@ht-\le@ding+\headheight+\headsep}
    \xdef\@guidec{-\the\temp@l}
  }{\ifthenelse{\equal{\temp@n}{}}{}{\fl@gfalse}}
  \StrCut{\temp@d}{,}{\temp@n}{\temp@s}
  \IfInteger{\temp@n}{
    \setlength\temp@l{\temp@n\le@ding+\chars@ht-\le@ding+\headheight+\headsep}
    \xdef\@guided{-\the\temp@l}
  }{\ifthenelse{\equal{\temp@n}{}}{}{\fl@gfalse}}
  \iffl@g\else
    \ClassWarningNoLine{novelette}{Bad value in \string\guides. No guides!}
    \gdef\@guides{} \gdef\no@guides{(Re-set to empty, due to bad setting.)}
  \fi
}
%%
\ifthenelse{\equal{\@guides}{}}{}{\process@guides}
%%


%%
\def\place@guides{%
  \ifdefined\@guidea%
    \print@UL{{\gr@y{.8}%
      \raisebox{\@guidea}{\hspace{-16pt}\rule{12pt}{\x@ht}}%
      \raisebox{\@guidea}{\hspace{\textwidth+8pt}\rule{12pt}{\x@ht}}%
    }}%
  \fi%
  \ifdefined\@guideb%
    \print@UL{{\gr@y{.8}%
      \raisebox{\@guideb}{\hspace{-16pt}\rule{12pt}{\x@ht}}%
      \raisebox{\@guideb}{\hspace{\textwidth+8pt}\rule{12pt}{\x@ht}}%
    }}%
  \fi%
  \ifdefined\@guidec%
    \print@UL{{\gr@y{.8}%
      \raisebox{\@guidec}{\hspace{-16pt}\rule{12pt}{\x@ht}}%
      \raisebox{\@guidec}{\hspace{\textwidth+8pt}\rule{12pt}{\x@ht}}%
    }}%
  \fi%
  \ifdefined\@guided%
    \print@UL{{\gr@y{.8}%
      \raisebox{\@guided}{\hspace{-16pt}\rule{12pt}{\x@ht}}%
      \raisebox{\@guided}{\hspace{\textwidth+8pt}\rule{12pt}{\x@ht}}%
    }}%
  \fi%
}
%%



%%
\endinput
%%
%% End of file `novelette-shading.sty'.
