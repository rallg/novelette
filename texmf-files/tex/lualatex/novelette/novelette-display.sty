%% This is file `novelette-display.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-display.sty}%
[2023/10/26 v0.21 LaTeX file (display pages).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).


%% DISPLAY PAGES
%   A display page is created by the display environment. It starts a new page,
% and clears to a new page when it ends. Although it is intended for an
% individual page, it may extend to more than one, if the content does not fit.
%   You may write ordinary text within a display, but not running main text.
% The header and footer will normally be empty, regardless of page layout.
%   You do not need to place an opening environment within a display.
% The \name and \subname commands may be used anywhere within it. You may also
% place images, in the usual fashion.
%   In display pages, and nowhere else, you may use \stylea, \styleb, and
% \stylec commands. These automatically invoke the associated fonts, and
% change their alignment and scale according to the command options. This is
% intended for special effects such as distinctive title pages.
%   You cannot float a display, so it cannot be used in the middle of
% other text. If you need to float some full-page content, then create it as
% a full-page image (complete with its text, as image).
%%


%% DISPLAY ENVIRONMENT
\newif\ifdisplay@page % True in display environment.
\newenvironment{displaypage}{%
  \clearpage%
  \thispagestyle{empty}%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \null\vspace*{-\le@ding}%
  \begingroup%
  \display@pagetrue%
  \zm@rktrue%
  \setlength\parindent{0pt}%
  %%%%%\setlength\parskip{\le@ding}%
}{% End the environment:
  \endgroup%
}
\AfterEndEnvironment{displaypage}{\clearpage}
%%


%% STYLEA STYLEB STYLEC
% Each of these commands may be used only in display pages. The styled text
% must be a single line (no wrap or line break). You may repeat the commands
% for multi-line text. Each instance acts independently.
%   This command is intended for distinctive text, such as Half-Title,
% Title, Author, dingbats.
\def\pns@align{c} \def\pns@scale{1}
\DeclareDocumentCommand\stylea{O{}m}{%
  \ifdisplay@page\@oktrue\else\@okfalse\fi%
  \if@ok%
    \par%
    \begingroup%
    \check@style{stylea}{#1}%
    \place@style{{\stylea@font\addfontfeature{ScaleAgain=\pns@scale}#2}}%
    \endgroup%
  \else%
    \@error{\string\stylea\space only allowed in display pages.^^J%
      Ignored \string\stylea\space on page \thepage.}%
    \par{\centering#2\par}%
  \fi%
}
%%
\DeclareDocumentCommand\styleb{O{}m}{%
  \ifdisplay@page\@oktrue\else\@okfalse\fi%
  \if@ok%
    \par%
    \begingroup%
    \check@style{styleb}{#1}%
    \place@style{{\styleb@font\addfontfeature{ScaleAgain=\pns@scale}#2}}%
    \endgroup%
  \else%
    \@error{\string\styleb\space only allowed in display pages.^^J%
      Ignored \string\styleb\space on page \thepage.}%
    \par{\centering#2\par}%
  \fi%
}
%%
\DeclareDocumentCommand\stylec{O{}m}{%
  \ifdisplay@page\@oktrue\else\@okfalse\fi%
  \if@ok%
    \par%
    \begingroup%
    \check@style{stylec}{#1}%
    \place@style{{\stylec@font\addfontfeature{ScaleAgain=\pns@scale}#2}}%
    \endgroup%
  \else%
    \@error{\string\stylec\space only allowed in display pages.^^J%
      Ignored \string\stylec\space on page \thepage.}%
    \par{\centering#2\par}%
  \fi%
}
%%


%%
\DeclareDocumentCommand\check@style{mm}{%
  \@oktrue%
  \StrDel{#2,}{ }[\temp@s]%
  \StrBehind{\temp@s}{align=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \ifthenelse{\equal{\temp@n}{}}{\def\pns@align{c}}{%
    \IfSubStr{:l:c:r:o:i:}{:\temp@n:}{%
      \edef\pns@align{\temp@n}%
    }{\@okfalse}%
  }%
  \StrBehind{\temp@s}{scale=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \ifthenelse{\equal{\temp@n}{}}{\def\pns@scale{1}}{%
    \IfDecimal{\temp@n}{%
      \ifthenelse{\fpeval{\temp@n<.75}=1}{\@okfalse}{\edef\pns@scale{\temp@n}}%
    }{\@okfalse}%
  }%
  \if@ok\else%
    \@error{Bad value in \string\#1[align=A,scale=S]{text}.^^J%
       A may be one of c l r o i. Horizontal alignment. Default c.^^J%
       S is a number >=.75. Scale. Default 1. On page \thepage.}%
  \fi%
}
%%


%% PLACE STYLE
\DeclareDocumentCommand\place@style{m}{%
  \par\vspace*{-\le@ding}\leavevmode\strut\par%
  \setlength\parindent{0pt}%
  \hyphenpenalty=20000%
  \edef\pns@tot{\fpeval{ceil(1.2*\pns@scale*\type@size/\le@ding)}}% %%%%%
  \edef\temp@d{\fpeval{\pns@tot-(1.2*\pns@scale*\type@size/\le@ding)}}%
  \edef\pns@ht{\fpeval{\temp@d+(.84*\pns@scale*\type@size/\le@ding)}}% %%%%%
  \edef\pns@dp{\fpeval{\pns@tot-\pns@ht}}% %%%%%
  \ifthenelse{\equal{\pns@align}{l}}{\raggedright}{}%
  \ifthenelse{\equal{\pns@align}{r}}{\raggedleft}{}%
  \ifthenelse{\equal{\pns@align}{o}}{%
    \ifodd\c@page\raggedleft\else\raggedright\fi%
  }{}%
  \ifthenelse{\equal{\pns@align}{i}}{%
    \ifodd\c@page\raggedright\else\raggedleft\fi%
  }%
  \ifthenelse{\equal{\pns@align}{c}}{%
    {\centering%
      \up@feeler{\pns@ht\le@ding}#1\dn@feeler{\pns@dp\le@ding}\par%
    }%
  }{%
    \up@feeler{\pns@ht\le@ding}#1\dn@feeler{\pns@dp\le@ding}\par%
  }%
  \vspace*{-\le@ding}\leavevmode\strut\par%
}
%%


%%
\endinput
%%
%% End of file `novelette-display.sty'.
