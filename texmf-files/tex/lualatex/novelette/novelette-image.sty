%% This is file `novelette-image.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-image.sty}%
[2023/09/06 v0.10 LaTeX file (alternative to graphics).]
%%


%%
% \image[placement]{content}[label]
% Optional placement is at most two letters:
%   One of clroi -> Horizontal center, left, right, outside, inside. Default c.
%   One of hpbtn -> Float here/top, page, bottom, top, or nofloat. Default h.
%   If float h, automatically invokes combination ht.
%   If float p, full-page centered vertically. Cannot put another on same page.
% No caption, no frame or border. If desired, design them into the image.
% Content may be an integer (if decimal, rounded up to integer):
%   Fake image (gray rectangle) displacing integer vertical lines of text.
%   Cannot use fake image in final mode.
% Content may be a real image filename, with .png extension:
%   File may be in same folder as main document, or a relative subfolder.
%   Cannot use absolute path, or ../ to move up directory.
%   In final mode, image will be inspected for conformance:
%     Format png, at 600pixels/inch (232.22 pixels/mm).
%     Monochrome black/white, at 1-bit per pixel. No transparency.
%     No private metadata (such as EXIF or color profile).
% Optional label, for keeping track of fake image:
%   Ignored if real image.
%   Truncated to max 24 characters.
%   Written into fake image rectangle.
%   Does not need any relationship to subsequent real image filename.
% Log file shows maximum image sizes, based on other settings.
%   Best to use fake images until all settings are fixed.
%%


%% Image command.
\DeclareDocumentCommand\image{O{ch}mO{fake image}}{%
  \ifhead@foot%
    \ifhf@image@command\else%
      \typeout{ALERT: No images allowed header|footer. Image command ignored.}%
      \global\hf@image@commandtrue
    \fi%
  \else%
    \parse@placement{#1}%
    \StrLeft{#3}{24}[\image@label]%
    \@oktrue%
    \StrPosition{#2}{/}[\temp@n]%
    \ifthenelse{\equal{\temp@n}{1}}{\@okfalse}{}%
    \StrCount{#2}{..}[\temp@n]%
    \ifthenelse{\equal{\temp@n}{0}}{}{\@okfalse}%
    \if@ok%
      \test@format{#2}%
    \else%
      \@error{Bad path to image, page \thepage.^^J%
        Image may be in same directory as main document.^^J%
        May be in subdirectory, relative to main document.^^J%
        Cannot use absolute path, or up .. path.^^J%
        Will attempt to substitute 2-line fake image.}%
      \re@lfalse% 
      \setlength\lines@high{2\le@ding}% Dummy placeholder.
      \def\image@label{MISSING IMAGE, NO SIZE}% 
    \fi%
    \begingroup%
    \setlength\parindent{0pt}%
    \ifre@l%
      \ifthenelse{\equal{\@mode}{final}\AND\NOT\equal{\@intent}{none}}{%
        \validate@image{#2}%
      }{}%
      \@addtofilelist{#2}%
      \ProvidesFile{#2}[png image]%
      \saveimageresource attr{/Interpolate true } cropbox {#2}%
      \sbox\image@box{\useimageresource\the\lastsavedimageresourceindex}%
    \else%
      \sbox\image@box{\gr@y{.6}%
        \rule{.5\textwidth}{\lines@high-.3\le@ding}%
      }%
    \fi%
    \setlength\image@width{\wd\image@box}%
    \setlength\image@height{\ht\image@box}%
    \print@image%
  \fi%
}
%%


%% Print image (real or fake).
\def\print@image{%
  \def\temp@n{\strip@pt\image@height}%
  \FPdiv{\temp@n}{\temp@n}{\strip@pt\le@ding}%
  \FPadd{\temp@n}{\temp@n}{1}%
  \FPtrunc{\temp@n}{\temp@n}{0}%
  \setlength\lines@high{\temp@n\le@ding}%
  \vspace*{-\le@ding}\null% Uniform descender above.
  \ifthenelse{\equal{\fps@figure}{}}{}{\@float{figure}}%
  \ifthenelse{\equal{\fps@figure}{b}}{}{\vspace*{.3\le@ding}}
  \leavevmode%
  \image@l%
  \IfSubStr{\image@args}{p}{%
    \setlength\temp@l{\textheight-\le@ding+\chars@ht}% %%%%%
    \rule{\feeler@wd}{\temp@l}% %%%%%
    \addtolength\temp@l{-.7\le@ding+\chars@ht}%
    \raisebox{0pt}{\rule{\feeler@wd}{\lines@high-.3\le@ding}}%
  }{%
    \IfSubStr{\image@args}{b}{%
      \rule{\feeler@wd}{\lines@high-.3\le@ding}%
      \usebox\image@box%
    }{%
      \rule{\feeler@wd}{\lines@high-.3\le@ding}%
      \smash{\raisebox{\chars@ht-.7\le@ding}{\usebox\image@box}}%
    }%
  }%
  \ifre@l\else\llap{\raisebox{.3\le@ding}{\image@label\rule{4pt}{0pt}}}\fi%
  \image@r%
  \par%
  \ifthenelse{\equal{\fps@figure}{}}{}{\end@float}%
  \endgroup%
}
%%


%% Parse Placement.
\def\parse@placement#1{%
  \@okfalse%
  \IfSubStr{:l:c:r:o:i:h:t:b:p:n:}{:#1:}{\@oktrue}{}%
  \IfSubStr{:lh:ch:rh:oh:ih:hl:hc:hr:ho:hi:}{:#1:}{\@oktrue}{}%
  \IfSubStr{:lt:ct:rt:ot:it:tl:tc:tr:to:ti:}{:#1:}{\@oktrue}{}%
  \IfSubStr{:lb:cb:rb:ob:ib:bl:bc:br:bo:bi:}{:#1:}{\@oktrue}{}%
  \IfSubStr{:lp:cp:rp:op:ip:pl:pc:pr:po:pi:}{:#1:}{\@oktrue}{}%
  \IfSubStr{:ln:cn:rn:on:in:nl:nc:nr:no:ni:}{:#1:}{\@oktrue}{}%
  \if@ok%
    \def\temp@n{}%
    \IfSubStr{#1}{l}{\def\temp@n{l}\def\image@l{}\def\image@r{\hfill}}{}%
    \IfSubStr{#1}{r}{\def\temp@n{r}\def\image@l{\hfill}\def\image@r{}}{}%
    \IfSubStr{#1}{o}{%
      \def\temp@n{o}%
      \def\image@l{\ifodd\c@page\hfill\else{}\fi}%
      \def\image@r{\ifodd\c@page{}\else\hfill\fi}%
    }{}%
    \IfSubStr{#1}{i}{%
      \def\temp@n{i}%
      \def\image@l{\ifodd\c@page{}\else\hfill\fi}%
      \def\image@r{\ifodd\c@page\hfill\else{}\fi}%
    }{}%
    \ifthenelse{\equal{\temp@n}{}}{%
      \def\temp@n{c}\def\image@l{\hfil}\def\image@r{\hfil}% Default.
    }{}%
    \def\temp@d{h}%
    \def\fps@figure{ht}% Default.
    \IfSubStr{#1}{p}{\def\temp@d{p}\def\fps@figure{b}}{}% Yes, b.
    \IfSubStr{#1}{b}{\def\temp@d{b}\def\fps@figure{b}}{}%
    \IfSubStr{#1}{t}{\def\temp@d{t}\def\fps@figure{t}}{}%
    \IfSubStr{#1}{h}{\def\temp@d{h}\def\fps@figure{ht}}{}% ht overrides lone h.
    \IfSubStr{#1}{n}{\def\temp@d{n}\def\fps@figure{}}{}%
  \else%
    \@error{Bad image placement option, page \thepage.^^J%
      Choose only one of: l c r o i. Horizontal alignment.^^J%
      And, choose only one of: h t b p n. Float placement.}%
    \def\temp@n{c}\def\image@l{\hfil}\def\image@r{\hfil}% Default.
  \fi%
  \ifdisplay@page\def\temp@d{n}\def\fps@figure{}\fi%
  \if@opening\def\temp@d{n}\def\fps@figure{}\fi%
  \edef\image@args{\temp@n\temp@d}%
}
%%


%% Test Format (real png, or fake integer).
\def\test@format#1{%
  \IfInteger{#1}{%
    \re@lfalse%
    \setlength\lines@high{#1\le@ding}%
  }{%
    \IfDecimal{#1}{%
      \FPadd{\temp@n}{#1}{1}%
      \FPtrunc{\temp@n}{\temp@n}{0}%
      \setlength\lines@high{\temp@n\leading}%
      \typeout{ALERT: Fake image height #1 rounded to \temp@n, page \thepage.}
    }{%
      \@okfalse%
      \IfEndWith{#1}{.png}{\@oktrue}{}%
      \IfEndWith{#1}{.PNG}{\@oktrue}{}%
      \if@ok%
        \IfFileExists{#1}{%
          \re@ltrue%
        }{%
          \@error{Image #1 not found. Is it png, in correct location?^^J%
            Will attempt to substitute a 2-line fake image.}%
          \re@lfalse%
          \setlength\lines@high{2\le@ding}% Dummy placeholder.
        }%
      \else%
        \@error{Problem with image #1.^^J%
          Must have file extension png or PNG,^^J%
          and may not be located using absolute path or ../path.
          Will attempt to substitute a 2-line fake image.}%
          \re@lfalse%
          \setlength\lines@high{2\le@ding}% Dummy placeholder.
          \def\image@label{MISSING IMAGE, NO SIZE}% 
     \fi%
    }%
  }%
}
%%


%% Validate Real Image (necessary for PDF/X conformance).
\def\validate@image#1{%
  \setcounter{nvt@count}{123456}%
  \addtocounter{nvt@count}{\pdf@filesize{#1}}%
  \def\temp@n{
    \directlua{
      img1=img.scan{filename="#1"}
      tex.print(img1.xsize)
    }%
  }%
  \addtocounter{nvt@count}{\temp@n}
  \def\temp@n{
    \directlua{
      img1=img.scan{filename="#1"}
      tex.print(img1.ysize)
    }%
  }%
  \addtocounter{nvt@count}{\temp@n}
  \def\temp@s{-nvtm\arabic{nvt@count}.}%
  \IfSubStr{#1}{\temp@s}{}{%
    \@error{Image #1 did not pass validation.^^J%
      In final mode, with intent other than none, all images^^J%
      must be pre-processed by script "mono4nvt". That creates^^J%
      another image with an encoded file name. This test failed^^J%
      because the encoded name did not agree with the image properties.}%
  }%
}
%%


%% Log Image Specifications (suggest image sizes).
\def\log@imagespecs{
  \FPsub{\temp@n}{\strip@pt\textwidth}{.1}
  \FPmul{\temp@n}{\temp@n}{8.3022} % TeX pt to 600ppi.
  \FPtrunc{\temp@n}{\temp@n}{0}
  \typeout{Maximum image width, @600ppi: \temp@n\space pixels.}
  \setlength\temp@l{.7\le@ding}
  \FPmul{\temp@n}{\strip@pt\temp@l}{8.3022} %%%%%
  \FPtrunc{\temp@n}{\temp@n}{0}
  \typeout{Max height of one-line image, @600ppi: \temp@n\space pixels.}
  \FPadd{\temp@n}{\strip@pt\temp@l}{\strip@pt\le@ding} %%%%%
  \FPmul{\temp@n}{\temp@n}{8.3022}
  \FPtrunc{\temp@n}{\temp@n}{0}
  \typeout{Max height of two-line image, @600ppi: \temp@n\space pixels.}
  \FPmul{\temp@d}{\strip@pt\le@ding}{8.3022}
  \FPtrunc{\temp@d}{\temp@d}{0}
  \typeout{\space\space Each extra line, add max \temp@d\space pixels.}
  \setlength\temp@l{\textheight+\chars@ht-.7\le@ding}
  \FPmul{\temp@n}{\strip@pt\temp@l}{8.3022}
  \FPtrunc{\temp@n}{\temp@n}{0}
  \typeout{Max height of full-page image, @600ppi: \temp@n\space pixels.}
}
%%


%%
\endinput
%%
%% End of file `novelette-image.sty'.
