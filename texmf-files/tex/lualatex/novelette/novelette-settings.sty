%% This is file `novelette-settings.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-settings.sty}%
[2023/10/08 v0.19 LaTeX file (Preamble settings).]
%%


%% These settings are defined in novelette.cls, for both interior and cover:
%% \booksize is always required. It is the interior page `trim size'.
%% \title and \author are required, except in draft mode (interior only).
%% \intent declares Output Intent. Default SWOP in final mode, otherwise none.


%% SETTINGS THAT ARE ONLY USED FOR BOOK INTERIOR PAGES
%% ----------------------------------------------------------------------------


%% Mode must be set to final, when your writing and editing is done.
\newcommand\mode[1]{
  \ifcover@rt\else
    \StrDel{#1}{ }[\temp@s]
    \@okfalse
    \IfSubStr{:draft:shade:final:dev:}{:\temp@s:}{ % Mode dev, developer only.
      \@oktrue\xdef\@mode{\temp@s}
    }{}
    \if@ok\else
      \@error{Bad \string\mode{choice}.^^J%
        Choose one: draft shade final.^^J%
        Sets book interior mode. Default draft. Ignored by cover.^^J%
        If any error (such as this one) is generated during compile,^^J%
        then final mode will be automatically switched to draft.}
    \fi
  \fi
}
%%


%% Sheetfeed. (Normally not used.)
% Most print services require that the PDF page size be same as book booksize.
% In a few cases (or for home printing of markup drafts) the book pages
% are floated to the middle of a standard office paper size, letter or A4.
\def\sheet@feed{booksize} % Default.
\DeclareDocumentCommand\sheetfeed{m}{
  \StrDel{#1}{ }[\temp@s]
  \IfSubStr{:booksize:letter:a4:A4:}{:\temp@s:}{
    \ifthenelse{\equal{\temp@s}{a4}}{\def\temp@n{A4}}{\def\temp@n{\temp@s}}
    \xdef\sheet@feed{\temp@n}\@oktrue
  }{\@okfalse}
  \StrDel{\temp@s}{\sheet@feed}[\temp@s]
  \reject@nonempty{\temp@s}
  \if@ok\else
    \@error{Bad \string\sheetfeed{choice}.^^J%
      Choose only one: booksize letter A4. Default booksize.^^J%
      If unsure, do not use this setting (accept default).^^J%
      This setting is ignored when processing cover art.}
    \gdef\sheetfeed{booksize}
  \fi
}
%%


%% Margins. (Excludes all printable material. Inside is at spine.)
\def\all@margins{t=13mm,o=13mm,b=13mm,i=16.2mm}
\setlength\m@top{13mm} \setlength\m@out{13mm} % Defaults. 16.2mm>.625in,
\setlength\m@bot{13mm} \setlength\m@ins{16.2mm} % 13mm>.5in, diff>.125in>3mm.
\DeclareDocumentCommand\margins{m}{
  \StrDel{#1,}{ }[\temp@s]
  \StrBehind{\temp@s}{t=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \check@length{\temp@n}
  \if@ok
    \global\deflength\m@top{\temp@n}
    \ifdimcomp{\m@top}{<}{.25in}{\margin@lerttrue}{}%
    \StrDel{\temp@s}{t=\temp@n,}[\temp@s]
    \StrBehind{\temp@s}{o=}[\temp@n]
    \StrBefore{\temp@n}{,}[\temp@n]
    \check@length{\temp@n}
    \if@ok
      \global\deflength\m@out{\temp@n}
      \ifdimcomp{\m@out}{<}{.25in}{\margin@lerttrue}{}%
      \StrDel{\temp@s}{o=\temp@n,}[\temp@s]
      \StrBehind{\temp@s}{b=}[\temp@n]
      \StrBefore{\temp@n}{,}[\temp@n]
      \check@length{\temp@n}
      \if@ok
        \global\deflength\m@bot{\temp@n}
        \ifdimcomp{\m@bot}{<}{.25in}{\margin@lerttrue}{}%
        \StrDel{\temp@s}{b=\temp@n,}[\temp@s]
        \StrBehind{\temp@s}{i=}[\temp@n]
        \StrBefore{\temp@n}{,}[\temp@n]
        \check@length{\temp@n}
        \if@ok
          \global\deflength\m@ins{\temp@n}
          \ifdimcomp{\m@ins}{<}{.375in}{\margin@lerttrue}{}%
          \StrDel{\temp@s}{i=\temp@n,}[\temp@s]
        \fi
      \fi
    \fi
  \fi
  \if@ok
    \setlength\temp@l{\m@out+3mm}
    \ifdimcomp{\m@ins}{<}{\temp@l}{\margin@lerttrue}{}%
    \gdef\all@margins{#1}
  \else
    \@error{Bad \string\margins{t=T,o=O,b=B,i=I}^^J%
      t->top, o->outside, b->bottom, i->inside (spine, with glue zone).^^J%
      T,O,B,I have units in|mm. You must set all four of them.^^J%
      Usually I is larger than O by at least 3mm or .125in.}
    \setlength\m@top{13mm} \setlength\m@out{13mm} % Restore defaults.
    \setlength\m@bot{13mm} \setlength\m@ins{16.2mm}
    \gdef\all@margins{t=13mm,o=13mm,b=13mm,i=16.2mm}
  \fi
  \StrDel{\temp@s}{,}[\temp@s]
  \xdef\margin@cruft{\temp@s}
  \ifmargin@lert
    \typeout{ALERT: Unusual margins. Interior bleed is not supported.^^J%
      Nearly all P.O.D. require >=0.25in margins at top, outside, bottom,^^J%
      and minimum 0.375in at inside. For best appearance, inside should^^J%
      exceed outside by at least 3mm or 0.125in. Your settings disagree.^^J%
      Note that many P.O.D. require larger values than these.}
    \g@addto@macro\misc@lert{%
      \typeout{ALERT: Unusual margin settings. Too small? No glue area?}%
    }
  \fi
  \ifthenelse{\equal{\margin@cruft}{}}{}{\g@addto@macro\misc@lert{%
    \typeout{ALERT: Ignored unknown `\margin@cruft' in \string\margins.}}%
  }
}
%%


%% Typesize. (Main font size.)
%% Default typesize is calculated, based on other factors.
\DeclareDocumentCommand\typesize{m}{
  \check@length{#1}
  \if@ok
    \global\deflength\type@size{#1}
  \else
    \@error{Bad \string\typesize{size}.^^J%
      Size has units, pt|bp. Typically 11.0pt-12.0bp.^^J
      Decimal values are permitted (and are often best).^^J
      If unset, Novelette will calculate and use a likely value.}
  \fi
}
%%


%% Lines. (Lines per page, main text block, not including header|footer.)
%% Default lines are calculated, based on other factors.
\DeclareDocumentCommand\lines{m}{ % Integer lines per page, main text only.
  \IfInteger{#1}{
    \xdef\lines@pp{#1}
  }{
    \@error{Bad \string\lines{integer}^^J%
      Lines per page, main text block only (not header|footer).^^J%
      Value must be integer, typically 27-35.^^J
      If unset, Novelette wil calculate and use a likely value.}
  }
}
%%


%% Layout. (scheme, header|footer gaps)
% Format: \layout{scheme=S,hgap=H,fgap=F,scale=N,font=T}
% The five values may be in any order. May omit any, for default.
% S -> Integer 1-7. Selects header/footer scheme from a menu. See docs.
% H -> Number 0-1. May be decimal. Extra line space from header to main text.
% F -> Number 0-1. May be decimal. Extra line space from main text to footer.
% N -> Number .75-1. Scale of page number and header text, relative to main.
% T -> One of main,sans,mono,alt,drama,deco. Default main.
\def\@scheme{2} \def\h@gap{.5} \def\f@gap{.5} \def\hf@scale{1} \def\hf@font{}
\DeclareDocumentCommand\layout{m}{
  \StrDel{#1,}{ }[\temp@s]
  \StrBehind{\temp@s}{hgap=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \@oktrue
  \IfDecimal{\temp@n}{
    \begingroup
    \@oktrue
    \@reject{\temp@n<0}
    \@reject{\temp@n>1}
    \if@ok\xdef\h@gap{\temp@n}\fi
    \endgroup
  }{
    \reject@nonempty{\temp@n}
  }
  \StrDel{\temp@s}{hgap=\h@gap,}[\temp@s]
  \StrBehind{\temp@s}{fgap=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \IfDecimal{\temp@n}{
    \begingroup
    \@oktrue
    \@reject{\temp@n<0}
    \@reject{\temp@n>1}
    \if@ok\xdef\f@gap{\temp@n}\fi
    \endgroup
  }{
    \reject@nonempty{\temp@n}
  }
  \StrDel{\temp@s}{fgap=\f@gap,}[\temp@s]
  \StrBehind{\temp@s}{scale=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \IfDecimal{\temp@n}{
    \begingroup
    \@oktrue
    \@reject{\temp@n<.75}
    \@reject{\temp@n>1}
    \if@ok\xdef\hf@scale{\temp@n}\fi
    \endgroup
  }{
    \reject@nonempty{\temp@n}
  }
  \StrDel{\temp@s}{scale=\hf@scale,}[\temp@s]
  \StrBehind{\temp@s}{scheme=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \IfInteger{\temp@n}{
    \begingroup
    \@oktrue
    \@reject{\temp@n<0}
    \@reject{\temp@n>7}
    \if@ok\xdef\@scheme{\temp@n}\fi
    \endgroup
  }{
    \reject@nonempty{\temp@n}
  }
  \StrDel{\temp@s}{scheme=\@scheme,}[\temp@s]
  \StrBehind{\temp@s}{font=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \IfSubStr{:main:sans:mono:alt:drama:deco:}{:\temp@n:}{
    \xdef\hf@font{\temp@n}
  }{
    \reject@nonempty{\temp@n}
  }
  \StrDel{\temp@s}{font=\hf@font,}[\temp@s]
  \if@ok\else
    \@error{Bad \string\layout{scheme=S,hgap=H,fgap=F,scale=N,font=T}.^^J%
      S=integer 1-7. Chooses header/footer scheme. See docs. Default 2.^^J%
      H=number, 0 to 1. May be decimal. Gap header to main. Default .5.^^J%
      F=number, 0 to 1. May be decimal. Gap main to footer. Default .5.^^J%
      N=number, .75 to 1. Scale of page numers and header text. Default 1.^^J%
      T=font, main|sans|mono|alt|drama|deco. Default main}
  \fi
  \StrDel{\temp@s}{,}[\temp@s]
  \xdef\layout@cruft{\temp@s}
  \ifthenelse{\equal{\layout@cruft}{}}{}{\g@addto@macro\misc@lert{%
    \typeout{ALERT: Ignored unknown `\layout@cruft' in \string\layout\space.}}%
  }
}
%%


%% Page number style. Only affects page numbers, not header text.
% Does not switch roman|arabic (that is from frontmatter|mainmatter).
% onum|lnum -> oldstyle or lining numerals. If unset, same as main text.
% ital -> Italics. If unset, Regular.
\def\pn@feat{} \let\pn@ital\relax
\DeclareDocumentCommand\pagenumberstyle{m}{
  \StrDel{#1}{ }[\temp@s]
  \StrDel{\temp@s}{,}[\temp@s]
  \IfSubStr{\temp@s}{onum}{
    \gdef\pn@feat{\addfontfeature{Numbers=ResetAll,Numbers=OldStyle}}
    \StrDel{\temp@s}{onum}[\temp@s]
  }{}
  \IfSubStr{\temp@s}{lnum}{
    \gdef\pn@feat{\addfontfeature{Numbers=ResetAll,Numbers=Lining}}
    \StrDel{\temp@s}{lnum}[\temp@s]
  }{}
  \IfSubStr{\temp@s}{italics}{
    \LetLtxMacro\pn@ital\textit\relax
    \StrDel{\temp@s}{italics}[\temp@s]
  }{}
  \IfSubStr{\temp@s}{italic}{
    \LetLtxMacro\pn@ital\textit\relax
    \StrDel{\temp@s}{italic}[\temp@s]
  }{}
  \IfSubStr{\temp@s}{ital}{
    \LetLtxMacro\pn@ital\textit\relax
    \StrDel{\temp@s}{ital}[\temp@s]
  }{}
  \xdef\pn@cruft{\temp@s}
  \ifthenelse{\equal{\temp@s}{}}{}{\g@addto@macro\misc@lert{%
    \typeout{ALERT: Ignored unknown '\pn@cruft' in \string\pagenumberstyle.}}%
  }
}
%%


%% Guides. (For vertical positioning reference, in shade mode.)
% Up to four guide pairs. This command is parsed in novelette-shading.sty.
% Format: \guides{A,B,C,D} where A,B,C,D are integer lines from top of main.
\DeclareDocumentCommand\guides{m}{\gdef\@guides{#1}}
\guides{} % Default none.
%%


%% Microtype options. (Passes \micro@set as package option to microtype.)
\def\micro@set{config=novelette-microtype,verbose=silent,%
  stretch=20,shrink=20,protrusion=false}
\def\set@microtype{stretch=20,shrink=20} \def\setmicro@tail{ (Defaults)}
\DeclareDocumentCommand\setmicrotype{m}{
  \StrDel{#1}{ }[\temp@s]
  \StrDel{\temp@s}{ifdraft}[\temp@s]
  \StrDel{\temp@s}{draft}[\temp@s]
  \StrDel{\temp@s}{final}[\temp@s]
  \xdef\set@microtype{\temp@s} \gdef\setmicro@tail{}
  \IfSubStr{\temp@s}{config}{}{
    \g@addto@macro\temp@s{,config=novelette-microtype}
  }
  \IfSubStr{\temp@s}{verbose}{}{
    \g@addto@macro\temp@s{,verbose=silent}
  }
  \IfSubStr{\temp@s}{protrusion}{}{
    \g@addto@macro\temp@s{,protrusion=false}
  }
  \xdef\micro@set{\temp@s}
}
%%


%% Add or remove an OpenType feature by its code (font feature settings):
\def\check@features#1{%
  \IfSubStr{\temp@s}{=}{
    \@okfalse
    \@error{Bad value for \string\#1features{}.^^J%
      Features are a comma-separated list of OpenType feature codes.^^J%
      Each code is 4 alphanumeric characters. Examples: lnum cv04.^^J%
      You may precede a code with - to indicate removal of that feature.^^J%
      Special code mupc matches uppercase, instead of default lowercase.^^J%
      Although package `fontspec' allows other settings, Novelette does not.}
  }{
    \@oktrue
    \IfSubStr{\temp@s}{mupc}{
      \StrDel{\temp@s}{mupc}[\temp@s]
      \def\temp@n{Scale=MatchUppercase}
    }{
      \def\temp@n{}
    }
  }
}
%%


%% Various fonts.
% Novelette ships with Swainson and Towhee fonts. Swainson is designed for
% main text, vaguely similar to Garamond (but not a clone). Towhee is designed
% for use in footnotes, as a scale-adjusted Swainson. These are the defaults,
% unless you choose something else using \mainfont.
%   Bold is never used in the main text or headings of popular fiction.
% So instead of shipping bold fonts that would be ignored, the default setup
% duplicates Regular/Italic to Bold/BoldItalic, for Swainson and Towhee.
%   Novelette does not allow \newfontfamily or \newfontface.
% Use \mainfont (=\setmainfont), likewise \sansfont and \monofont.
% You should not need sans or mono, but you may cheat: Any font may be set.
% If you do not set sans or mono, then (surprise!) the main font is used.
%   Settings \altfont, \dramafont, and \decofont are specific to Novelette.
% Each of these is a front-end to another fontspec command, which is not
% available until fontspec loads after Preamble.
%   Although is is possible to use any of these fonts anywhere, you should
% use only the mainfont in main text, possibly with occasional altfont
% when you need a character from another language set. If you use any of
% the other fonts within main text, it will be visually distracting, which is
% very undesirable in the reading-flow of popular fiction.
%   \mainfont{Font Family Name}[features]
%     Example: \mainfont{Adobe Garamond Pro}[Ligatures=Discretionary]
%     If you allow the default Swainson font, or set it manually, then
%     scaled Towhee will automatically be set for footnotes. Otherwise,
%     footnotes will use the scaled mainfont.
%   \sansfont{Font Family Name}[features]
%     Usage: \sans{This is in sansfont.}
%     Chosen font does not need to be sans-serif.
%   \monofont{Font Family Name}[features]
%     Usage: \mono{This is in monofont.}
%     Chosen font does not need to be monospace.
%   \altfont{Font Family Name}[features]
%     Usage: \alt{This is in altfont.}
%     The altfont is useful for occasional characters (such as Greek)
%     that are not in the main font. It is scaled to match main lowercase,
%     so that it mingles better with main text. Good choice: Libertinus Serif.
%     Note: This is identical to defining \fallbackfont, usage \textfallback{}.
%   \dramafont{Font Family Name}[features]
%     Example: \dramafont{Cinzel}
%     Usage: \drama{Dramatic Text}
%     The dramafont is useful for the book title, and other places where
%     you need a distinctive appearance.
%   \decofont{Single Font File Name}[features]
%     Example: \decofont{Roboto-Italic.otf}
%     Usage: \deco{character}
%     The decofont is useful for dingbats. This is a single font file.
%     Choose it by file name, not family name.
%%
\def\main@name{Swainson} \def\main@feat{} \def\sans@feat{}
\def\mono@feat{} \def\alt@feat{} \def\drama@feat{} \def\deco@feat{}
%%
\DeclareDocumentCommand\mainfont{m}{
  \@error{Novelette does not allow you to set the main font.^^J%
    The built-in Swainson and Towhee fonts are pre-set.}
}
\DeclareDocumentCommand\mainfeatures{m}{
  \StrDel{#1}{ }[\temp@s]
  \ifthenelse{\equal{\temp@s}{}}{}{
    \check@features{main}
    \if@ok
      \xdef\main@feat{RawFeature={\temp@s},\temp@n}
    \fi
  }
}
\let\mainfeature\mainfeatures\relax
%%
\DeclareDocumentCommand\sansfont{m}{ % Default Swainson. Not actually sans.
  \gdef\sans@name{#1}
}
\DeclareDocumentCommand\sansfeatures{m}{
  \StrDel{#1}{ }[\temp@s]
  \ifthenelse{\equal{\temp@s}{}}{}{
    \check@features{sans}
    \if@ok
      \xdef\sans@feat{RawFeature={\temp@s},\temp@n}
    \fi
  }
}
\let\sansfeature\sansfeatures\relax
%%
\DeclareDocumentCommand\monofont{m}{ % Default Swainson. Not actually mono.
  \gdef\mono@name{#1}
}
\DeclareDocumentCommand\monofeatures{m}{
  \StrDel{#1}{ }[\temp@s]
  \ifthenelse{\equal{\temp@s}{}}{}{
    \check@features{mono}
    \if@ok
      \xdef\mono@feat{RawFeature={\temp@s},\temp@n}
    \fi
  }
}
\let\monofeature\monofeatures\relax
%%
\DeclareDocumentCommand\altfont{m}{ % Default Swainson.
  \gdef\alt@name{#1}
}
\DeclareDocumentCommand\altfeatures{m}{
  \StrDel{#1}{ }[\temp@s]
  \ifthenelse{\equal{\temp@s}{}}{}{
    \check@features{alt}
    \if@ok
      \xdef\alt@feat{RawFeature={\temp@s},\temp@n}
    \fi
  }
}
\let\altfeature\altfeatures\relax
%%
\DeclareDocumentCommand\dramafont{m}{ % Default Swainson.
  \gdef\drama@name{#1}
}
\DeclareDocumentCommand\dramafeatures{m}{
  \StrDel{#1}{ }[\temp@s]
  \ifthenelse{\equal{\temp@s}{}}{}{
    \check@features{drama}
    \if@ok
      \xdef\drama@feat{RawFeature={\temp@s},\temp@n}
    \fi
  }
}
\let\dramafeature\dramafeatures\relax
%%
\DeclareDocumentCommand\decofont{m}{ % Default Swainson.
  \gdef\deco@name{#1}
}
\DeclareDocumentCommand\decofeatures{m}{
  \StrDel{#1}{ }[\temp@s]
  \ifthenelse{\equal{\temp@s}{}}{}{
    \check@features{deco}
    \if@ok
      \xdef\deco@feat{RawFeature={\temp@s},\temp@n}
    \fi
  }
}
\let\decofeature\decofeatures\relax
%%


%% NAME STYLE
\def\nn@align{c} \def\nn@scale{1.6} \def\nn@font{main}
\def\name@style{align=\nn@align,scale=\nn@scale,font=\nn@font}
\DeclareDocumentCommand\namestyle{m}{ % align=A, scale=S, font=F.
  \StrDel{#1,}{ }[\temp@s]
  \@oktrue
  \StrBehind{\temp@s}{align=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \ifthenelse{\equal{\temp@n}{}}{}{
    \IfSubStr{:l:c:r:o:i:}{:\temp@n:}{
      \xdef\nn@align{\temp@n}
    }{\@okfalse}
  }
  \StrBehind{\temp@s}{font=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \ifthenelse{\equal{\temp@n}{}}{}{
    \IfSubStr{:main:sans:mono:alt:drama:deco:}{:\temp@n:}{
      \xdef\nn@font{\temp@n}
    }{\@okfalse}
  }
  \StrBehind{\temp@s}{scale=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \ifthenelse{\equal{\temp@n}{}}{}{
    \IfDecimal{\temp@n}{
      \ifthenelse{\fpeval{\temp@n<.75}=1}{\@okfalse}{\xdef\nn@scale{\temp@n}}
    }{\@okfalse}
  }
  \if@ok\else
    \@error{Bad value in \string\namestyle{align=A,font=F,scale=S}.^^J%
       A may be one of c l r o i. Horizontal alignment. Default c.^^J%
       F is one of main,sans,mono,alt,drama,deco. Font. Default main.^^J%
       S is a number >=.75. Scale. Default 1.25.}
  \fi
}
%%


%% SUBNAME STYLE
\def\sn@align{c} \def\sn@scale{1.25} \def\sn@font{main}
\def\subname@style{align=\sn@align,scale=\sn@scale,font=\sn@font}
\DeclareDocumentCommand\subnamestyle{m}{ % align=A, scale=S, font=F.
  \StrDel{#1,}{ }[\temp@s]
  \@oktrue
  \StrBehind{\temp@s}{align=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \ifthenelse{\equal{\temp@n}{}}{}{
    \IfSubStr{:l:c:r:o:i:}{:\temp@n:}{
      \xdef\sn@align{\temp@n}
    }{\@okfalse}
  }
  \StrBehind{\temp@s}{font=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \ifthenelse{\equal{\temp@n}{}}{}{
    \IfSubStr{:main:sans:mono:alt:drama:deco:}{:\temp@n:}{
      \xdef\sn@font{\temp@n}
    }{\@okfalse}
  }
  \StrBehind{\temp@s}{scale=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \ifthenelse{\equal{\temp@n}{}}{}{
    \IfDecimal{\temp@n}{
      \ifthenelse{\fpeval{\temp@n<.75}=1}{\@okfalse}{\xdef\sn@scale{\temp@n}}
    }{\@okfalse}
  }
  \if@ok\else
    \@error{Bad value in \string\subnamestyle{align=A,font=F,scale=S}.^^J%
       A may be one of c l r o i. Horizontal alignment. Default c.^^J%
       F is one of main,sans,mono,alt,drama,deco. Font. Default main.^^J%
       S is a number >=.75. Scale. Default 1.25.}
  \fi
}
%%


%% Language.
\def\lang@option{} \def\lang@tail{}
\def\set@lang{english} \def\lang@hyph{english}
\def\log@lang{\string\setlang\space unset. Using default old-pattern english.}
\DeclareDocumentCommand\setlang{O{}mO{}}{
  \StrDel{#2}{ }[\temp@s]
  \IfSubStr{:english:french:german:spanish:italian:catalan:}{:\temp@s:}{
    \@oktrue\xdef\set@lang{\temp@s}\xdef\lang@hyph{\temp@s}
  }{\@okfalse}
  \StrDel{#1#3}{ }[\temp@s]
  \ifthenelse{\equal{\set@lang}{english}}{
    \IfSubStr{:us:uk::}{:\temp@s:}{
      \xdef\lang@option{\temp@s}
      \ifthenelse{\equal{\temp@s}{us}}{\gdef\lang@hyph{usenglishmax}}{}
      \ifthenelse{\equal{\temp@s}{uk}}{\gdef\lang@hyph{ukenglish}}{}
    }{
      \@okfalse\xdef\lang@tail{(Unknown option [\temp@s] ignored.)}
    }
  }{}
  \ifthenelse{\equal{\set@lang}{french}}{
    \IfSubStr{:fr:ch::}{:\temp@s:}{
      \xdef\lang@option{\temp@s}
    }{
      \@okfalse\xdef\lang@tail{(Unknown option [\temp@s] ignored.)}
    }
  }{}
  \ifthenelse{\equal{\set@lang}{german}}{
    \IfSubStr{:1901:1901x:1996:1996x:ch::}{:\temp@s:}{
      \xdef\lang@option{\temp@s}
      \ifthenelse{\equal{\temp@s}{1901}}{\gdef\lang@hyph{german}}{}
      \ifthenelse{\equal{\temp@s}{1996}}{\gdef\lang@hyph{ngerman}}{}
      \ifthenelse{\equal{\temp@s}{1901x}}{\gdef\lang@hyph{dehyph-x-german}}{}
      \ifthenelse{\equal{\temp@s}{1996x}}{\gdef\lang@hyph{dehyph-x-ngerman}}{}
      \ifthenelse{\equal{\temp@s}{ch}}{\gdef\lang@hyph{swissgerman}}{}
    }{
      \@okfalse\xdef\lang@tail{(Unknown option [\temp@s] ignored.)}
    }
  }{}
  \IfSubStr{:italian:spanish:catalan:}{:\set@lang:}{
    \ifthenelse{\equal{\temp@s}{}}{}{
      \@okfalse\xdef\lang@tail{(Unknown option [\temp@s] ignored.)}
    }
  }{}
  \if@ok
    \ifthenelse{\equal{\lang@option}{}}{
      \xdef\log@lang{\string\setlang{\set@lang}} \lang@tail
    }{
      \xdef\log@lang{\string\setlang[\lang@option]{\set@lang}} \lang@tail
    }
  \else
    \@error{Bad setting in \string\setlang[option]{language}.^^J%
      Choose language: english french german italian spanish catalan.^^J%
      Options for english: us uk. (Default empty, uses old patterns.)^^J%
      Options for french: fr ch off. (Punctuation spacing. Default fr.)^^J%
      Options for german: 1901 1901x 1996 1996x ch. (sz/ss. Default 1901.)^^J%
      No options for italian, spanish, catalan.}
  \fi
}
%%


%% Optionally over-ride default 1.5em parindent:
\newcommand\myparindent[1]{\gdef\myown@parindent{#1}}
%%


%% Custom \intent:
\def\custom@cats{ % Because escape characters are different in TeX and XMP.
  \catcode`\#=12
  \catcode`\_=12
  \catcode`\~=12
  \catcode`\$=12
  \catcode`\%=12
  \catcode`\&=12
  \edef\@pctchar{\expandafter\@gobble\string\%}
  \let\%\@pctchar
  \edef\@hashchar{\expandafter\@gobble\string\#}
  \let\#\@hashchar
  \edef\@ampchar{\expandafter\@gobble\string\&amp;}
  \let\&\@ampchar
  \edef\@dollarchar{\expandafter\@gobble\string\$}
  \let\$\@dollarchar
  \edef\@underchar{\expandafter\@gobble\string\_}
  \let\_\@underchar
  \edef\@tildechar{\expandafter\@gobble\string\~}
  \let\~\@tildechar
}
\def\customOIidentifier#1{
  \begingroup\custom@cats\xdef\OIidentifier{#1}\endgroup
}
\def\customOIcondition#1{
  \begingroup\custom@cats\xdef\OIcondition{#1}\endgroup
}
\def\customOIinfo#1{
  \begingroup\custom@cats\xdef\OIinfo{#1}\endgroup
}
\def\customOIregistry#1{
  \begingroup\custom@cats\xdef\OIregistry{#1}\endgroup
}
%%



%% SETTINGS THAT ARE ONLY USED FOR COVER:
%% ----------------------------------------------------------------------------
%% Page size of PDF will be automatically set by measuring cover image size.


%% Image must be raster jpg, pre-processed by cmyk4nvt script.
\DeclareDocumentCommand\coverimage{m}{
  \@oktrue
  \IfBeginWith{#1}{/}{\@okfalse}{}
  \IfSubStr{#1}{://}{\@okfalse}{}
  \IfBeginWith{#1}{..}{\@okfalse}{}
  \if@ok\else
    \fatal@error{Bad location for coverimage file.^^J%
      It may be same directory as main document,^^J%
      or in a subdirectory path, relative to main document.^^J%
      But you may not use an absolute path (beginning with / or ://)^^J%
      and you cannot use ../ to move up directory.}
  \fi
  \IfEndWith{#1}{.jpg}{}{
    \fatal@error{Cover image does not have `.jpg' file extension.}
  }
  \gdef\cover@image{#1}
}
%%


%% Cover Trim is finished cover size, after bleed has been removed.
\DeclareDocumentCommand\covertrim{m}{
  \StrSubstitute{#1,}{ }{}[\temp@s]
  \StrBehind{\temp@s}{w=}[\temp@n]
  \StrBefore{\temp@n}{,}[\temp@n]
  \check@length{\temp@n}
  \if@ok
    \StrBehind{\temp@s}{h=}[\temp@d]
    \StrBefore{\temp@d}{,}[\temp@d]
    \check@length{\temp@d}
  \fi
  \if@ok
    \gdef\cover@trim{#1}
    \global\deflength\covertrim@w{\temp@n}
    \global\deflength\covertrim@h{\temp@d}
  \else
    \fatal@error{Bad \string\covertrim{w=W,h=H}.^^J%
      W is width of trimmed cover, units in|mm|cm.^^J%
      H is height of trimmed cover, units in|mm|cm.^^J%
      The covertrim is the finished cover size,^^J%
      after surrounding bleed has been trimmed off.^^J%
      The finished size includes rear cover, spine, front cover.^^J%
      The full size of the input cover image is larger,^^J%
      because it must include surrounding bleed areas.}
 \fi
}
%%


%% IGNORE SETTINGS THAT DO NOT PERTAIN:
%% ----------------------------------------------------------------------------


%%
\ifcover@rt % Ignore interior-specific settings.
  \def\@mode{draft} % Default.
  \def\mod@xmplabel{DRAFT } % Default.
  \def\sheetfeed#1{}
  \def\margins#1{}
  \def\typesize#1{}
  \def\lines#1{}
  \def\layout#1{}
  \def\guides#1{}
  \def\setmicrotype#1{}
  \def\namestyle#1{}
  \def\subnamestyle#1{}
  \def\myparindent#1{}
  \DeclareDocumentCommand\mainfont{O{}mO{}}{}
  \DeclareDocumentCommand\sansfont{O{}mO{}}{}
  \DeclareDocumentCommand\monofont{O{}mO{}}{}
  \DeclareDocumentCommand\altfont{O{}mO{}}{}
  \DeclareDocumentCommand\dramafont{O{}mO{}}{}
  \DeclareDocumentCommand\decofont{O{}mO{}}{}
  \DeclareDocumentCommand\setlang{m}{}
\else % Ignore cover-specific settings.
  \def\@mode{final} % Default.
  \def\mod@xmplabel{COVER } % Default.
  \def\covertrim#1{}
  \def\coverimage#1{}
\fi
%%


%% Issue warning if one or more ALERTs:
\newcommand\warnalert[1]{
  \@okfalse
  \ifthenelse{\equal{#1}{on}}{\@oktrue\warn@lerttrue}{}
  \ifthenelse{\equal{#1}{off}}{\@oktrue}{}
  \if@ok\else
    \ClassWarningNoLine{novelette}{Bad \string\warnalert{choice}.^^J%
      Choose: on off. Default off.}
  \fi
}
%%


%% ONLY PREAMBLE:
%% ----------------------------------------------------------------------------


%%
\let\margin\margins\relax % In case mis-spelled.
\LetLtxMacro\setmainfont\mainfont\relax
\LetLtxMacro\setsansfont\sansfont\relax
\LetLtxMacro\setmonofont\monofont\relax
\@onlypreamble\booksize
\@onlypreamble\margins
\@onlypreamble\margin
\@onlypreamble\sheetfeed
\@onlypreamble\typesize
\@onlypreamble\lines
\@onlypreamble\layout
\@onlypreamble\mainfont
\@onlypreamble\mainfeatures \@onlypreamble\mainfeature
\@onlypreamble\sansfont
\@onlypreamble\sansfeatures \@onlypreamble\sansfeature
\@onlypreamble\monofont
\@onlypreamble\monofeatures \@onlypreamble\monofeature
\@onlypreamble\altfont
\@onlypreamble\altfeatures \@onlypreamble\altfeature
\@onlypreamble\dramafont
\@onlypreamble\dramafeatures \@onlypreamble\dramafeature
\@onlypreamble\decofont
\@onlypreamble\decofeatures \@onlypreamble\decofeature
\@onlypreamble\setlang
\@onlypreamble\namestyle
\@onlypreamble\subnamestyle
\@onlypreamble\guides
\@onlypreamble\setmicrotype
\@onlypreamble\myparindent
\@onlypreamble\coverimage
\@onlypreamble\covertrim
\@onlypreamble\warn@lert
%%



%%
\endinput
%%
%% End of file `novelette-settings.sty'.
