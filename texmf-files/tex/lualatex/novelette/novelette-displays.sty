%% This is file `novelette-displays.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-displays.sty}%
[2023/12/15 v0.25 LaTeX file (upper and full displays).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).


%%% DISPLAYS
%   Novelette offers three kinds of display environments: fullpage, upperpage,
% and copyrightpage. Each of them begins on a new page.
%   If page layout uses a header, it will be empty above the display.
% If page layout uses a footer, it will print beneath an upperpage in
% mainmatter, but not otherwise. This behavior can be locally changed using
% \thispagestyle{setting} command.
%   The fullpage environment is intended for such things as book title page,
% and some other frontmatter content. It may also be useful if your book
% has separated parts. When fullpage ends, the following material begins on
% a new page.
%   The upperpage environment is intended for the start of new chapters,
% and perhaps other material that has page layout similar to a new chapter.
% When upperpage ends, following material (usually main text) may continue on
% the same page. The height of upperpage is not a setting, so it may vary.
% Use shade mode and guides to help you with vertical placement.
% You may nest upperpage within fullpage (but not within copyrightpage).
%   The copyrightpage environment is specifically intended for that purpose.
% Its usage is optional, but recommended. Within copyrightpage, there
% are several automatic adjustments: numerals are lining (not oldstyle),
% no hyphenation, single and double quotes are straight (not curly),
% no paragraph indentation, blank line inserted between paragraphs. This is
% standard usage for such legalese. If you choose not to use copyrightpage,
% then put the copyright material within fullpage.
%   You may not use \footnote on fullpage or copyrightpage. If you use it
% within upperpage, no marker is placed. This is standard style.
%   The fullpage, upperpage, and copyrightpage environments allow small text:
%   \smalltext{text} prints its text at footnote size. This may be useful for
% writing a synopsis beneath chapter titles, or on copyrightpage when you
% have a lot to say there. In most cases, \smalltext should sit within
% the center and/or blockindent environments.
%   The fullpage and upperpage environments (but not copyrightpage) allow
% several additional styling commands:
%   \name{text} and \subname{text} have fixed styles, set in Preamble by
% the \namestyle{setting} and \subnamestyle{setting} commands. They are useful
% for things such as chapter title and subtitle.
%   \style[option]{text} can vary each time it is used, according to option.
% This is useful for unique fullpage displays.
%%%


%%
\newif\ifupper@page % True within upperpage environment.
\newif\iffull@page % True within fullpage environment
%%

%% Environment: upperpage. Used for such things as start of new chapter.
\newif\ifupper@footnote % True if \footnote used in upperpage.
\def\held@footnote{}
\DeclareDocumentCommand\hold@that@footnote{O{}+m}{% Option ignored.
  \upper@footnotetrue%
  \long\gdef\held@footnote{#2}%
}
\newenvironment{upperpage}{%
  \iffull@page\else\clearpage\fi%
  \ifhe@der%
    \iff@@ter%
      \iffront@matter\thispagestyle{empty}\else\thispagestyle{plain}\fi%
    \else%
      \thispagestyle{empty}%
    \fi%
  \fi%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \begingroup%
  \zm@rktrue%
  \upper@pagetrue\upper@footnotefalse%
  \setlength\parindent{0pt}%
  \LetLtxMacro\footnote\hold@that@footnote\relax%
}{% Close the environment:
  \setcounter{fnm@num}{1}% Footnote markers. 1=asterisk.
  \ifvmode\else\par\fi%
  \null% Needed for firm vertical position.
  % \pagegoal=(\lines@pp+.3)*\@leading), so \lines@pp=(\pagegoal/\@leading)-.3
  % That is an integer. To restore the line grid after variable-height content,
  % must add enough \vspace so that (\pagetotal/\@leading)-.3 is an integer.
  \edef\temp@n{\fpeval{(\pagetotal/\@leading)-.3}}%
  \edef\temp@d{\fpeval{ceil(\temp@n,0)}}%
  \setlength\temp@l{\temp@d\@leading}%
  \addtolength\temp@l{-\temp@n\@leading}%
  \addtolength\temp@l{-2.3\@leading}% Remove excess created by two \null.
  \vspace{\temp@l}%
  \LetLtxMacro\footnote\f@@tn@te\relax%
  \null\ifupper@footnote\footnote{\held@footnote}\fi\par%
  \endgroup%
}
\AfterEndEnvironment{upperpage}{\NoIndentAfterThis}
%%

%% Environment: fullpage
\newenvironment{fullpage}{%
  \clearpage%
  \thispagestyle{empty}%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \null\vspace*{-\@leading}% Helps \vfil, if used.
  \begingroup%
  \full@pagetrue%
  \zm@rktrue%
  \setlength\parindent{0pt}%
}{% End the environment:
  \endgroup% No need to restore line grid.
}
\AfterEndEnvironment{fullpage}{\clearpage}
%%

%%
% Command: \name{text} for such things as chapter titles.
% Global style set by \namestyle in Preamble. The {text} must be only one line,
% but you may repeat the command for multiple lines.
\newcounter{name@num} \setcounter{name@num}{1}
\newcommand\name[1]{%
  \@okfalse%
  \iffull@page\@oktrue\fi%
  \ifupper@page\@oktrue\fi%
  \if@ok%
    \ifvmode\else\strut\par\fi%
    \begingroup%
    \hyphenpenalty=20000%
    \setlength\parindent{0pt}%
    \def\baselinestretch{\nn@scale}%
    \nn@b\edef\temp@d{\fpeval{\nn@scale*\@leading}}%
    \rule{0pt}{\temp@d pt}%
    \addfontfeature{ScaleAgain=\nn@scale,%
      FakeStretch=\nn@stretch, Numbers=ResetAll, LetterSpace=2}#1%
    \edef\temp@d{\fpeval{.3*\nn@scale*\@leading}}%
    \ifvmode\else\rule{0pt}{\temp@d pt}\par\fi\nn@e%
    \endgroup%
  \else%
    \std@error{P}%
    \ifvmode\else\strut\par\fi#1\ifvmode\else\strut\par\fi%
  \fi%
}
%%%


%%% SUBNAME
\newcommand\subname[1]{%
  \@okfalse%
  \iffull@page\@oktrue\fi%
  \ifupper@page\@oktrue\fi%
  \if@ok%
    \ifvmode\else\strut\par\fi%
    \begingroup%
    \hyphenpenalty=20000%
    \setlength\parindent{0pt}%
    \def\baselinestretch{\sn@scale}%
    \sn@b\edef\temp@d{\fpeval{\sn@scale*\@leading}}%
    \rule{0pt}{\temp@d pt}%
    \addfontfeature{ScaleAgain=\sn@scale,%
      FakeStretch=\sn@stretch, Numbers=ResetAll, LetterSpace=2}#1%
    \edef\temp@d{\fpeval{.3*\sn@scale*\@leading}}%
    \rule{0pt}{\temp@d pt}\sn@e%
    \endgroup%
  \else%
    \std@error{P}%
    \ifvmode\else\strut\par\fi#1\ifvmode\else\strut\par\fi%
  \fi%
}
%%


%% STYLE
\let\ss@b\center \let\ss@e\endcenter \def\ss@scale{1}
\newcommand\style[2][]{%
  \iffull@page%
    \ifvmode\else\strut\par\fi%
    \begingroup%
    \StrDel{#1,}{ }[\temp@s]%
    \StrSubstitute{\temp@s}{Scale}{scale}[\temp@s]%
    \StrBehind{\temp@s}{scale=}[\temp@n]%
    \StrBefore{\temp@n}{,}[\temp@n]%
    \case@matchtrue%
    \IfDecimal{\temp@n}{%
      \comp@re{\temp@n<.75}{\case@matchfalse}{}%
      \comp@re{\temp@n>6}{\case@matchfalse}{}%
    }{%
      \case@matchfalse%
      \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
    }%
    \ifcase@match\edef\ss@scale{\temp@n}\fi%
    \StrBehind{\temp@s}{align=}[\temp@n]%
    \StrBefore{\temp@n}{,}[\temp@n]%
    \case@test{\temp@n}%
    \c@se{}{\let\ss@b\center\let\ss@e\endcenter}%
    \c@se{c}{\let\ss@b\center\let\ss@e\endcenter}%
    \c@se{l}{\let\ss@b\raggedright}%
    \c@se{r}{\let\ss@b\raggedleft}%
    \c@se{o}{%
      \ifodd\c@page\let\ss@b\raggedleft\else\let\ss@b\raggedright\fi%
    }%
    \c@se{i}{%
      \ifodd\c@page\let\ss@b\raggedright\else\let\ss@b\raggedleft\fi%
    }%
    \ifcase@match\else\@okfalse\fi%
    \if@ok%
      \hyphenpenalty=20000%
      \setlength\parindent{0pt}%
      \def\baselinestretch{\ss@scale}%
      \edef\ss@stretch{\fpeval{1.1 - .1*\ss@scale}}%
      \ss@b\strut%
      \addfontfeature{ScaleAgain=\ss@scale,FakeStretch=\ss@stretch,
        Numbers=ResetAll,LetterSpace=2}#2%
      \strut\ss@e%
    \else%
      \std@error{I}%
      \ifvmode\else\strut\par\fi#2\ifvmode\else\strut\par\fi%
    \fi%
    \endgroup%
  \else%
    \std@error{L}%
    \ifvmode\else\strut\par\fi#2\ifvmode\else\strut\par\fi%
  \fi%
  \vspace{-.001pt plus .002pt minus 0pt}%
}
%%%


%%
\long\def\smalltext#1{%
  \ifupper@page\@oktrue\else\@okfalse\fi%
  \iffull@page\@oktrue\fi%
  \ifcopyright@page\@oktrue\fi%
  \if@ok%
    \ifvmode\else\par\fi%
    \noindent\strut\begingroup%
    \footnote@font\alt@footnote@size#1%
    \ifvmode\else\par\fi%
    \endgroup%
  \else%
    \std@error{c}%
  \fi%
}
%%


%% Environment: copyrightpage.
\newif\ifcopyright@page
\newenvironment{copyrightpage}[1][2]{% Option center, or equal blockindents.
  \clearpage%
  \thispagestyle{empty}%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \begingroup%
  \copyright@pagetrue%
  \null%
  \zm@rktrue%
  \setlength\parindent{0pt}%
  \setlength\parskip{\@leading}%
  \hyphenpenalty=10000%
  \exhyphenpenalty=10000%
  \catcode`\"=12%
  \addfontfeature{Ligatures=ResetAll,Numbers=ResetAll,RawFeature={-tlig}}%
  \vfill%
  \StrDel{#1,}{ }[\temp@s]%
  \StrSubstitute{\temp@s}{sides}{side}[\temp@n]%
  \StrBehind{\temp@n}{side=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfDecimal{\temp@n}{%
    \def\using@side{t}%
    \begin{blockindent}[\temp@n,\temp@n]%
  }{%
    \IfNada{\temp@n}{}{\std@error{h}}
  }%
  \IfSubStr{#1}{center}{\def\using@center{t}\begin{center}}{\raggedright}%
}{% End the environment:
  \ifdefined\using@center\end{center}\fi%
  \ifdefined\using@side\end{blockindent}\fi%
  \endgroup%
}
\AfterEndEnvironment{copyrightpage}{\clearpage}
%%



%%
\endinput
%%
%% End of file `novelette-displays.sty'.
