%% This is file `novelette-layout.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-layout.sty}%
[2023/09/02 v0.5 LaTeX file (page layout calculations).]
%%


%%
\newlength\printable@ht % Printable height (header+main+footer).
\newlength\le@ding % Standard baseline skip. Calculated, not a setting.
\newlength\normalindent % Standard paragraph indent.
\newif\ifhe@der % True when layout has header.
\newif\iff@@ter % True when layout has footer.
%%


%%
\def\process@layout{
  \get@pagedims
  \get@typesize
  \get@lines
  \get@leading
  \get@placement
  \get@normalsize
}
%%


%%
\def\get@pagedims{
  \ifthenelse{\equal{\sheet@feed}{booksize}}{
    \setlength\pagewidth{\book@w}
    \setlength\pageheight{\book@h}
  }{}
  \ifthenelse{\equal{\sheet@feed}{letter}}{
    \setlength\pagewidth{8.5in}
    \setlength\pageheight{11in}
  }{}
  \ifthenelse{\equal{\sheet@feed}{a4}\OR\equal{\sheet@feed}{A4}}{
    \setlength\pagewidth{210mm}
    \setlength\pageheight{297mm}
  }{}
  \@oktrue
  \ifdimcomp{\book@w}{>}{\pagewidth}{\@okfalse}{}
  \ifdimcomp{\book@h}{>}{\pageheight}{\@okfalse}{}
  \if@ok\else
    \@error{\string\sheetfeed{choice}\space too small for booksize.^^J%
      Re-set to booksize.}%
    \setlength\pagewidth{\book@w}
    \setlength\pageheight{\book@h}
  \fi
  \setlength\textwidth{\book@w-\m@out-\m@ins}
  \setlength\oddsidemargin{\m@ins+0.5\pagewidth-0.5\book@w-1in}
  \setlength\evensidemargin{\m@out+0.5\pagewidth-0.5\book@w-1in}
}
%%


%%
\def\get@typesize{
  \FPifgt{\strip@pt\type@size}{0}\else
     \FPdiv{\temp@n}{\strip@pt\textwidth}{27}
     \FPmax{\temp@n}{\temp@n}{11.05}
     \FPmin{\temp@n}{\temp@n}{12.04}
     \FPtrunc{\temp@n}{\temp@n}{2}
     \setlength\type@size{\temp@n pt}
  \fi
}
%%


%%
\def\get@lines{
  \setlength\printable@ht{\book@h-\m@top-\m@bot}
  \FPiflt{\l@yout}{4}\global\f@@tertrue\fi
  \FPifgt{\l@yout}{1}\global\he@dertrue\fi
  \FPifeq{\l@yout}{0}\global\f@@terfalse\fi
  \ifdefined\lines@pp\else
    \FPmul{\temp@d}{\strip@pt\type@size}{1.3} % Generous, for nearly all fonts.
    \FPdiv{\temp@n}{\strip@pt\printable@ht}{\temp@d}
    \ifhe@der
      \FPsub{\temp@n}{\temp@n}{1.1}
      \FPsub{\temp@n}{\temp@n}{\h@gap}
    \fi
    \iff@@ter
      \FPsub{\temp@n}{\temp@n}{.9}
      \FPsub{\temp@n}{\temp@n}{\f@gap}
    \fi
    \FPtrunc{\temp@n}{\temp@n}{0}
    \xdef\lines@pp{\temp@n}
  \fi
}
%%


%%
\def\get@leading{
  \FPsub{\temp@d}{\lines@pp}{1}
  \ifhe@der
    \FPadd{\temp@d}{\temp@d}{1.1}
    \FPadd{\temp@d}{\temp@d}{\h@gap}
  \fi
  \iff@@ter
    \FPadd{\temp@d}{\temp@d}{.9}
    \FPadd{\temp@d}{\temp@d}{\f@gap}
  \fi
  % Well-behaved font: max riser (ÀÅ) + |descender| (JQgjpqy) < 1.2\type@size.
  \setlength\temp@l{\printable@ht-1.2\type@size} % Assumes well-behaved.
  \FPdiv{\temp@n}{\strip@pt\temp@l}{\temp@d}
  \FPtrunc{\temp@n}{\temp@n}{2}
  \setlength\le@ding{\temp@n pt}
  \FPdiv{\temp@n}{\strip@pt\le@ding}{\strip@pt\type@size}
  \FPifgt{\temp@n}{1.2}\else
    \@error{Too many lines per page.^^J%
      Lower \string\lines, or \string\typesize, or change \string\layout.}
  \fi
  \setlength\baselineskip{\le@ding}
}
%%


%%
\def\get@placement{
  \setlength\textheight{\lines@pp\le@ding}
  \setlength\topskip{\le@ding}
  \ifhe@der
    \setlength\headheight{\le@ding}
    \setlength\headsep{\h@gap\le@ding}
  \else
    \setlength\headheight{0pt}
    \setlength\headsep{0pt}
  \fi
  \iff@@ter
    \setlength\footskip{\le@ding+\f@gap\le@ding}
  \else
    \setlength\footskip{0pt}
  \fi
  \setlength\footnotesep{\le@ding}
  \skip\footins \le@ding
}
%%


%%
\def\get@normalsize{
  \renewcommand\normalsize{\@setfontsize\normalsize{\type@size}{\le@ding}}
  \normalsize
  \let\@normalsize\normalsize\relax % Hack for fancyhdr.
  \setlength\normalindent{1.5\type@size}
  \let\tiny\normalsize\relax
  \let\scriptsize\normalsize\relax
  \let\footnotesize\normalsize\relax % Actual footnotes use the next:
  \long\gdef\alt@footnote@size{%
     \@setfontsize\alt@footnote@size{.88\type@size}{1.1\type@size}%
  }
  \let\small\normalsize\relax
  \let\large\normalsize\relax
  \let\Large\normalsize\relax
  \let\LARGE\normalsize\relax
  \let\huge\normalsize\relax
  \let\Huge\normalsize\relax
  \let\HUGE\normalsize\relax
}
%%



%%
\endinput
%%
%% End of file `novelette-layout.sty'.
