%% This is file `novelette-interior.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%% License URL: https://www.latex-project.org/lppl/lppl-1-3c.txt
%% A copy of this license is distributed with LaTeX 2008+.
%%
\ProvidesFile{novelette-interior.sty}%
[2023/12/13 v0.24c LaTeX file (Process book interior).]
%%


%% This file is not loaded when processing cover.


%% The use of subfiles is strongly recommended.
\RequirePackage{subfiles}
\LetLtxMacro\sub@@@file\subfile\relax
\gdef\subfile#1{\clearpage\sub@@@file{#1}\clearpage}
%%


%% PROCESS INTERIOR
\def\process@interior{
  \get@pagedims
  \get@typesize
  \get@lines
  \get@leading
  \get@placement
  \get@normalsize
}
%%


%%
% \pagewidth, \pageheight, and \textwidth are LaTeX internals.
% Also \oddsidemargin and \evensidemargin (refers to left side of page).
\def\get@pagedims{
  \case@test{\sheet@feed}
  \c@se{trimsize}{\setlength\pagewidth{\trim@w}\setlength\pageheight{\trim@h}}
  \c@se{letter}{\setlength\pagewidth{8.5in}\setlength\pageheight{11in}}
  \c@se{a4}{\setlength\pagewidth{210mm}\setlength\pageheight{297mm}}
  \c@se{A4}{\setlength\pagewidth{210mm}\setlength\pageheight{297mm}}
  \@oktrue
  \ifdimcomp{\trim@w}{>}{\pagewidth}{\@okfalse}{}
  \ifdimcomp{\trim@h}{>}{\pageheight}{\@okfalse}{}
  \if@ok\else
    \std@error{M}
    \setlength\pagewidth{\trim@w}
    \setlength\pageheight{\trim@h}
  \fi
  \setlength\textwidth{\trim@w-\m@out-\m@ins}
  \setlength\oddsidemargin{\m@ins+0.5\pagewidth-0.5\trim@w-1in}
  \setlength\evensidemargin{\m@out+0.5\pagewidth-0.5\trim@w-1in}
}
%%


%%
\newlength\type@size % Size of main font.
\def\get@typesize{
  \def\typesize@tail{}
  \comp@re{\type@size>0}{}{
     \edef\temp@n{\fpeval{\textwidth /27}}
     \edef\temp@n{\fpeval{max(\temp@n,11.05)}}
     \edef\temp@n{\fpeval{min(\temp@n,12.04)}}
     \edef\temp@n{\fpeval{trunc(\temp@n,2)}}
     \setlength\type@size{\temp@n pt}
     \def\typesize@tail{(calculated)}
  }
  \edef\temp@n{\fpeval{round(\type@size,2,0)}}
  \edef\temp@d{\fpeval{\type@size * .996264}}
  \edef\temp@d{\fpeval{round(\temp@d,2,0)}}
  \xdef\typesize@string{{\temp@n pt} (\temp@d\space PostScript) \typesize@tail}
}
%%


%%
\newlength\printable@ht % Printable height (header+main+footer).
\newif\ifhe@der % True when layout has header.
\newif\iff@@ter % True when layout has footer.
\def\get@lines{
  \setlength\printable@ht{\trim@h-\m@top-\m@bot}
  \comp@re{\@scheme<4}{\global\f@@tertrue}{}
  \comp@re{\@scheme>1}{\global\he@dertrue}{}
  \comp@re{\@scheme=0}{\global\f@@terfalse}{}
  \ifdefined\lines@pp\else
    \edef\temp@d{\fpeval{\type@size * 1.3}} % Generous line spacing.
    \edef\temp@n{\fpeval{\printable@ht / \temp@d}}
    \ifhe@der\edef\temp@n{\fpeval{\temp@n - 1 - \h@gap}}\fi
    \iff@@ter\edef\temp@n{\fpeval{\temp@n - 1 - \f@gap}}\fi
    \xdef\lines@pp{\fpeval{trunc(\temp@n,0)}}
  \fi
}
%%


%%% Theory of Novelette page layout:
%   The Novelette term for normal \baselineskip is \@leading. Top margin
% (as defined by Novelette) is the upper printable limit. But the LaTeX
% internal value for top margin is set at 1\@leading above the topmost
% baseline of text (main or header). Swainson and (tweaked) Libertinus have
% tallest characters 0.84\type@size above baseline. Novelette absorbs the
% excess (\@leading-.84\type@size) by offsetting the LaTeX top margin,
% relative to the printable top margin.
%   The printable bottom margin remains the same as the LaTeX bottom margin.
% It is 0.3\@leading below the final text baseline (main or footer).
%   The effective number of lines is \lines@pp, plus 1+\h@gap if header,
% plus 1+\f@gap if footer. The \@leading, multiplied by this effective number,
% is 0.3\@leading less than the LaTeX margins, to allow for final descender.
%   Putting this all together:
% \printable@ht+\@leading-.84\type@size=(effectiveLines)\@leading+.3\@leading
% In the above equation, solve for \@leading.
%%
\newlength\@leading % Standard baseline skip. Calculated, not a setting.
\newlength\strut@ht % Height of strut, always .7\@leading.
\newlength\strut@dp % Depth of strut (positive), always .3\@leading.
\def\get@leading{
  \edef\temp@d{\fpeval{\lines@pp}} % This \temp@d becomes (adjustedLines).
  \ifhe@der\edef\temp@d{\fpeval{\temp@d + 1 + \h@gap}}\fi
  \iff@@ter\edef\temp@d{\fpeval{\temp@d + 1 + \f@gap}}\fi
  \edef\temp@n{\fpeval{(\printable@ht-.84\type@size)/(\temp@d-.7)}}
  \edef\temp@n{\fpeval{trunc(\temp@n,3)}}
  \setlength\@leading{\temp@n pt}
  \edef\temp@n{\fpeval{\@leading / \type@size}}
  % Well-behaved font: max riser (ÀÅ) + |descender| (JQgjpqy) < 1.2\type@size.
  % Swainson and (adjusted) Libertinus are well-behaved.
  % Check that you did not manually set too many lines:
  \comp@re{\temp@n>1.2}{}{
    \std@error{N}
    \gdef\lines@tail{(bad setting, too many lines)}
  }
  \setlength\baselineskip{\@leading}
  \setlength\strut@ht{.7\@leading}
  \setlength\strut@dp{.3\@leading}
  \edef\temp@n{\fpeval{round(\@leading,2,0)}}
  \edef\temp@d{\fpeval{\@leading * .996264}}
  \edef\temp@d{\fpeval{round(\temp@d,2,0)}}
  \xdef\le@ding@string{Calculated leading (baselineskip): %
    \temp@n pt (\temp@d\space PostScript)}
  \edef\temp@n{\fpeval{\@leading / \type@size}}
  \edef\temp@n{\fpeval{round(\temp@n,2,0)}}
  \xdef\lts@ratio{Calculated ratio leading/typesize: \temp@n. %
    Typically near 1.28.}
}
%%


%%
\def\get@placement{
%  \setlength\textheight{\lines@pp\@leading-.7\@leading+\type@size}
\setlength\textheight{\lines@pp\@leading+.3\@leading}
  \setlength\topskip{\@leading}
  \ifhe@der
    \setlength\headheight{\@leading}
    \setlength\headsep{\h@gap\@leading}
  \else
    \setlength\headheight{0pt}
    \setlength\headsep{0pt}
  \fi
  \iff@@ter
    \setlength\footskip{\@leading+\f@gap\@leading}
  \else
    \setlength\footskip{0pt}
  \fi
  \setlength{\skip\footins}{1\@leading \@plus .5\@leading \@minus .5\@leading}
}
%%


%%
\newlength\p@rindent % Standard paragraph indent.
\def\get@normalsize{
  \renewcommand\normalsize{\@setfontsize\normalsize{\type@size}{\@leading}}
  \normalsize
  \let\@normalsize\normalsize\relax % Hack.
  \setlength\p@rindent{\type@size}
  \setlength\parindent{\p@rindent}
  \directlua{emsize = tex.dimen.parindent}
  \ifdefined\myown@parindent
    \setlength\temp@l{\myown@parindent}
    \edef\temp@n{\fpeval{max(\type@size,\temp@l)}}
    \setlength\p@rindent{\temp@n pt}
    \setlength\parindent{\p@rindent}
  \fi
  \directlua{parindent = tex.dimen.parindent}
  \let\tiny\relax
  \let\scriptsize\relax
  \let\footnotesize\relax % Novelette uses remakrs instead, at another size.
  \let\small\relax
  \let\large\relax
  \let\Large\relax
  \let\LARGE\relax
  \let\huge\relax
  \let\Huge\relax
  \let\HUGE\relax
}
%%


%% Process user settings, set defaults, calculate page layout:
\AtEndPreamble{
  \LetLtxMacro\RequirePackage\get@package\relax
  \LetLtxMacro\usepackage\get@package\relax
  \ifthenelse{\dimtest{\trim@w}{=}{0pt}\OR\dimtest{\trim@h}{=}{0pt}}{
    \fatal@error{B}
  }{}
  \iflvdebug@enabled % Developer tool.
    \ifthenelse{\equal{\@mode}{draft}\OR\equal{\@mode}{shade}%
    \OR\equal{\@mode}{dev}}{
      \RequirePackage{lua-visual-debug}
    }{
      \typeout{^^JPackage lua-visual-debug ignored. %
        Only draft|shade|dev modes.^^J}
    }
  \fi
  \process@interior
  \gundef\setmainfont \gundef\setsansfont \gundef\setmonofont
  \gundef\newfontfamily \gundef\newfontface
  \RequirePackage[no-math,quiet]{fontspec}
  \RequirePackage{novelette-fonts}
  \process@fonts
  \RequirePackage{noindentafter}
  \LetLtxMacro\language\orig@language\relax
  \RequirePackage{luahyphenrules}
  \HyphenRules{\lang@hyph}
  \ifthenelse{\equal{\@mode}{typo}\OR\equal{\@mode}{typo*}}{
    \RequirePackage{luacolor} % Only within novelette-typo.
    \directlua{
      nvttypo = nvttypo or { }
      local string = \typo@single
      nvttypo.single = " "
      for p, c in utf8.codes(string) do
        local s = utf8.char(c)
        nvttypo.single = nvttypo.single .. s
      end
      local string = \typo@double
      nvttypo.double = " "
      for p, c in utf8.codes(string) do
        local s = utf8.char(c)
        nvttypo.double = nvttypo.double .. s
      end
      local string = \typo@doublest
      nvttypo.doublest = " "
      for p, c in utf8.codes(string) do
        local s = utf8.char(c)
        nvttypo.doublest = nvttypo.doublest .. s
      end
      require('novelette-typo')
      luatexbase.add_to_callback("pre_shipout_filter",nvttypo.check,"check",1)
    }
  }{}
  \RequirePackage{novelette-color} % Denies color, except shade mode grays.
  \RequirePackage{novelette-utilities}
  \RequirePackage{novelette-footnotes}
  \RequirePackage{novelette-displays}
  \directlua{require('novelette-pdftc')} % Minimal pdftexcmds.
  \gdef\nvt@filesize#1{%
    \directlua{novelette.pdftc.filesize('\luaescapestring{#1}')}%
  }
  \long\gdef\nvt@mdfivesum#1{%
    \directlua{novelette.pdftc.mdfivesum('\luaescapestring{#1}', 'byte')}%
  }%
  \RequirePackage{novelette-graphics}
  \RequirePackage{novelette-headers}
  \process@headfoot
  \RequirePackage{novelette-metadata}
  \process@metadata
  \process@pdfboxes
}
%%


%% Finish the setup, with some values not available until here:
\AtBeginDocument{
  \global\deflength\textfloatsep{0pt plus \@leading minus \@leading}
  \global\deflength\parindent{\p@rindent}
  \gdef\forceindent{\ifvmode\else\unskip\fi\stake\hspace{\p@rindent}}
  \gdef\backindent{\ifvmode\else\unskip\fi\hspace{-\p@rindent}}
  \ifthenelse{\equal{\@mode}{final}}{\global\deflength\overfullrule{0pt}}{}
  \DeclareDocumentCommand\textls{sO{}+m}{#3} % Do-nothing.
  \let\lsstyle\relax
  \ifthenelse{\equal{\@mode}{shade}\OR\equal{\@mode}{dev}}{%
    \RequirePackage{novelette-shading}
  }{}
  \hyphenpenalty=1000
  \exhyphenpenalty=1000
  \gdef\verso@head{}
  \gdef\recto@head{}
  \pagestyle{normal} % Use \frontmatter at start.
}
%%


%% Tacked onto the end of AtBeginDocument, just prior to document body:
\AfterEndPreamble{ % Deactivate many special characters and macros.
  \catcode`\$=12
  \catcode`\_=12
  \catcode`\#=12
  \catcode`\&=12
  \catcode`\^=12
  \def\({(}
  \def\){)}
  \def\[{[}
  \def\]{]}
}
%%


%% Runs at \end{document}. Document is still writeable here:
\AtEndDocument{
  \catcode`\"=12
  \catcode`\$=3
  \catcode`\_=8
  \catcode`\#=6
  \catcode`\&=4
  \catcode`\^=7
  \ifnocle@rtoend\else
    \clearpage
    \ifodd\c@page
      \thispagestyle{empty}\null\clearpage
    \fi
    \thispagestyle{empty}\null\clearpage
  \fi
  \comp@re{\value{dbl@qq}=0}{}{
    \@lert{\arabic{dbl@qq}\space instances of " in document body.}
  }
  \pdfextension info{%
    /CreationDate(\pdffeedback creationdate) % Needs space percent.
    /ModDate(\pdffeedback creationdate) % Needs space percent.
  }
  \iferrorsissued{\global\b@dtrue}{}
  \ifthenelse{\equal{\@mode}{final}}{
    \@oktrue
    \ifthenelse{\equal{\@title}{Untitled Document}}{\@okfalse}{}
    \ifthenelse{\equal{\@author}{Anonymous Author}}{\@okfalse}{}
    \if@ok\else
      \gdef\@mode{draft}
      \gdef\@intent{none}
      \gdef\intent@tail{(missing title or author)}
      \gdef\@mode@tail{(missing title or author)}
    \fi
  }{
    \gdef\@intent{none} \gdef\intent@tail{(not in final mode)}
  }
  \ifb@d
    \ifthenelse{\equal{\@mode}{final}}{
      \gdef\@mode{draft} \gdef\mode@tail{(re-set due to error)}
      \gdef\@intent{none} \gdef\intent@tail{(re-set due to error)}
    }{}
  \fi
  \ifthenelse{\equal{\@mode}{final}}{\gdef\mod@xmplabel{}}{}
  \attach@metadata
  \attach@xmp
  \ifthenelse{\equal{\@intent}{none}}{}{\attach@intent}
  % Omit TeX terminal message about how much used, substitute another message:
  % Thanks to David Carlisle, tex.stackexchange.com q. 699703. CC-BY-SA 4.0.
  \ifthenelse{\equal{\@mode}{typo}\OR\equal{\@mode}{typo*}}{
    \directlua{
      typowritefile()
      if pagetotal == " " then
        luatexbase.add_to_callback('stop_run',
          function ()
            texio.write(
              "\string\n\string\n\string\n
               In typo mode, no summary file is created.\string\n
               If summary file exists, it is unchanged from prior run.\string\n
               ALERT: Typo flaws found. See *.typo file.\string\n
               \string\n"
            )
          end,
          'final message'
        )
      else
        luatexbase.add_to_callback('stop_run',
          function ()
            texio.write(
              "\string\n\string\n\string\n
               In typo mode, no summary file is created.\string\n
               If summary file exists, it is unchanged from prior run.\string\n
               ALERT: Typo flaws found. See *.typo file.\string\n
               \string\n"
            )
          end,
          'final message'
        )
      end
    }
  }{
    \IfNada{\prev@lerts}{
      \def\got@lert{}
    }{
      \def\got@lert{! One or more ALERT messages in the summary file.\string\n}
    }
    \edef\notypo@msg{
      \string\n Novelette provides an important summary file, with:\string\n
      * Actual settings used for the PDF (not always your settings),\string\n
      * Suggested pixel sizes for images and icons,\string\n
      * Other useful information.\string\n
      Summary file: \jobname-summary.log.\string\n
      \got@lert
    }
    \directlua{
      luatexbase.add_to_callback('stop_run',
        function ()
          texio.write("\string\n\string\n \notypo@msg \string\n")
        end,
        'final message'
      )
    }
  }
}
%%


%%
\def\st@rs{*******************************************************************}
\def\write@summary{
  \IfNada{\prev@lerts}{\def\prev@lerts{^^J\space\space No alerts.}}{}
  \ifb@d
    \def\temp@s{^^J!!!!! ERROR OR CRITICAL WARNING. OUTPUT IS INVALID. !!!!!}
  \else\def\temp@s{}\fi
  \newwrite\outfile
  \immediate\openout\outfile=\jobname-summary.log
  \immediate\write\outfile{\st@rs^^J%
  NOVELETTE SUMMARY FOR: \jobname.pdf^^J\shortd@te^^J\temp@s\st@rs^^J%
  These are the actual values used. If different from your settings,^^J%
  it means Novelette used defaults, or needed to over-ride yours:^^J\st@rs^^J%
  METADATA^^J%
  \space\space\string\mode{\@mode} \mode@tail^^J%
  \space\space\string\title{\@title} \title@tail^^J%
  \space\space\string\author{\@author} \author@tail^^J%
  \space\space\string\subtitle{\@subtitle} \subtitle@tail^^J%
  \space\space\string\application{\applic@tion} \application@tail^^J%
  \space\space\string\producer{\pr@ducer} \producer@tail^^J%
  \space\space\string\intent{\@intent} \intent@tail^^J%
  \space\space\string\language\lang@option{\set@lang} \lang@tail^^J%
  \space\space Total pages (front, main, blanks): \arabic{totalpages}^^J%
  SIZE AND LAYOUT^^J%
  \space\space\string\trimsize{\trim@size}^^J%
  \space\space\string\sheetfeed{\sheet@feed} \sheetfeed@tail^^J%
  \space\space\string\margins{\margin@setting} \margin@tail^^J%
  \space\space\string\layout{\layout@setting} \layout@tail^^J%
  \space\space\string\lines{\lines@pp} \lines@tail^^J%
  \space\space\string\guides{\@guides} \guides@tail^^J%
  FONTS (always subset embedded)^^J%
  \space\space Swainson is the built-in font family.^^J%
  \space\space It is used in main text, footnotes, page headers/footers,^^J%
  \space\space and \string\name\space and \string\subname\space commands.^^J%
  TYPOGRAPHY^^J%
  \space\space Maximum permitted font expansion: +/- 2\%.^^J%
  \space\space\string\typesize\typesize@string^^J%
  \space\space Estimated average chars/line: \chars@line. Typical 55-75.^^J%
  \space\space\le@ding@string^^J%
  \space\space\lts@ratio^^J%
  IMAGES (at 600 pixels/inch = 232.22 pixels/cm)^^J%
  \log@miw^^J\log@moli^^J\log@mtli^^J\log@eel^^J\log@mfpi^^J\log@iid^^J%
  ICONS (at 600 pixels/inch = 232.22 pixels/cm)^^J%
  \log@mcw^^J%
  \space\space If \string\icon\space is within scaled text, such as %
    \string\name,^^J\space\space\space\space %
    then multiply the following values by the scale:^^J%
  \log@icb^^J\log@icm^^J\log@ich^^J%
  ALERTS%
  \prev@lerts^^J^^J\st@rs^^J%
  Document Class novelette v0.\class@ver. Processed by lualatex.^^J\st@rs}%
  \immediate\closeout\outfile
}
%%


%% Log final messages and summary:
\AfterEndDocument{
  \ifthenelse{\equal{\@mode}{typo}\OR\equal{\@mode}{typo*}}{}{
    \write@summary
    \IfFileExists{./\jobname.typo}{
      \immediate\openout\outfile=\jobname.typo
      \immediate\write\outfile{%
        Nothing to see here.^^J%
        Most recent compile was not in typo mode.^^J%
        Any prior typo results have been discarded.^^J%
      }
      \immediate\closeout\outfile
    }{}
  }
}
%%


%%
\endinput
%%
%% End of file `novelette-interior.sty'.
