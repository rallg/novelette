%% This is file `novelette-opening.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-opening.sty}%
[2023/10/26 v0.21 LaTeX file (openings and display pages).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).

%% OPENINGS
% Each chapter, and perhaps some other material, should begin with an opening.
% Although this is not enforced, it is standard practice.
%   The opening is an area in the upper portion of the textblock, typically
% one-fourth to one-half of the printable height, at your discretion. Most of
% this area is whitespace. Within the opening will be its name (chapter title)
% and perhaps other information such as subname, decorative image, and brief
% explanation. The less, the better. Most books use only the chapter name.
%   Beneath the opening, main text begins. Its first line is not indented.
% You may use the \init command for distinctive styling of the first letter
% and first few words.
%   Novelette does not set or enforce any particular opening height, or any
% particular opening content, with these restrictions: The style used for
% \name and \subname is set in Preamble, and cannot be locally changed,
% although it may be re-aligned.
%   Use \null to insert a blank line, where needed. Use guides in shade mode,
% to ensure that the content of the opening, and the placement of main text,
% is uniform from chapter to chapter.
%%


%% OPENING ENVIRONMENT
%   An opening is created by the opening environment. It starts a new page,
% but does not clear the page when it ends. Main text following the opening
% will be on-grid. This is how to begin each chapter. It is also useful for
% some things that are not chapters, but have the same appearance.
%   If the page layout has a header, it will be empty above an opening.
% If the page layout has a footer, it may print.
\newif\if@opening % True within opening environment.
\newenvironment{opening}{%
  \clearpage%
  \ifhe@der%
    \iff@@ter%
      \thispagestyle{foot}%
    \else%
      \thispagestyle{empty}%
    \fi%
  \fi%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \null\vspace*{-\le@ding}%
  \begingroup%
  \zm@rktrue%
  \@openingtrue%
  \setlength\parindent{0pt}% Just within this environment.
}{% Close the environment:
  \setcounter{fnm@num}{1}% Footnote markers.
  \endgroup%
}
\AfterEndEnvironment{opening}{%
  \NoIndentAfterThis%
}
%%


%% NAME
%   The \name command is intended for such things as chapter titles. It may
% only be used within an opening, or on a display page.
%   In Preamble, \namestyle sets the font and scale of \name text.
% It also sets the default alignment, which may be locally changed.
%   You cannot break or wrap lines, or use paragraphs, within \name.
% However, you may use \name several times for multi-line text. Each may
% have its own local alignment.
\DeclareDocumentCommand\name{O{}m}{% Optional alignment.
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \StrDel{#1}{ }[\temp@s]%
  \IfNadaTF{\temp@s}{%
    \edef\pns@align{\nn@align}% Global setting.
  }{%
    \IfSubStr{:l:c:r:o:i:}{:\temp@s:}{%
      \edef\pns@align{\temp@s}% Local setting.
    }{%
      \edef\pns@align{\nn@align}% Global setting.
      \typeout{ALERT: Bad option for \string\name, page \thepage.}
      \g@addto@macro\misc@lert%
        {ALERT: Bad option for \string\name, page \thepage.}%
    }%
  }%
  \def\pns@scale{\nn@scale}%
  \if@ok%
    {\name@font\place@name{#2}}%
  \else%
    \@error{\string\name\space only allowed in openings and displays.^^J%
      Ignored \string\name\space on page \thepage.}%
    \par{\centering#1\par}%
  \fi%
}
%%


%% SUBNAME
%   The \subname command is intended for such things as chapter subtitles.
% It may only be used within an opening, or on a display page.
%   In Preamble, \subnamestyle sets the font and scale of \subname text.
% It also sets the default alignment, which may be locally changed.
%   You cannot break or wrap lines, or use paragraphs, within \subname.
% However, you may use \subname several times for multi-line text. Each may
% have its own local alignment.
\DeclareDocumentCommand\subname{O{}m}{% Optional alignment.
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \StrDel{#1}{ }[\temp@s]%
  \IfNadaTF{\temp@s}{%
    \edef\pns@align{\nn@align}% Global setting.
  }{%
    \IfSubStr{:l:c:r:o:i:}{:\temp@s:}{%
      \edef\pns@align{\temp@s}% Local setting.
    }{%
      \edef\pns@align{\nn@align}% Global setting.
      \typeout{ALERT: Bad option for \string\subname, page \thepage.}
      \g@addto@macro\misc@lert%
        {ALERT: Bad option for \string\subname, page \thepage.}%
    }%
  }%
  \def\pns@scale{\sn@scale}%
  \if@ok%
    {\subname@font\place@name{#2}}%
  \else%
    \@error{\string\subname\space only allowed in openings and displays.^^J%
      Ignored \string\subname\space on page \thepage.}%
    \par{\centering#1\par}%
  \fi%
}
%%


%% PLACE NAME or SUBNAME
\DeclareDocumentCommand\place@name{m}{%
  \par\vspace*{-\le@ding}\leavevmode\strut\par%
  \setlength\parindent{0pt}%
  \hyphenpenalty=20000%
  \edef\pns@tot{\fpeval{ceil(1.2*\pns@scale*\type@size/\le@ding)}}% %%%%%
  \edef\temp@d{\fpeval{\pns@tot-(1.2*\pns@scale*\type@size/\le@ding)}}%
  \edef\pns@ht{\fpeval{\temp@d+(.84*\pns@scale*\type@size/\le@ding)}}% %%%%%
  \edef\pns@dp{\fpeval{\pns@tot-\pns@ht}}% %%%%%
  \ifthenelse{\equal{\pns@align}{l}}{\raggedright}{}%
  \ifthenelse{\equal{\pns@align}{r}}{\raggedleft}{}%
  \ifthenelse{\equal{\pns@align}{o}}{%
    \ifodd\c@page\raggedleft\else\raggedright\fi%
  }{}%
  \ifthenelse{\equal{\pns@align}{i}}{%
    \ifodd\c@page\raggedright\else\raggedleft\fi%
  }%
  \ifthenelse{\equal{\pns@align}{c}}{%
    {\centering%
      \up@feeler{\pns@ht\le@ding}#1\dn@feeler{\pns@dp\le@ding}\par%
    }%
  }{%
    \up@feeler{\pns@ht\le@ding}#1\dn@feeler{\pns@dp\le@ding}\par%
  }%
  \vspace*{-\le@ding}\leavevmode\strut\par%
}
%%


%% SCENE (following paragraph not indented)
%   This command is one way to break a chapter into separate scenes.
% It has several formats.
%   If you write text in \scene, it is slightly larger than main text,
% slightly condensed, and slightly loose tracking. This emulates using
% a font that was especially designed for the slightly larger size.
\newcommand\scene[1]{% Empty, hyphen, asterisk, text.
  \ifvmode\else\par\fi%
  \vspace*{-\le@ding}\null%
  \StrDel{#1}{ }[\temp@s]%
  \noindent\strut\up@feeler{2\le@ding}%
  \@okfalse%
  \ifthenelse{\equal{\temp@s}{}}{\@oktrue}{}%
  \ifthenelse{\equal{\temp@s}{-}}{%
    \@oktrue\hfil\rule[.5\x@ht + .5\le@ding]{.25\textwidth}{.5pt}\hfil\par%
  }{}%
  \ifthenelse{\equal{\temp@s}{*}}{%
    \@oktrue\sbox0{*}%
    \setlength\temp@l{1.1\x@ht-1.2\ht0}%
    \def\temp@d{\addfontfeature{Scale=1.2}*\hspace{30pt}*\hspace{30pt}*}%
    \hfil\smash{\raisebox{\temp@l}{{\temp@d}}}\hfil\par%
  }{}%
  \if@ok\else%
    \def\temp@d{#1}%
    \null\smash{\raisebox{.25\le@ding}{%
      \IfBeginWith{#1}{-}{%
        \makebox[\normalindent][l]{\rule[.52\x@ht]{.84\normalindent}{.5pt}}%
        \StrGobbleLeft{#1}{1}[\temp@d]%
      }{}%
      \IfBeginWith{#1}{+}{%
        \makebox[\normalindent][l]{\rule[.52\X@ht]{.84\normalindent}{.5pt}}%
        \StrGobbleLeft{#1}{1}[\temp@d]%
      }{}%
      \def\temp@s{ScaleAgain=1.16,FakeStretch=.94,LetterSpace=2}%
      {\addfontfeature{\temp@s,RawFeature={-onum}}\temp@d}%
    }}\par%
  \fi%
  \NoIndentAfterThis%
}
%%


%% \init[kern]{Letter}{phrase} for optional styling first line of a chapter.
% Swainson feature cv10 ensures that JQÇ¡¿ descenders are not too deep.
\DeclareDocumentCommand\init{O{0}mm}{%
  \noindent\smash{\addfontfeature{ScaleAgain=1.5,RawFeature={+cv10,-onum}}#2}%
  \IfDecimal{#1}{\kern#1em}{%
    \ClassWarning{novelette}{Bad kern value in \string\init, page \thepage.^^J%
      This kern does not use units, just the number (units will be em).}%
  }%
  \smcp{#3}%
}
%%


%%
\endinput
%%
%% End of file `novelette-opening.sty'.
