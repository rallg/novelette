%% This is file `novelette-opening.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-opening.sty}%
[2023/10/08 v0.19 LaTeX file (openings and display pages).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).


%% DISPLAY, OPENING, SCENE
%   A `display' is created by display environment. It starts a new page,
% and clears to a new page when it ends. Although it is intended for an
% individual page, it may extend to more than one, if the content does not fit.
%   Within a display, you may style text and place things anywhere within
% the area of main text block. You do not need to obey the line grid, and in
% most cases that is why you use display.
%   A display is commonly used for Half-Title and Title pages, because they
% have distinctive content. But you may use display almost anywhere.
%   You cannot float a display, so it cannot be used in the middle of
% other text. If you need to float some full-page content, then create it as
% a full-page image (complete with its text).
%   An `opening' is created by the opening environment. It starts a new page,
% but does not clear the page when it ends. Main text following the opening
% will be on-grid. This is how to begin each chpater. It is also useful for
% some things that are not chapters, but have the same appearance.
%   If the page layout has a header, it will be empty on display pages, and
% on opening pages. If the layout has a footer, it will print on opening pages,
% but not on display pages. You may over-ride using \thispagestyle{footer}.
% Within an opening or on a display page, paragraph indent is zero.
%   Without the opening environment, and anywhere on a display page, you may
% use the \name, \subname, and \style macros for changing text style on a
% line-by-line basis (not wrapped, not paragraphs). You may these commands
% more than once, in any order. The \name and \subname styles are globally
% set in Preamble, and cannot be changed locally. The \style command has its
% own per-use settings.
%   The \scene command is intended for sub-chapters, where the text continues
% after a break. The break may simply be a line gap, or may have an identifier.
%%



%% DISPLAY PAGE
\newenvironment{display}{%
  \clearpage%
  \thispagestyle{empty}%
  \null\vspace*{-\le@ding}%
  \begingroup%
  \display@pagetrue%
  \zm@rktrue%
  \setlength\parindent{0pt}%
  %%%%%\setlength\parskip{\le@ding}%
}{% End the environment:
  \endgroup%
}
\AfterEndEnvironment{display}{\clearpage}
%%


%% OPENING ENVIRONMENT
\newenvironment{opening}{%
  \clearpage%
  \ifhe@der%
    \iff@@ter%
      \thispagestyle{footer}%
    \else%
      \thispagestyle{empty}%
    \fi%
  \fi%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \null\vspace*{-\le@ding}%
  \begingroup%
  \zm@rktrue%
  \@openingtrue%
  \setlength\parindent{0pt}% Just within this environment.
}{% Close the environment:
  \setcounter{fnm@num}{1}% Footnote markers.
  \endgroup%
}
\AfterEndEnvironment{opening}{%
  \NoIndentAfterThis%
}
%%


%% NAME (Global setting in Preamble, using \namestyle.)
\DeclareDocumentCommand\name{m}{%
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \if@ok%
    \par%
    \begingroup%
    \place@text{name}{#1}%
    \endgroup%
  \else%
    \@error{\string\name\space only allowed in openings and displays.^^J%
      Ignored \string\name\space on page \thepage.}%
    {#1}%
  \fi%
}
%%


%% SUBNAME (Global settings in Preamble, using \subnamestyle.}
\DeclareDocumentCommand\subname{m}{%
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \if@ok%
    \par%
    \begingroup%
    \place@text{subname}{#1}%
    \endgroup%
  \else%
    \@error{\string\subname\space only allowed in openings and displays.^^J%
      Ignored \string\subname\space on page \thepage.}%
    {#1}%
  \fi%
}
%%


%% STYLE (Like name and subname, but allows local settings.)
\def\ss@align{c} \def\ss@font{main} \def\ss@scale{1}
\DeclareDocumentCommand\style{O{}m}{%
  \check@style{#1}{#2}%
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \if@ok%
    \par%
    \begingroup%
    \place@text{style}{#2}%
    \endgroup%
  \else%
    \@error{\string\style\space only allowed in openings and displays.^^J%
      Ignored \string\style\space on page \thepage.}%
    {#2}%
  \fi%
}
%%


%%
\DeclareDocumentCommand\check@style{mm}{%
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \if@ok\else%
    \@error{\string\style\space only allowed in openings and displays.^^J%
      Ignored \string\style\space on page \thepage.}%
    {#2}%
  \fi%
  \StrDel{#1,}{ }[\temp@s]%
  \StrBehind{\temp@s}{align=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \ifthenelse{\equal{\temp@n}{}}{\def\ss@align{c}}{%
    \IfSubStr{:l:c:r:o:i:}{:\temp@n:}{%
      \edef\ss@align{\temp@n}%
    }{\@okfalse}%
  }%
  \StrBehind{\temp@s}{font=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \ifthenelse{\equal{\temp@n}{}}{\def\ss@font{main}}{%
    \IfSubStr{:main:sans:mono:alt:drama:deco:}{:\temp@n:}{%
      \edef\ss@font{\temp@n}%
    }{\@okfalse}%
  }%
  \StrBehind{\temp@s}{scale=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \ifthenelse{\equal{\temp@n}{}}{\def\ss@scale{1}}{%
    \IfDecimal{\temp@n}{%
      \ifthenelse{\fpeval{\temp@n<.75}=1}{\@okfalse}{\edef\ss@scale{\temp@n}}%
    }{\@okfalse}%
  }%
  \if@ok\else%
    \@error{Bad value in \string\style[align=A,font=F,scale=S]{text}.^^J%
       A may be one of c l r o i. Horizontal alignment. Default c.^^J%
       F is one of main,sans,mono,alt,drama,deco. Font. Default main.^^J%
       S is a number >=.75. Scale. Default 1. On page \thepage.}%
  \fi%
}
%%


%% PLACE TEXT (name, subname, style. Only in display pages and openings.)
\DeclareDocumentCommand\place@text{mm}{%
  \vspace*{-\le@ding}\leavevmode\strut\par%
  \ifthenelse{\equal{#1}{name}}{%
    \def\pt@align{\nn@align}\def\pt@font{\nn@font}\def\pt@scale{\nn@scale}%
  }{}%
  \ifthenelse{\equal{#1}{subname}}{%
    \def\pt@align{\sn@align}\def\pt@font{\sn@font}\def\pt@scale{\sn@scale}%
  }{}%
  \ifthenelse{\equal{#1}{style}}{%
    \def\pt@align{\ss@align}\def\pt@font{\ss@font}\def\pt@scale{\ss@scale}%
  }{}%
  \setlength\parindent{0pt}%
  \hyphenpenalty=20000%
  \edef\style@tot{\fpeval{ceil(1.2*\pt@scale*\type@size/\le@ding)}}% %%%%%
  \edef\temp@d{\fpeval{\style@tot-(1.2*\pt@scale*\type@size/\le@ding)}}%
  \edef\style@ht{\fpeval{\temp@d+(.84*\pt@scale*\type@size/\le@ding)}}% %%%%%
  \edef\style@dp{\fpeval{\style@tot-\style@ht}}% %%%%%
  \ifthenelse{\equal{\pt@align}{l}}{\raggedright}{}%
  \ifthenelse{\equal{\pt@align}{r}}{\raggedleft}{}%
  \ifthenelse{\equal{\pt@align}{o}}{%
    \ifodd\c@page\raggedleft\else\raggedright\fi%
  }{}%
  \ifthenelse{\equal{\pt@align}{i}}{%
    \ifodd\c@page\raggedright\else\raggedleft\fi%
  }%
  \ifthenelse{\equal{\pt@align}{c}}{%
    {\centering%
      \csname\pt@font\endcsname{\addfontfeature{%
        ScaleAgain=\pt@scale,RawFeature={-liga,-dlig}}%
        \up@feeler{\style@ht\le@ding}#2\dn@feeler{\style@dp\le@ding}}\par%
    }%
  }{%
    \csname\pt@font\endcsname{\addfontfeature{%
      ScaleAgain=\pt@scale,RawFeature={-liga,-dlig}}%
      \up@feeler{\style@ht\le@ding}#2\dn@feeler{\style@dp\le@ding}}\par%
  }%
  \vspace*{-\le@ding}\leavevmode\strut\par%
}
%%


%% SCENE (following paragraph not indented)
% If you write text in \scene, it is slightly larger than main text,
% slightly condensed, and slightly loose tracking. This emulates using
% a font that was especially designed for the slightly larger size.
\DeclareDocumentCommand\scene{m}{% Empty, hyphen, asterisk, text.
  \ifvmode\else\par\fi%
  \vspace*{-\le@ding}\null%
  \StrDel{#1}{ }[\temp@s]%
  \noindent\strut\up@feeler{2\le@ding}% %%%%%
  \@okfalse
  \ifthenelse{\equal{\temp@s}{}}{\@oktrue}{}%
  \ifthenelse{\equal{\temp@s}{-}}{%
    \@oktrue\hfil\rule[.5\x@ht + .5\le@ding]{.25\textwidth}{.5pt}\hfil\par%
  }{}%
  \ifthenelse{\equal{\temp@s}{*}}{%
    \@oktrue\sbox0{*}%
    \setlength\temp@l{1.1\x@ht-1.2\ht0}%
    \def\temp@d{\addfontfeature{Scale=1.2}*\hspace{30pt}*\hspace{30pt}*}%
    \hfil\smash{\raisebox{\temp@l}{{\temp@d}}}\hfil\par%
  }{}%
  \if@ok\else%
    \def\temp@d{#1}%
    \null\smash{\raisebox{.25\le@ding}{%
      \IfBeginWith{#1}{-}{%
        \makebox[\normalindent][l]{\rule[.52\x@ht]{.84\normalindent}{.5pt}}%
        \StrGobbleLeft{#1}{1}[\temp@d]%
      }{}%
      \IfBeginWith{#1}{+}{%
        \makebox[\normalindent][l]{\rule[.52\X@ht]{.84\normalindent}{.5pt}}%
        \StrGobbleLeft{#1}{1}[\temp@d]%
      }{}%
      {\addfontfeature{ScaleAgain=1.16,FakeStretch=.94,LetterSpace=2}\temp@d}%
    }}\par%
  \fi%
  \NoIndentAfterThis%
}
%%



%%
\endinput
%%
%% End of file `novelette-opening.sty'.
