%% This is file `novelette-opening.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-opening.sty}%
[2023/09/13 v0.13 LaTeX file (openings and display pages).]
%%


%% This file is not loaded when processing cover.


%% DISPLAY, OPENING, SCENE
%   A "display" is created by display environment. It starts a new page,
% and clears to a new page when it ends. Although it is intended for an
% individual page, it may extend to more than one, if the content does not fit.
%   Within a display, you may style text and place things anywhere within
% the area of main text block. You do not need to obey the line grid, and in
% most cases that is why you use display. You may use \name and \subname.
% Display pages have empty header and footer. Paragraph indent is zero.
%   A display is commonly used for Half-Title and Title pages, because they
% have distinctive content. But you may use display almost anywhere.
%   You cannot float a display, so it cannot be used in the middle of
% other text. If you need to float some full-page content, then create it as
% a full-page image (complete with its text).
%   An "opening" is created by the opening environment. It starts a new page,
% but does not clear the page when it ends. Main text following the opening
% will be on-grid.
%  Within an opening, you may style text (such as chapter title) using the
% \name and \subname commands.
%  The \scene command is intended for sub-chapters, where the text continues
% after a break. The break may simply be a line gap, or may have an identifier.
%%


%% DISPLAY
\newenvironment{display}{%
  \clearpage%
  \thispagestyle{empty}%
  \null\vspace{-\le@ding}%
  \begingroup%
  \display@pagetrue%
  \zm@rktrue%
  \setlength\parindent{0pt}%
  \setlength\parskip{\le@ding}%
}{% End the environment:
  \endgroup%
}
\AfterEndEnvironment{display}{\clearpage}
%%


%% OPENING
\newenvironment{opening}{%
  \clearpage%
  \strut\par\vspace{-\le@ding}%
  \ifhe@der%
    \iff@@ter%
      \thispagestyle{footer}%
    \else%
      \thispagestyle{empty}%
    \fi%
  \fi%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \begingroup%
  \zm@rktrue%
  \@openingtrue%
  \setlength\parindent{0pt}% Just within this environment.
}{% Close the environment:
  \setcounter{nvt@fnmnum}{1}% Footnote markers.
  \endgroup%
}
\AfterEndEnvironment{opening}{%
  \NoIndentAfterThis%
}
%%


%% NAME (Option locally over-rides global \namestyle setting.)
\DeclareDocumentCommand\name{O{}m}{%
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \if@ok%
    \parse@nameoption{#1}{#2}%
  \else%
    \@error{Cannot use \string\name, page \thepage.^^J%
      It may only be used in opening environment and display pages.}%
  \fi%
}
%%
\def\parse@nameoption#1#2{%
  \begingroup%
  \StrDel{#1,}{ }[\temp@s]%
  \@oktrue%
  \StrBehind{\temp@s}{align=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfSubStr{:l:c:r:o:i:}{:\temp@n:}{%
    \edef\name@align{\temp@n}%
  }{%
    \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
  }%
  \StrDel{\temp@s}{align=\name@align,}[\temp@s]%
  \StrBehind{\temp@s}{font=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfSubStr{:main:sans:mono:alt:drama:deco:}{:\temp@n:}{%
    \edef\name@font{\temp@n}%
  }{%
    \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
  }%
  \StrDel{\temp@s}{font=\name@font,}[\temp@s]%
  \StrBehind{\temp@s}{scale=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfDecimal{\temp@n}{%
    \FPiflt{\temp@n}{1}\@okfalse\fi%
    \FPifgt{\temp@n}{3}\@okfalse\fi%
    \if@ok\edef\name@scale{\temp@n}\fi%
  }{%
    \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
  }%
  \StrDel{\temp@s}{scale=\name@scale,}[\temp@s]%
  \IfSubStr{\temp@s}{onum,}{\def\n@num{o}\StrDel{\temp@s}{onum,}[\temp@s]}{}%
  \IfSubStr{\temp@s}{lnum,}{\def\n@num{l}\StrDel{\temp@s}{lnum,}[\temp@s]}{}%
  \StrDel{\temp@s}{,}[\temp@s]%
  \ifthenelse{\equal{\temp@s}{}}{}{\g@addto@macro\misc@lert{%
    \typeout{ALERT: Ignored unknown option in \string\name, page \thepage.}}%
  }%
  \if@ok%
    \place@name{#2}%
  \else%
    \@error{Bad optional argument in \string\name, page \thepage.^^J%
      If used, options locally over-ride global \string\namestyle.^^J%
       align=A, where A is one of c l r o i. Horizontal alignment.^^J%
       font=F, where F is one of main, sans,mono,alt,drama,deco. Font.^^J%
       scale=S, where S is a number 1-3. May be decimal. Scale.}%
  \fi%
  \endgroup%
  \@oktrue%
}
%%
\def\place@name#1{%
  \def\temp@d{}%
  \ifthenelse{\equal{\n@num}{o}}{\def\temp@d{Numbers=ResetAll,Numbers=OldStyle}}{}%
  \ifthenelse{\equal{\n@num}{l}}{\def\temp@d{Numbers=ResetAll,Numbers=Lining}}{}%
  \def\tfe@t{ScaleAgain=\name@scale,Ligatures=ResetAll,\temp@d}%
  \ifthenelse{\equal{\name@font}{main}}{\edef\temp@s{\addfontfeature{\tfe@t}#1}}{}%
  \ifthenelse{\equal{\name@font}{sans}}{\edef\temp@s{\sans{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{mono}}{\edef\temp@s{\mono{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{alt}}{\edef\temp@s{\alt{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{drama}}{\edef\temp@s{\drama{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{deco}}{\edef\temp@s{\deco{\addfontfeature{\tfe@t}#1}}}{}%
  \strut\par\strut\par%
  \ifthenelse{\equal{\name@align}{l}}{%
    \strut\smash{\temp@s}\hfill\par}{}%
  \ifthenelse{\equal{\name@align}{c}}{%
    {\centering\strut\smash{\temp@s}\par}}{}%
  \ifthenelse{\equal{\name@align}{r}}{%
    \strut\hfill\smash{\temp@s}\par}{}%
  \ifthenelse{\equal{\name@align}{o}}{%
    \ifodd\c@page%
      \strut\hfill\smash{\temp@s}\par%
    \else%
      \strut\smash{\temp@s}\hfill\par%
    \fi%
  }{}%
  \ifthenelse{\equal{\name@align}{i}}{%
    \ifodd\c@page%
      \strut\smash{\temp@s}\hfill\par%
    \else%
      \strut\hfill\smash{\temp@s}\par%
    \fi%
  }{}%
}
%%


%% SUBNAME (Option locally over-rides global \subnamestyle setting.)
\DeclareDocumentCommand\subname{O{}m}{%
  \@okfalse%
  \if@opening\@oktrue\fi%
  \ifdisplay@page\@oktrue\fi%
  \if@ok%
    \parse@subnameoption{#1}{#2}%
  \else%
    \@error{Cannot use \string\subname, page \thepage.^^J%
      It may only be used in opening environment and display pages.}%
  \fi%
}
%%
\def\parse@subnameoption#1#2{%
  \begingroup%
  \StrDel{#1,}{ }[\temp@s]%
  \@oktrue%
  \StrBehind{\temp@s}{align=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfSubStr{:l:c:r:o:i:}{:\temp@n:}{%
    \edef\subname@align{\temp@n}%
  }{%
    \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
  }%
  \StrDel{\temp@s}{align=\subname@align,}[\temp@s]%
  \StrBehind{\temp@s}{font=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfSubStr{:main:sans:mono:alt:drama:deco:}{:\temp@n:}{%
    \edef\subname@font{\temp@n}%
  }{%
    \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
  }%
  \StrDel{\temp@s}{font=\subname@font,}[\temp@s]%
  \StrBehind{\temp@s}{scale=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfDecimal{\temp@n}{%
    \FPiflt{\temp@n}{1}\@okfalse\fi%
    \FPifgt{\temp@n}{3}\@okfalse\fi%
    \if@ok\edef\subname@scale{\temp@n}\fi%
  }{%
    \ifthenelse{\equal{\temp@n}{}}{}{\@okfalse}%
  }%
  \StrDel{\temp@s}{scale=\subname@scale,}[\temp@s]%
  \IfSubStr{\temp@s}{onum,}{\def\s@num{o}\StrDel{\temp@s}{onum,}[\temp@s]}{}%
  \IfSubStr{\temp@s}{lnum,}{\def\s@num{l}\StrDel{\temp@s}{lnum,}[\temp@s]}{}%
  \StrDel{\temp@s}{,}[\temp@s]%
  \ifthenelse{\equal{\temp@s}{}}{}{\g@addto@macro\misc@lert{%
    \typeout{ALERT: Ignored unknown option in \string\subname, page \thepage.}}%
  }%
  \if@ok%
    \place@subname{#2}%
  \else%
    \@error{Bad optional argument in \string\subname, page \thepage.^^J%
      If used, options locally over-ride global \string\subnamestyle.^^J%
       align=A, where A is one of c l r o i. Horizontal alignment.^^J%
       font=F, where F is one of main, sans,mono,alt,drama,deco. Font.^^J%
       scale=S, where S is a number 1-3. May be decimal.}%
  \fi%
  \endgroup%
  \@oktrue%
}
%%
\def\place@subname#1{%
  \def\temp@d{}%
  \ifthenelse{\equal{\s@num}{o}}{\def\temp@d{Numbers=ResetAll,Numbers=OldStyle}}{}%
  \ifthenelse{\equal{\s@num}{l}}{\def\temp@d{Numbers=ResetAll,Numbers=Lining}}{}%
  \def\tfe@t{ScaleAgain=\subname@scale,Ligatures=ResetAll,\temp@d}%
  \ifthenelse{\equal{\name@font}{main}}{\edef\temp@s{\addfontfeature{\tfe@t}#1}}{}%
  \ifthenelse{\equal{\name@font}{sans}}{\edef\temp@s{\sans{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{mono}}{\edef\temp@s{\mono{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{alt}}{\edef\temp@s{\alt{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{drama}}{\edef\temp@s{\drama{\addfontfeature{\tfe@t}#1}}}{}%
  \ifthenelse{\equal{\name@font}{deco}}{\edef\temp@s{\deco{\addfontfeature{\tfe@t}#1}}}{}%
  \strut\par%
  \ifthenelse{\equal{\subname@align}{l}}{%
    \strut\smash{\temp@s}\hfill\par}{}%
  \ifthenelse{\equal{\subname@align}{c}}{%
    {\centering\strut\smash{\temp@s}\par}}{}%
  \ifthenelse{\equal{\subname@align}{r}}{%
    \strut\hfill\smash{\temp@s}\par}{}%
  \ifthenelse{\equal{\subname@align}{o}}{%
    \ifodd\c@page%
      \strut\hfill\smash{\temp@s}\par%
    \else%
      \strut\smash{\temp@s}\hfill\par%
    \fi%
  }{}%
  \ifthenelse{\equal{\name@align}{i}}{%
    \ifodd\c@page%
      \strut\smash{\temp@s}\hfill\par%
    \else%
      \strut\hfill\smash{\temp@s}\par%
    \fi%
  }{}%
}
%%


%% TEXT STYLE (only in display pages)
\DeclareDocumentCommand\style{O{}m}{%
  \ifdisplay@page%
    \begingroup%
    \setlength\parindent{0pt}%
    \hyphenpenalty=20000%
    \StrDel{#1,}{ }[\temp@s]%
    \StrBehind{\temp@s}{align=}[\temp@s]%
    \StrBefore{\temp@s}{,}[\temp@s]%
    \StrLeft{\temp@s}{1}[\temp@s]%
    \ifthenelse{\equal{\temp@s}{}}{\def\temp@s{c}}{}%
    \def\nvt@alignchoice{:l:c:r:o:i:}%
    \IfSubStr{\nvt@alignchoice}{:\temp@s:}{}{%
      \ClassWarning{novelette}{Bad align in \string\style[align=A]{text}.^^J%
        A is one of: l c r o i^^J%
        Bad value ignored. Default c used. Page \thepage.}%
      \def\temp@s{c}%
    }
    \ifthenelse{\equal{\temp@s}{r}}{/strut/hfill{}}{}%
    \ifodd\c@page\ifthenelse{\equal{\temp@s}{o}}{/strut/hfill{}}{}\fi%
    \ifthenelse{\equal{\temp@s}{c}}{\centering}{}%
    \StrDel{#1,}{ }[\temp@s]%
    \StrBehind{\temp@s}{font=}[\temp@s]%
    \StrBefore{\temp@s}{,}[\temp@s]%
    \ifthenelse{\equal{\temp@s}{drama}}{\drama}{}%
    \ifthenelse{\equal{\temp@s}{deco}}{\deco}{}%
    \ifthenelse{\equal{\temp@s}{alt}}{\alt}{}%
    \StrDel{#1,}{ }[\temp@s]%
    \StrSubstitute{\temp@s}{Scale=}{scale=}[\temp@s]%
    \StrBehind{\temp@s}{scale=}[\temp@s]%
    \StrBefore{\temp@s}{,}[\temp@s]%
    \IfSubStr{\temp@s}{t}{\@oktrue}{\@okfalse}%
    \StrDel{\temp@s}{t}[\temp@s]%
    \IfDecimal{\temp@s}{%
      \addfontfeature{ScaleAgain=\temp@s}%
      \if@ok%
        \sbox0{3456789JÀÁÂÃÄÅÇçjfhlygpqþ}%
        \setlength\temp@l{\ht0+\dp0}%
        \setlength\baselineskip{1.05\temp@l}%
      \else%
        \setlength\baselineskip{\temp@s\le@ding}%
      \fi%
    }{%
     \ifthenelse{\equal{\temp@s}{}}{}{%
       \@error{Bad scale option, in \string\style[scale=S]{text}.^^J%
         S is integer|decimal number. May have suffix t (tight).}%
       }%
    }%
    {{\addfontfeature{Ligatures=ResetAll}#2}}\par%
    \StrDel{#1,}{ }[\temp@s]%
    \StrBehind{\temp@s}{align=}[\temp@s]%
    \StrBefore{\temp@s}{,}[\temp@s]%
    \ifthenelse{\equal{\temp@s}{l}}{/hfill/strut}{}%
    \ifodd\c@page\ifthenelse{\equal{\temp@s}{i}}{/hfill/strut}{}\fi%
    \ifthenelse{\equal{\temp@s}{c}}{\end{center}}{}%
    \endgroup%
  \else%
    \@error{\string\style\space command only allowed in display pages.}
  \fi%
}
%%


%% SCENE (following paragraph not indented)
% If you write text in \scene, it is slightly larger than main text,
% slightly condensed, and slightly loose tracking. This emulates using
% a font that was especially designed for the lsightly larger size.
\DeclareDocumentCommand\scene{m}{% Empty, hyphen, asterisk, text.
  \ifvmode\else\par\fi%
  \@okfalse%
  \StrDel{#1}{ }[\temp@s]%
  \ifthenelse{\equal{\temp@s}{}}{\@oktrue\null}{}%
  \ifthenelse{\equal{\temp@s}{-}}{%
    \@oktrue{\centering\strut\rule[.5\x@ht]{.25\textwidth}{.5pt}\par}%
  }{}%
  \ifthenelse{\equal{\temp@s}{*}}{%
    \@oktrue\sbox0{*}%
    \setlength\temp@l{1.1\x@ht-1.2\ht0}%
    \def\temp@d{\addfontfeature{Scale=1.2}*\hspace{30pt}*\hspace{30pt}*}%
    \strut\hfil\smash{\raisebox{\temp@l}{{\temp@d}}}\hfil\par%
  }{}%
  \if@ok\else%
    \def\temp@d{#1}%
    \null\noindent\strut\smash{\raisebox{.25\le@ding}{%
      \IfBeginWith{#1}{-}{%
        \makebox[\normalindent][l]{\rule[.52\x@ht]{.84\normalindent}{.5pt}}%
        \StrGobbleLeft{#1}{1}[\temp@d]%
      }{}%
      \IfBeginWith{#1}{+}{%
        \makebox[\normalindent][l]{\rule[.52\X@ht]{.84\normalindent}{.5pt}}%
        \StrGobbleLeft{#1}{1}[\temp@d]%
      }{}%
      {\addfontfeature{ScaleAgain=1.16,FakeStretch=.94,LetterSpace=2}\temp@d}%
    }}\par%
  \fi%
  \NoIndentAfterThis%
}
%%



%%
\endinput
%%
%% End of file `novelette-opening.sty'.
