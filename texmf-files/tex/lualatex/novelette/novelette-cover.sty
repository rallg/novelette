%% This is file `novelette-cover.sty', part of `novelette' document class.
%% Copyright 2024 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%% License URL: https://www.latex-project.org/lppl/lppl-1-3c.txt
%% A copy of this license is distributed with LaTeX 2008+.
%%
\ProvidesFile{novelette-cover.sty}%
[2024/01/06 v0.30 LaTeX file (Process cover art).]
%%

%% File novelette.cls calls this file, only when processing cover.

%% To produce a color cover as PDF/X, in CMYK color space, you must
%% pre-process the artwork using script `cmyk4nvt'. It is in the doc folder.

%% You may choose \intent, but there is no point to choosing \mode. If compile
%% succeeds without problem, the result is final. Otherwise draft.

%%%
\def\process@cover{%
  \renewcommand\normalsize{\@setfontsize\normalsize{12pt}{16pt}} % Unused.
  \normalsize
  \ifdefined\@intent\else\gdef\@intent{SWOP}\fi
  \ifdefined\cover@intent\xdef\@intent{\cover@intent}\fi
  \ifdefined\cover@title
    \xdef\@title{\cover@title}
  \else
    \xdef\@title{COVER FOR \@title}
  \fi
  \ifdefined\cover@author\xdef\@author{\cover@author}\fi
  \directlua{require("novelette-pdftc")}
  \gdef\nvt@filesize#1{%
    \directlua{novelette.pdftc.filesize("\luaescapestring{#1}")}%
  }
  \long\gdef\nvt@mdfivesum#1{%
    \directlua{novelette.pdftc.mdfivesum("\luaescapestring{#1}", "byte")}%
  }%
  \IfFileExists{\cover@image}{
    \validate@cover@image{\cover@image}
  }{
    \fatal@err{Did not find the requested cover image file.^^J%
      Must be *jpg. Must be in same folder as main document, or subfolder^^J%
      relative to main document.}%
  }
  \@addtofilelist{\cover@image}%
  \ProvidesFile{\cover@image}[jpg image]%
  \saveimageresource attr{/Interpolate true } cropbox {\cover@image}%
  \sbox\image@box{\useimageresource\the\lastsavedimageresourceindex}%
  \global\deflength\pagewidth{\wd\image@box}
  \global\deflength\pageheight{\ht\image@box}
  \global\deflength\topmargin{-1in}
  \global\deflength\oddsidemargin{-1in}
  \global\deflength\parindent{0pt}
  \global\deflength\textwidth{\pagewidth}
  \global\deflength\textheight{\pageheight}
  \sanity@check
}
%%%


%%% Sanity check. Image size, covertrim, and trimsize must be related.
\def\sanity@check{
  \setlength\temp@l{3mm+\trim@w+2mm+\trim@w+3mm} % Narrow spine.
  \ifthenelse{\dimtest{\wd\image@box}{<}{\temp@l}}{%
    \nvt@err{Width of cover image is too small}%
     {Cover image includes front, back, spine, bleed.^^J%
      Even the thinnest book has cover image width more than twice^^J%
      the width of interior pages. Your cover image width is not enough.^^J%
      Caution: Novelette does not know what the actual width should be.}%
  }{}
  \setlength\temp@l{3mm+\trim@w+50mm+\trim@w+3mm} % War and Peace?
  \ifthenelse{\dimtest{\wd\image@box}{>}{\temp@l}}{%
    \nvt@err{Width of cover image is too large}%
      {Cover image includes front, back, spine, bleed.^^J%
       So, the cover image width is more than 2x width of interior pages.^^J%
       But you provided a cover image that is so wide, only a massive book^^J%
       would fit it. Even `War and Peace' would be smaller.^^J%
       Caution: Novelette does not know what the actual width should be.}%
  }{}%
}
%%%

%%% Validate Cover Image (necessary for PDF/X conformance).
\def\validate@cover@image#1{%
  \setcounter{temp@count}{7654321}%
  \addtocounter{temp@count}{\nvt@filesize{#1}}%
  \def\temp@n{%
    \directlua{
      img1=img.scan{filename="#1"}
      tex.print(img1.xsize)
    }%
  }%
  \IfInteger{\temp@n}{\addtocounter{temp@count}{\temp@n}}{}%
  \def\temp@d{%
    \directlua{
      img1=img.scan{filename="#1"}
      tex.print(img1.ysize)
    }%
  }%
  \IfInteger{\temp@d}{\addtocounter{temp@count}{\temp@d}}{}%
  \def\temp@s{-nvtc\arabic{temp@count}.}%
  \IfSubStr{#1}{\temp@s}{%
    \typeout{Cover image passed validation.}%
    \xdef\cover@size{width=\temp@n, height=\temp@d, pixels @300 pixels/in.}%
  }{%
    \nvt@err{Cover image did not pass validation}%
      {Unless \string\intent{none}, the cover image^^J%
       must be pre-processed by script `cmyk4nvt'. That creates^^J%
       another image with an encoded file name. This test failed^^J%
       because the encoded name did not agree with the image properties.}%
    \gdef\cover@size{unknown}%
  }%
}
%%%

%%% Process user settings, set defaults, calculate page layout:
\AtEndPreamble{
  \LetLtxMacro\RequirePackage\get@package\relax
  \LetLtxMacro\usepackage\get@package\relax
  \ifthenelse{\dimtest{\trim@w}{=}{0pt}\OR\dimtest{\trim@h}{=}{0pt}}{
    \fatal@err{For cover, you must specify \string\trimsize{w=W,h=H}^^J%
      identical to the trimsize of book interior pages.}%
  }{}
  \ifthenelse{\dimtest{\covertrim@w}{=}{0pt}\OR\dimtest{\covertrim@h}{=}{0pt}}{
    \fatal@err{\string\covertrim\space was not set.^^J%
      The covertrim is the size of the finished cover, including^^J%
      back, spine, and front, after surrounding bleed has been cut off.^^J%
      It is less than the full size of the cover artwork, which includes^^J%
      bleed area on all four sides.^^J%
      In Preamble: \string\covertrim{w=W,h=H}^^J%
      \space\space W = Finished cover (units in|mm).^^J%
      \space\space H = Finished height (units in|mm).^^J%
      Example: \string\covertrim{w=11.87in,h=8.5in}}%
  }{}
  \ifdimcomp{\covertrim@h}{=}{\trim@h}{}{%
    \nvt@err{Heights of covertrim and trimsize are unequal}%
      {Print-on-demand softcover technology requires that^^J%
       (trimmed cover image height) = (trimmed interior page height).^^J%
       But they are set to different values.}%
  }
  \@oktrue
  \setlength\temp@l{2\trim@w+.15in} % A very thin book!
  \ifdimcomp{\covertrim@w}{<}{\temp@l}{\@okfalse}{}
  \setlength\temp@l{2\trim@w+2in} % War and Peace?
  \ifdimcomp{\covertrim@w}{>}{\temp@l}{\@okfalse}{}
  \if@ok\else
    \nvt@err{Unusually small or large covertrim width}%
      {The covertrim width must exceed 2x interior trimsize^^J%
      width by >=0.15in, but <=2in, for very thin or thick books.^^J%
      Typical popular fiction has covertrim width = 2x bookwidth + S,^^J%
      where spine width S is 0.4in to 1.0in.}%
  \fi
  \process@cover
  \RequirePackage{novelette-metadata}
  \process@metadata
  \process@pdfboxes
}
%%%

%%% Finish the setup.
\AtBeginDocument{\pagestyle{empty}}
%%%

%%%
\AfterEndPreamble{% Write the image, and ignore anything in document body.
  \usebox{\image@box}%
  \clearpage%
  \end{document}%
}
%%%

%%% Runs at \end{document}. Document is still writeable here:
\AtEndDocument{
  \pdfextension info{%
    /CreationDate(\pdffeedback creationdate) % Needs space percent.
    /ModDate(\pdffeedback creationdate) % Needs space percent.
  }
  \iferrorsissued{\global\b@dtrue}{}
  \ifthenelse{\equal{\@title}{Untitled Document}}{\global\b@dtrue}{}
  \ifthenelse{\equal{\@author}{Anonymous Author}}{\global\b@dtrue}{}
  \gdef\mode@tail{} \gdef\intent@tail{}
  \ifb@d
    \gdef\@mode{draft}
    \gdef\@intent{none}
    \gdef\intent@tail{(due to compile error)}
    \gdef\mode@tail{(no final mode when error)}
    \gdef\mod@xmplabel{DRAFT COVER }
  \fi
  \attach@metadata
  \attach@xmp
  \ifthenelse{\equal{\@intent}{none}}{}{\attach@intent}
}
%%%

%% Log final messages and summary:
\AfterEndDocument{}
\def\redefinethisstuff{ %%%%%
  \typeout{^^J}
  \typeout{*******************************************************************}
  \typeout{SUMMARY FOR COVER OF JOBNAME \jobname}%
  \typeout{*******************************************************************}
  \typeout{These are the actual values used. If different from your settings,}
  \typeout{it means Novelette used defaults, or needed to over-ride yours:}
  \typeout{Document class option [cover].}
  \typeout{\string\title{\@title}}
  \typeout{\string\author{\@author}}
  \ifthenelse{\equal{\@mode}{draft}}{
    \typeout{PDF is not final, due to compile error.}
  }{}
  \typeout{\string\intent{\@intent}}
  \typeout{\string\coverimage{\cover@image}}
  \typeout{\string\covertrim{\cover@trim} (final, after trimming bleed area)}
  \typeout{Book title: \@title}
  \typeout{Book author: \@author}
  \typeout{Book interior page size: \trim@size}
  \typeout{Image size: \cover@size}
  \typeout{Document Class novelette v0.\class@ver. Processed by lualatex.}
  \ifb@d
    \typeout{!!!!! ERROR OR CRITICAL WARNING. OUTPUT IS INVALID. !!!!!}
  \fi
  \typeout{*******************************************************************}
  \typeout{^^J}
}
%%%


%%
\endinput
%%
%% End of file `novelette-cover.sty'.
