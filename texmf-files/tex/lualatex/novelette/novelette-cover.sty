%% This is file `novelette-cover.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%% License URL: https://www.latex-project.org/lppl/lppl-1-3c.txt
%% A copy of this license is distributed with LaTeX 2008+.
%%
\ProvidesFile{novelette-cover.sty}%
[2023/09/13 v0.13 LaTeX file (Process cover art).]
%%


%% File novelette.cls calls this file, only when processing cover.


%%
\def\process@cover{%
  \renewcommand\normalsize{\@setfontsize\normalsize{12pt}{16pt}}
  \normalsize
  \ifdefined\@intent\else\gdef\@intent{SWOP}\fi
  \ifdefined\cover@intent\xdef\@intent{\cover@intent}\fi
  \ifdefined\cover@title
    \xdef\nvt@title{\cover@title}
  \else
    \xdef\nvt@title{COVER FOR \nvt@title}
  \fi
  \ifdefined\cover@author\xdef\nvt@author{\cover@author}\fi
  \IfFileExists{\cover@image}{
    \validate@cover@image{\cover@image}
  }{
    \nvt@fatal@error{Did not find the requested cover image file.}
  }
  \@addtofilelist{\cover@image}%
  \ProvidesFile{\cover@image}[jpg image]%
  \saveimageresource attr{/Interpolate true } cropbox {\cover@image}%
  \sbox\image@box{\useimageresource\the\lastsavedimageresourceindex}%
  \global\deflength\pagewidth{\wd\image@box}
  \global\deflength\pageheight{\ht\image@box}
  \global\deflength\topmargin{-1in}
  \global\deflength\oddsidemargin{-1in}
  \global\deflength\parindent{0pt}
  \global\deflength\textwidth{\pagewidth}
  \global\deflength\textheight{\pageheight}
  \nvt@sanity@check
}
%%


%% Sanity check. Image size, covertrim, and booksize must be related.
\def\nvt@sanity@check{
  \setlength\temp@l{3mm+\book@w+2mm+\book@w+3mm} % Narrow spine.
  \ifthenelse{\dimtest{\wd\image@box}{<}{\temp@l}}{
    \@error{Width of cover image seems too small for the book.^^J%
      See Novelette docs for how this is measured.}
  }{}
  \setlength\temp@l{3mm+\book@w+50mm+\book@w+3mm} % War and Peace?
  \ifthenelse{\dimtest{\wd\image@box}{>}{\temp@l}}{
    \@error{Width of cover image seems too large for the book.^^J%
      See Novelette docs for how this is measured.}
  }{}
}
%%


%% Validate Cover Image (necessary for PDF/X conformance).
\def\validate@cover@image#1{%
  \setcounter{nvt@count}{7654321}%
  \addtocounter{nvt@count}{\pdf@filesize{#1}}%
  \def\temp@n{%
    \directlua{
      img1=img.scan{filename="#1"}
      tex.print(img1.xsize)
    }%
  }%
  \IfInteger{\temp@n}{\addtocounter{nvt@count}{\temp@n}}{}%
  \def\temp@d{%
    \directlua{
      img1=img.scan{filename="#1"}
      tex.print(img1.ysize)
    }%
  }%
  \IfInteger{\temp@d}{\addtocounter{nvt@count}{\temp@d}}{}%
  \def\temp@s{-nvtc\arabic{nvt@count}.}%
  \IfSubStr{#1}{\temp@s}{%
    \typeout{Cover image passed validation.}%
    \xdef\cover@size{width=\temp@n, height=\temp@d, pixels @300 pixels/in.}%
  }{%
    \@error{Image #1 did not pass validation.^^J%
      Unless intent is none, the cover image^^J%
      must be pre-processed by script "cmyk4nvt". That creates^^J%
      another image with an encoded file name. This test failed^^J%
      because the encoded name did not agree with the image properties.}%
    \gdef\cover@size{unknown, because PDF is not a good cover}%
  }%
}
%%


%% Process user settings, set defaults, calculate page layout:
\AtEndPreamble{
  \LetLtxMacro\RequirePackage\nvt@get@package\relax
  \LetLtxMacro\usepackage\nvt@get@package\relax
  \ifdefined\book@size\else
    \nvt@fatal@error{\string\booksize\space was not set.^^J%
      The booksize, known to print services as "trim size",^^J%
      is the finished width and height of interior book pages.^^J%
      Novelette does not use a default setting for booksize.^^J%
      In Preamble: \string\booksize{w=W,h=H}^^J%
      \space\space W = Interior page width (units in|mm).^^J%
      \space\space H = Interior page height (units in|mm).^^J%
      Example: \string\booksize{w=5.5in,h=8.5in}^^J%
      If creating a cover, its booksize must be set to the same as^^J%
      interior page booksize. The coversize is a different setting.}
  \fi
  \@oktrue
  \ifdimcomp{\covertrim@w}{=}{0pt}{\@okfalse}{}
  \ifdimcomp{\covertrim@h}{=}{0pt}{\@okfalse}{}
  \if@ok\else
    \nvt@fatal@error{\string\covertrim\space was not set.^^J%
      The covertrim is the size of the finished cover, including^^J%
      back, spine, and front, after surrounding bleed has been cut off.^^J%
      It is less than the full size of the cover artwork, which includes^^J%
      bleed area on all four sides.^^J%
      In Preamble: \string\covertrim{w=W,h=H}^^J%
      \space\space W = Finished cover (units in|mm).^^J%
      \space\space H = Finished height (units in|mm).^^J%
      Example: \string\covertrim{w=11.87in,h=8.5in}}
  \fi
  \ifdimcomp{\covertrim@h}{=}{\book@h}{}{
    \@error{The covertrim height does not match the booksize height.^^J%
      These must have the same size.}
  }
  \@oktrue
  \setlength\temp@l{2\book@w+.15in} % A very thin book!
  \ifdimcomp{\covertrim@w}{<}{\temp@l}{\@okfalse}{}
  \setlength\temp@l{2\book@w+2in} % War and Peace?
  \ifdimcomp{\covertrim@w}{>}{\temp@l}{\@okfalse}{}
  \if@ok\else
    \@error{Unusually small or large covertrim width.^^J%
      The covertrim width must exceed 2x book width by at least 0.15in,^^J%
      but not more than 2in, for very thin and very thick books.^^J%
      Typical popular fiction has covertrim width = 2x bookwidth + S,^^J%
      where spine width S is 0.4in to 1.0in.}
  \fi
  \process@cover
  \RequirePackage{novelette-metadata}
  \process@metadata
  \process@pdfboxes
}
%%


%% Finish the setup.
\AtBeginDocument{\pagestyle{empty}}
%%


%%
\AfterEndPreamble{% Write the image, and ignore anything in document body.
  \usebox{\image@box}%
  \clearpage%
  \end{document}%
}
%%


%% Runs at \end{document}. Document is still writeable here:
\AtEndDocument{
  \pdfinfo{%
    /CreationDate(\pdffeedback creationdate) % Needs space percent.
    /ModDate(\pdffeedback creationdate) % Needs space percent.
  }
  \iferrorsissued{\global\b@dtrue}{}
  \ifthenelse{\equal{\nvt@title}{Untitled Document}}{\global\b@dtrue}{}
  \ifthenelse{\equal{\nvt@author}{Anonymous Author}}{\global\b@dtrue}{}
  \ifb@d
    \gdef\@mode{draft}
    \gdef\@intent{none}
    \gdef\log@intent{\string\intent{none} (due to compile error).}
    \gdef\log@mode{\string\mode{draft} (no final mode when error).}
    \gdef\mod@xmplabel{DRAFT COVER }
  \fi
  \attach@metadata
  \attach@xmp
  \ifthenelse{\equal{\@intent}{none}}{}{\attach@intent}
}
%%


%% Log final messages and summary:
\AfterEndDocument{
  \typeout{^^J}
  \typeout{*******************************************************************}
  \typeout{SUMMARY FOR COVER OF JOBNAME \jobname}%
  \typeout{*******************************************************************}
  \typeout{These are the actual values used. If different from your settings,}
  \typeout{it means Novelette used defaults, or needed to over-ride yours:}
  \typeout{Document class option [cover].}
  \typeout{\string\title{\nvt@title}}
  \typeout{\string\author{\nvt@author}}
  \ifthenelse{\equal{\@mode}{draft}}{
    \typeout{PDF is not final, due to compile error.}
  }{}
  \typeout{\string\intent{\@intent}}
  \typeout{\string\coverimage{\cover@image}}
  \typeout{\string\covertrim{\cover@trim} (final, after trimming bleed area)}
  \typeout{Book title: \@title}
  \typeout{Book author: \@author}
  \typeout{Book interior page size: \book@size}
  \typeout{Image size: \cover@size}
  \typeout{Document Class novelette v0.\class@ver. Processed by lualatex.}
  \ifb@d
    \typeout{!!!!! ERROR OR CRITICAL WARNING. OUTPUT IS INVALID. !!!!!}
  \fi
  \typeout{*******************************************************************}
  \typeout{^^J}
}
%%


%%
\endinput
%%
%% End of file `novelette-cover.sty'.
