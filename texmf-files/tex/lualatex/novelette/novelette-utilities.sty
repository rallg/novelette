%% This is file `novelette-utilities.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-utilities.sty}%
[2023/10/26 v0.21 LaTeX file (user macros in document body).]
%%


%% This file is loaded AtBeginDocument when processing interior (not cover).


\def\br{\\} % Alternative break.

\def\fillertext{%
  \ifthenelse{\equal{\@mode}{final}}{\unskip}{\input{novelette-filler.tex}}
}

\ifdefined\okina\else
  \def\okina{\uni{02BB}}
\fi


\ifthenelse{\equal{\@mode}{dev}}{
  \def\up@feeler#1{{\gr@y{.5}\rule{4pt}{#1}}\kern-4pt}
  \def\dn@feeler#1{{\gr@y{.7}\rule[-#1]{4pt}{#1}}\kern-4pt}
}{
  \def\up@feeler#1{\rule{0pt}{#1}}
  \def\dn@feeler#1{\rule[-#1]{0pt}{#1}}
}


%% Unicode character. Four hex digits, uppercase A-F, no following space.
% Examples: c\uni{0061}t -> cat  d\uni{006F}g -> dog
\def\uni#1{{\addfontfeature{Ligatures=ResetAll}\char"#1}\obeyspaces}
%%


%% Prevent usage of Color=, Opacity=, Scale=, and whatnot:
\def\check@feat#1{%
  \IfSubStr{#1}{=}{%
    \@okfalse%
    \@error{Bad value for \string\feat{} on page \thepage.^^J%
      Features are a comma-separated list of OpenType feature codes.^^J%
      Each code is 4 alphanumeric characters. Examples: lnum cv04.^^J%
      You may precede a code with - to indicate removal of that feature.^^J%
      Special code mupc matches uppercase, instead of default lowercase.^^J%
      Although package `fontspec' allows other settings, Novelette does not.}
  }{\@oktrue}%
}
%%


%% FRONTMATTER, MAINMATTER
\newif\iffront@matter \newif\ifmain@matter
\def\frontmatter{%
  \ifmain@matter%
  \@error{Cannot use \string\frontmatter\space after \string\mainmatter.}%
  \else%
    \pagenumbering{roman}%
    \pagestyle{empty}%
    \global\front@mattertrue%
  \fi%
}
\def\mainmatter{ % Resets page to 1, arabic numbers.
  \ifmain@matter\else%
    \cleartorecto%
    \pagenumbering{arabic}%
    \setcounter{page}{1}%
    \pagestyle{\main@pagestyle}%
    \gdef\verso@head{\allsmcp{\thetitle}}%
    \gdef\recto@head{\textit{\theauthor}}%
  \fi%
  \global\front@matterfalse%
  \global\main@mattertrue%
}
\def\backmatter{% Usually not used.
  \cleartorecto%
  \gdef\verso@head{}%
  \gdef\recto@head{}%
}
%%


%% \stake does not occupy much vertical space.
\gdef\stake{\rule{0pt}{.02pt}}
%%


%% Steal a sheep.
\def\baa{\looseness=-1}
%%


%% Catalan punt volat:
\def\L#1#2{\ifthenelse{\equal{#1}{.}\AND\equal{#2}{L}}{L·L}{L#1#2}}
\def\l#1#2{\ifthenelse{\equal{#1}{.}\AND\equal{#2}{l}}{l·l}{l#1#2}}
%%


%% Add or remove an OpenType feature by its code:
\DeclareDocumentCommand\feat{mm}{%
  \ifthenelse{\equal{#1}{}}{%
    {#2\obeyspaces}%
  }{%
    \StrDel{#1}{ }[\temp@s]%
    \check@feat{\temp@s}%
    \if@ok%
      \IfSubStr{\temp@s}{-mupc}{%
        \StrDel{\temp@s}{-mupc}[\temp@s]%
        \def\temp@n{Scale=MatchLowercase}%
      }{%
        \def\temp@n{}%
      }%
      \IfSubStr{\temp@s}{mupc}{%
        \StrDel{\temp@s}{mupc}[\temp@s]%
        \def\temp@n{Scale=MatchUppercase}%
      }{%
        {\addfontfeature{RawFeature={\temp@s},\temp@n}#2\obeyspaces}%
      }%
    \else%
      {#2\obeyspaces}%
    \fi%
  }%
}
%%


%% ITALICS (better than \textit or \itshape)
\long\def\ital#1{{\itshape #1\/}}
\long\def\textit#1{{\itshape #1\/}}
%%


%% BLOCK INDENT (option is integer number of \normalindent, [L,R])
\def\t@bindent{0}
\newenvironment{blockindent}[1][1]{%
  \ifvmode\else\par\fi%
  \begingroup%
  \StrDel{#1}{ }[\temp@s]%
  \StrDel{\temp@s}{:}[\temp@s]%
  \StrSubstitute{\temp@s}{,}{:}[\temp@s]%
  \@oktrue%
  \edef\temp@d{\fpeval{\textwidth / \normalindent}}%
  \IfInteger{\temp@s}{
    \comp@re{\temp@s<\temp@d}{%
      \setlength\leftskip{\temp@s\normalindent}%
      \xdef\t@bindent{\temp@s}%
    }{\@okfalse}%
  }{%
    \StrBefore{\temp@s}{:}[\temp@n]%
    \IfInteger{\temp@n}{%
      \comp@re{\temp@n<\temp@d}{%
        \setlength\leftskip{\temp@n\normalindent}%
        \xdef\t@bindent{\temp@n}%
      }{\@okfalse}%
    }{\@okfalse}%
    \StrBehind{\temp@s}{:}[\temp@n]%
    \IfInteger{\temp@n}{%
      \comp@re{\temp@n<\temp@d}{%
        \setlength\rightskip{\temp@n\normalindent}%
      }{\@okfalse}%
    }{\@okfalse}%
  }%
  \setlength\temp@l{\leftskip+\rightskip+4\normalindent}%
  \ifdimcomp{\temp@l}{>}{\textwidth}{\@okfalse}{}%
  \if@ok\else%
    \@error{Bad option for \string\begin{blockindent}[option].^^J%
      Format: \string\begin{blockindent}[L,R]^^J%
      L is integer >=0. Left indent, multiple of normal paragraph indent.^^J%
      R is integer >=0. Right indent, multiple of normal paragraph indent.^^J%
      May use L alone, for only left indent.^^J%
      Remaining block width must be at least 4 normal indents.}%
  \fi%
}{%
  \ifvmode\else\par\fi%
  \endgroup%
  \gdef\t@bindent{0}%
}
%%


%% TABLINE
\DeclareDocumentCommand\tabline{sO{}mm}{%
  \noindent%
  \begingroup%
  \setlength\leftskip{0pt}%
  \noindent\strut%
  \ifthenelse{\equal{\t@bindent}{0}}{}{%
    \makebox[\t@bindent\normalindent][r]{#2\,}%
  }%
  {#3}%
  \IfBooleanTF{#1}{%
    \space\leaders\hbox{.\,}\hfill%
  }{%
    \hfill%
  }%
  {#4}\strut\par%
  \endgroup%
}
%%


%% \cleartorecto works same as \clearpage when next page is recto.
%   If next page would be verso, a blank verso is inserted,
%   so that the following material is recto.
\newcommand\cleartorecto{
  \clearpage
  \ifodd\c@page\else
    \thispagestyle{empty}\null\clearpage
  \fi
}
%%


%% BLANK PAGE
\def\blankpage{%
  \clearpage%
  \thispagestyle{empty}%
  \null%
  \clearpage%
}
%%


%% The following \def fails if directly written into \AtBeginDocument.
% OK if loaded using \RequirePackage. Mystery TeX.
\newcounter{dbl@qq} % Counts use of straight double quotes in document body.
\catcode`\"=13
\def"{”\stepcounter{dbl@qq}}
%%


%% COPYRIGHT PAGE
% You may create your own copyright page (as a display page) without using
% this method. However, it is a very good idea to use this, as it configures
% things the way that a copyright page should have them.
\newenvironment{copyrightpage}[1][]{%
  \clearpage%
  \thispagestyle{empty}%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \null\vspace*{-\le@ding}%
  \begingroup%
  \display@pagetrue%
  \zm@rktrue%
  \setlength\parindent{0pt}%
  \setlength\parskip{\le@ding}%
  \hyphenpenalty=10000%
  \exhyphenpenalty=10000%
  \catcode`\"=12%
  \addfontfeature{Ligatures=ResetAll,RawFeature={-tlig,-onum,lnum}}%
  \vfill%
  \StrDel{#1,}{ }[\temp@s]%
  \StrSubstitute{\temp@s}{sides}{side}[\temp@n]%
  \StrBehind{\temp@n}{side=}[\temp@n]%
  \StrBefore{\temp@n}{,}[\temp@n]%
  \IfInteger{\temp@n}{%
    \def\using@side{t}%
    \begin{blockindent}[\temp@n,\temp@n]%
  }{%
    \IfNadaTF{\temp@n}{}{%
      \@error{\string\begin{copyrightpage}[side=I] must use integer I.}%
    }%
  }%
  \IfSubStr{#1}{center}{\def\using@center{t}\begin{center}}{\raggedright}%
}{% End the environment:
  \ifdefined\using@center\end{center}\fi%
  \ifdefined\using@side\end{blockindent}\fi%
  \endgroup%
}
\AfterEndEnvironment{copyrightpage}{\clearpage}
%%



%%
\endinput
%%
%% End of file `novelette-utilities.sty'.
