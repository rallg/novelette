%% This is file `novelette-utilities.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-utilities.sty}%
[2023/12/15 v0.25 LaTeX file (user macros in document body).]
%%


%% This file is loaded AtBeginDocument when processing interior (not cover).


\def\br{\\} % Alternative break.

\xdef\this@page{\thepage}

%% Get current line number. Must precede any other line content.
%% In some cases, precede with \ifvmode\else\par\fi.
\def\current@line{1}
\def\getcurrent@line{%
  \edef\current@line{%
    \fpeval{1+\lines@pp-round((\pagegoal-\pagetotal)/\@leading,0)}}%
  \comp@re{\current@line<1}{\gdef\current@line{1}}{}%
  \comp@re{\current@line>200}{\gdef\current@line{1}}{}%
  \comp@re{\current@line>\lines@pp}{%
    \edef\current@line{\fpeval{\current@line-\lines@pp}}}{}%
}
%%

%% Should \image[float=f] pages have header/footer? You decide.
%  You many change this throughout the document. And change applies to the
%  next \image and and subsequent \image, until changed again.
%%
\def\float@style{normal} % Default. But no floats in frontmatter.
\newcommand\floatstyle[1]{%
  \StrDel{#1}{ }[\temp@s]%
  \case@test{\temp@s}%
  \c@se{}{\gdef\float@style{normal}}%
  \c@se{normal}{\gdef\float@style{normal}}%
  \c@se{plain}{\gdef\float@style{plain}}%
  \c@se{empty}{\gdef\float@style{empty}}%
  \ifcase@match\else%
    \@lert{Bad choice for \string\floatpage, page \this@page. Ignored.}%
  \fi%
}
%%





% stemwidth kern.
\newlength\stem@width
\setlength\stem@width{.075em}
\def\sk#1{\begingroup\setlength\stem@width{.08em}\kern#1\stem@width\endgroup}


\def\fillertext{%
  \ifthenelse{\equal{\@mode}{final}}{\unskip}{\input{novelette-filler.tex}}
}

\ifdefined\okina\else
  \def\okina{\uni{02BB}}
\fi


\ifthenelse{\equal{\@mode}{dev}}{
  \def\up@feeler#1{{\gr@y{.5}\rule{4pt}{#1}}\kern-4pt}
  \def\dn@feeler#1{{\gr@y{.7}\rule[-#1]{4pt}{#1}}\kern-4pt}
}{
  \def\up@feeler#1{\rule{0pt}{#1}}
  \def\dn@feeler#1{\rule[-#1]{0pt}{#1}}
}


%% Unicode character. Four hex digits, uppercase A-F, no following space.
% Examples: c\uni{0061}t -> cat  d\uni{006F}g -> dog
\def\uni#1{\strut{\addfontfeature{Ligatures=ResetAll}\char"#1}\obeyspaces}
%%


%% FRONTMATTER, MAINMATTER
\newif\iffront@matter \newif\ifmain@matter
\def\frontmatter{%
  \ifmain@matter%
    \std@error{f}%
  \else%
    \ifRF@enabled%
      \pagenumbering{Roman}%
    \else%
      \pagenumbering{roman}%
    \fi%
    \pagestyle{empty}%
    \global\front@mattertrue%
    \setcounter{bookmatter}{1}%
  \fi%
}
\def\mainmatter{ % Resets page to 1, arabic numbers.
  \ifmain@matter\else%
    \cleartorecto%
    \pagenumbering{arabic}%
    \setcounter{page}{1}%
    \pagestyle{normal}%
    \gdef\verso@head{\allsmcp{\thetitle}}%
    \gdef\recto@head{\textit{\theauthor}}%
  \fi%
  \global\front@matterfalse%
  \global\main@mattertrue%
  \setcounter{bookmatter}{2}%
}
\def\backmatter{% Usually not used. Does not reset page count or numeral style.
  \cleartorecto%
  \gdef\verso@head{}%
  \gdef\recto@head{}%
}
%%


%% \stake does not occupy much vertical space.
\gdef\stake{\rule{0pt}{.02pt}}
%%


%% Catalan punt volat:
\def\L#1#2{\ifthenelse{\equal{#1}{.}\AND\equal{#2}{L}}{L·L}{L#1#2}}
\def\l#1#2{\ifthenelse{\equal{#1}{.}\AND\equal{#2}{l}}{l·l}{l#1#2}}
%%


%% ITALICS (better than \textit or \itshape)
\long\def\ital#1{{\itshape #1\/}}
\long\def\textit#1{{\itshape #1\/}}
%%


%% BLOCK INDENT (option is integer number of \p@rindent, [L,R])
\newenvironment{blockindent}[1][1]{%
  \ifvmode\else\par\fi%
  \begingroup%
  \StrDel{#1}{ }[\temp@s]%
  \@oktrue%
  \StrBefore{\temp@s}{,}[\temp@n]%
  \IfNada{\temp@n}{%
    \setlength\leftskip{\p@rindent}%
  }{%
    \IfDecimal{\temp@n}{%
      \setlength\leftskip{\temp@n\p@rindent}%
    }{\@okfalse\setlength\leftskip{\p@rindent}}%
  }%
  \StrBehind{\temp@s}{,}[\temp@n]%
  \IfNada{\temp@n}{%
    \setlength\rightskip{0pt}%
  }{%
    \IfDecimal{\temp@n}{%
      \setlength\rightskip{\temp@n\p@rindent}%
    }{\@okfalse\setlength\rightskip{0pt}}%
  }%
  \setlength\temp@l{\textwidth-\leftskip-\rightskip}%
  \comp@re{\temp@l<.4*\textwidth}{\@okfalse}{}%
  \if@ok\else\std@error{g}\fi%
}{%
  \ifvmode\else\par\fi%
  \endgroup%
}
%%


%% \cleartorecto works same as \clearpage when next page is recto.
%   If next page would be verso, a blank verso is inserted,
%   so that the following material is recto.
\newcommand\cleartorecto{
  \clearpage
  \ifodd\c@page\else
    \thispagestyle{empty}\null\clearpage
  \fi
}
%%


%% BLANK PAGE
\def\blankpage{%
  \clearpage%
  \thispagestyle{empty}%
  \null%
  \clearpage%
}
%%


%% The following \def fails if directly written into \AtBeginDocument.
% OK if loaded using \RequirePackage. Mystery TeX.
\newcounter{dbl@qq} % Counts use of straight double quotes in document body.
\catcode`\"=13
\def"{”\stepcounter{dbl@qq}}
%%


%%% SCENE (following paragraph not indented)
%   This command is one way to break a chapter into separate scenes.
% First line after \scene is not indented. Although you may use \init there,
% avoid \init if \scene is not empty, due to visual clash.
% \scene or \scene{} -> two-line empty gap.
% \scene* or \scene{*} -> two-line gap, with three spaced, centered asterisks.
% \scene- or \scene{-} -> two-line gap, with centered short horizontal line. 
% \scene{text} -> two-line gap, with text (scene title), using \scenestyle.
%   The text is raised above the second baseline, so it is off-grid.
% Special cases, if a two-line gap would be split across pages:
%   A. \scene* or \scene- place the asterisks or line at bottom of first page,
%      centered at x-height. Next page starts at top (no blank line).
%   B. Empty \scene acts like \scene- would act.
%   C. \scene{text} leaves empty line at bottom of first page, carries text
%      (with some space above it) to next page.
% Special cases, when the scene is too close to top or bottom of page:
%   D. If no main text follows \scene, \scene*, or \scene- on same page,
%      then no problem. Likewise if no main text precedes it on same page.
%   E. If only one line of main text precedes or follows \scene, \scene*,
%      or \scene- on same page, then an alert is issued.
%   F. If \scene{text} is at top of its page, no problem.
%   G. If \scene{text} is at bottom of its page, then an alert is issued.
%   H. If only one line of main text precedes or follows \scene{text}
%      on same page, then an alert is issued.
% Missing brace detection, thanks to egreg, tex.stackexchange.com q.409760.
\newcommand\scene{\@ifnextchar\bgroup{\scene@text}{\scene@notext}}
\def\scene@notext{\@ifnextchar*{\scene@asterisks}{\scene@marker}}
\def\scene@marker{\@ifnextchar-{\scene@line}{\scene@empty}}
%
\def\scene@empty{%
  \ifvmode\else\par\fi%
  \getcurrent@line%
  \begingroup\setlength\parindent{0pt}%
  \comp@re{\current@line=\lines@pp}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=1}{\@okfalse}{}%
  \if@ok%
    \nullnull%
  \else%
    {\centering\strut\rule[.45\x@ht]{.25\textwidth}{.5pt}\strut\par}%
  \fi%
  \endgroup%
  \comp@re{\current@line=2}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=(\lines@pp-2)}{\@okfalse}{}%
  \if@ok\else%
    \@lert{Single line of text before/after \string\scene, page \this@page}%
  \fi%
  \NoIndentAfterThis%
}
%
\def\scene@line#1{%
  \ifvmode\else\par\fi%
  \getcurrent@line%
  \begingroup\setlength\parindent{0pt}%
  \comp@re{\current@line=\lines@pp}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=1}{\@okfalse}{}%
  \if@ok%
    \null{\centering\strut%
      \smash{\rule[.45\x@ht + .5\@leading]{.25\textwidth}{.5pt}}\strut\par}%
  \else%
    {\centering\strut\rule[.45\x@ht]{.25\textwidth}{.5pt}\strut\par}%
  \fi%
  \endgroup%
  \comp@re{\current@line=2}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=(\lines@pp-2)}{\@okfalse}{}%
  \if@ok\else%
    \@lert{Single line of text before/after \string\scene, page \this@page}%
  \fi%
  \NoIndentAfterThis%
}
\def\scene@asterisks#1{% \uni{204E} is lowercase asterisk.
  \ifvmode\else\par\fi%
  \getcurrent@line%
  \begingroup\setlength\parindent{0pt}%
  \comp@re{\current@line=\lines@pp}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=1}{\@okfalse}{}%
  \if@ok%
    \null{\centering\strut\hfil\hfil\hfil%
     \smash{\raisebox{.5\@leading}{\uni{204E}}}\hfil%
     \smash{\raisebox{.5\@leading}{\uni{204E}}}\hfil%
     \smash{\raisebox{.5\@leading}{\uni{204E}}}%
     \hfil\hfil\hfil\strut\par}%
  \else%
    {\centering\strut\hfil\hfil\hfil%
     \uni{204E}\hfil\uni{204E}\hfil\uni{204E}%
     \hfil\hfil\hfil\strut\par}%
  \fi%
  \endgroup%
  \comp@re{\current@line=2}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=(\lines@pp-2)}{\@okfalse}{}%
  \if@ok\else%
    \@lert{Single line of text before/after \string\scene, page \this@page}%
  \fi%
  \NoIndentAfterThis%
}
\def\scene@text#1{%
  \begingroup\setlength\parindent{0pt}%
  \null\sc@b%
  \strut\smash{\raisebox{.4\type@size}{{\addfontfeature{ScaleAgain=\sc@scale,%
    FakeStretch=\sc@stretch,Numbers=ResetAll,LetterSpace=2}#1}}}%
  \sc@e\ifvmode\else\par\fi\endgroup%
  \NoIndentAfterThis%
}
%%%


%%% INIT (optional styling first few characters of main text, after opening).
%   Format: \init{L}[S] followed by more main text.
%   L -> Uppercase letter, first letter of text. Scaled 1.7.
%        If line begins with punctuation (quotes, etc.) also put it here.
%   S -> Optional letters to be printed as small caps.
% Sometimes, the space between L and S needs adjustment. Use \kern with a
% small (usually negative) value em: \init{L\kern-.04em}[S].
%   If L is a numeral, it will not be set to oldstyle.
\newif\ifin@init
\DeclareDocumentCommand\init{mO{}}{%
  \leavevmode%
  \begingroup\in@inittrue%
  \noindent\strut\smash{%
    {\addfontfeature{ScaleAgain=1.6,RawFeature={+cv10},%
     FakeStretch=.94,Numbers=ResetAll}#1}%
  }%
  \smcp{\obeyspaces#2}% Uppercase remains uppercase.
  \endgroup%
}
%%%


%%
\endinput
%%
%% End of file `novelette-utilities.sty'.
