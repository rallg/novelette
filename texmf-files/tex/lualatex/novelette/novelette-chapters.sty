%% This is file `novelette-chapters.sty', part of `novelette' document class.
%% Copyright 2024 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-chapters.sty}%
[2024/03/04 v0.42 LaTeX file (opening displays, and chapter styles).]
%%

%% This file is loaded AtEndPreamble, when processing interior (not cover).


% CHAPTER OPENINGS, SCENES.
%   The opening environment is a type of display, which begins a new page,
% but does not necessarily occupy a full page. It is generally used at the
% top of the first page in new chapters. It may also be used for other content
% that has that kind of appeaance.
%   If your story is of the fast-action genre, where chapters abruptly begin
% and end mid-page, then you might not use opening much. Otherwise, it is the
% standard way to begin a chapter.
%   If your layout uses a header, it will be empty above an opening. If it uses
% a footer, it will print in mainmatter, but not frontmatter or backmatter.
%   Within an opening, you may write ordinary text, or use \smalltext
% (perhaps within blockindent). You may use \name, \subname, \image, \icon,
% and \format.
%   If you use \footnote within an opening, no reference mark is placed, and no
% reference mark appears at the footnote. This is standard style, because
% the footnote applies to the chapter in general, not to a sentence.
%   After the opening ends, the next line (main text) will not be indented.
% You may use the \init command to style the first letter, and possibly first
% few words. However, drop caps are not available in Novelette.
%%


%%% Code from package `noindentafter', used under terms of LPPL v1.3c.
% Why not simply load the package? Novelette may need to hack it.
% Copyright Michiel Helvensteijn, 2014-2021; Copyright Falk Hanisch, 2021-2021.
\newcommand*\nia@scan{%
  \kernel@ifnextchar\par{%
    \par%
    \def\par{%
      \everypar{\setbox\z@\lastbox\everypar{}}%
      \@restorepar%
    }%
  }{}%
}
\newcommand*\nia@afterendenv{}
\def\nia@afterendenv#1\ignorespaces\fi{#1\ignorespaces\fi\nia@scan}
\newcommand*\NoIndentAfterEnv[1]{\AfterEndEnvironment{#1}{\nia@afterendenv}}
%% End code from `noindentafter'.
\def\nvt@niat{%
  \par\def\par{\everypar{\setbox\z@\lastbox\everypar{}}\@restorepar}%
}
%%


%%% Environment: opening.
\newenvironment{opening}{%
  \ifin@fullpage\else\clearpage\fi%
  \thispagestyle{plain}%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \begingroup%
  \ok@imagetrue\ok@icontrue\ok@floatfalse%
  \ok@styletrue\ok@smalltexttrue\ok@footnotetrue%
  \in@openingtrue%
  \setlength\parindent{0pt}%
}{% Close the environment:
  \ifvmode\else\par\fi%
  \null% Needed for firm vertical position.
  % Calculation: \pagegoal=(\lines@pp+.3)*\@leading).
  % Therefore \lines@pp=(\pagegoal/\@leading)-.3, which must be an integer.
  % To restore the line grid after variable-height content, add \vspace.
  \edef\temp@n{\fpeval{(\pagetotal/\@leading)-.3}}%
  \edef\temp@d{\fpeval{ceil(\temp@n,0)}}%
  \setlength\temp@l{\temp@d\@leading}%
  \addtolength\temp@l{-\temp@n\@leading}%
  \addtolength\temp@l{-2.3\@leading}% Remove excess created by two \null.
  \vspace{\temp@l}%
  \vspace{0pt plus .01pt minus .01pt}% Absorb roundoff.
  \null\null%
  \endgroup%
  \setcounter{fnm@num}{1}%
}
%%
\NoIndentAfterEnv{opening}
%%


% Scene (following paragraph not indented):
%   This command is one way to break a chapter into separate scenes.
% First line after \scene is not indented. Although you may use \init there,
% avoid \init if \scene is not empty, due to visual clash.
%   \scene or \scene{} -> two-line gap: empty.
%   \scene* or \scene{*} -> two-line gap: three spaced, centered asterisks.
%   \scene- or \scene{-} -> two-line gap: centered short horizontal line. 
%   \scene{text} -> two-line gap: text styled according to global \scenestyle
%     in Preamble. Text raised above the second baseline, so it is off-grid.
% Special cases, if a two-line gap would be split across pages:
%   A. \scene* or \scene- places the asterisks or line at bottom of first page,
%      centered at x-height. Next page starts at top (no blank line).
%   B. Empty \scene acts like \scene- would act, with the line.
%   C. \scene{text} leaves empty line at bottom of first page, carries text
%      (with some space above it) to next page.
% Special cases, when the scene is too close to top or bottom of page:
%   D. If no main text follows \scene, \scene*, or \scene- on same page,
%      then no problem. Likewise if no main text precedes it on same page.
%   E. If only one line of main text precedes or follows \scene, \scene*,
%      or \scene- on same page, then an alert is issued.
%   F. If \scene{text} is at top of its page, no problem.
%   G. If \scene{text} is at bottom of its page, then an alert is issued.
%   H. If only one line of main text precedes or follows \scene{text}
%      on same page, then an alert is issued.
%% Helper: Get current line number. Must precede any other line content.
\def\current@line{1}
\def\getcurrent@line{% May need to precede with \ifvmode\else\par\fi. %%%%%
  \edef\current@line{%
    \fpeval{1+\lines@pp-round((\pagegoal-\pagetotal)/\@leading,0)}}%
  \comp@re{\current@line<1}{\gdef\current@line{1}}{}%
  \comp@re{\current@line>200}{\gdef\current@line{1}}{}%
  \comp@re{\current@line>\lines@pp}{%
    \edef\current@line{\fpeval{\current@line-\lines@pp}}}{}%
}
%% Missing brace detection, thanks to egreg, tex.stackexchange.com q.409760.
\newcommand\scene{\@ifnextchar\bgroup{\scene@text}{\scene@notext}}
\def\scene@notext{\@ifnextchar*{\scene@asterisks}{\scene@marker}}
\def\scene@marker{\@ifnextchar-{\scene@line}{\scene@empty}}
\def\scene@empty{%
  \ifvmode\else\par\fi%
  \getcurrent@line%
  \begingroup%
  \setlength\parindent{0pt}%
  \pretolerance=10000% No hyphenation.
  \comp@re{\current@line=\lines@pp}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=1}{\@okfalse}{}%
  \if@ok%
    \null\null%
  \else%
    {\centering\strut\rule[.45\x@ht]{.25\textwidth}{.5pt}\strut\par}%
  \fi%
  \endgroup%
  \comp@re{\current@line=2}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=(\lines@pp-2)}{\@okfalse}{}%
  \if@ok\else%
    \@lert{Single line of text before/after \string\scene, page \this@page}%
  \fi%
%  \NoIndentAfterThis%
  \nvt@niat%
}
%%
\def\scene@line#1{%
  \ifvmode\else\par\fi%
  \getcurrent@line%
  \begingroup\setlength\parindent{0pt}%
  \comp@re{\current@line=\lines@pp}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=1}{\@okfalse}{}%
  \if@ok%
    \null{\centering\strut%
      \smash{\rule[.45\x@ht + .5\@leading]{.25\textwidth}{.5pt}}\strut\par}%
  \else%
    {\centering\strut\rule[.45\x@ht]{.25\textwidth}{.5pt}\strut\par}%
  \fi%
  \endgroup%
  \comp@re{\current@line=2}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=(\lines@pp-2)}{\@okfalse}{}%
  \if@ok\else%
    \@lert{Single line of text before/after \string\scene, page \this@page}%
  \fi%
%  \NoIndentAfterThis%
  \nvt@niat%
}
%%
\def\scene@asterisks#1{% \uni{204E} is lowercase asterisk.
  \ifvmode\else\par\fi%
  \getcurrent@line%
  \begingroup\setlength\parindent{0pt}%
  \comp@re{\current@line=\lines@pp}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=1}{\@okfalse}{}%
  \if@ok%
    \null{\centering\strut\hfil\hfil\hfil%
     \smash{\raisebox{.5\@leading}{\uni{204E}}}\hfil%
     \smash{\raisebox{.5\@leading}{\uni{204E}}}\hfil%
     \smash{\raisebox{.5\@leading}{\uni{204E}}}%
     \hfil\hfil\hfil\strut\par}%
  \else%
    {\centering\strut\hfil\hfil\hfil%
     \uni{204E}\hfil\uni{204E}\hfil\uni{204E}%
     \hfil\hfil\hfil\strut\par}%
  \fi%
  \endgroup%
  \comp@re{\current@line=2}{\@okfalse}{\@oktrue}%
  \comp@re{\current@line=(\lines@pp-2)}{\@okfalse}{}%
  \if@ok\else%
    \@lert{Single line of text before/after \string\scene, page \this@page}%
  \fi%
%  \NoIndentAfterThis%
  \nvt@niat%
}
%%
\def\scene@text#1{%
  \begingroup\setlength\parindent{0pt}%
  \null%
  \ifin@center\else\start@align{\sc@align}\fi%
  \strut\smash{%
    \raisebox{.4\type@size}{%
      \begingroup\add@font@feature{ScaleAgain=\sc@scale,%
        Numbers=ResetAll,LetterSpace=2}#1%
      \endgroup%
    }%
  }%
  \ifin@center\else\stop@align{\sc@align}\fi%
  \ifvmode\else\par\fi\endgroup%
%  \NoIndentAfterThis%
  \nvt@niat%
}
%%


%%% Init (optional styling first few characters of main text, after opening):
% Format: \init{L}[S] followed by more main text.
%   L -> Uppercase letter, first letter of text. Scaled 1.67.
%        If line begins with punctuation (quotes, etc.) also put it here.
%        Any numerals in L will be set to lining, not oldstyle.
%        No Italics: \ital is ignored.
%   S -> Optional letters to be printed as small caps.
% Sometimes, the space between L and S needs adjustment. You may use a small
% kern (usually negative), units em: \init{L\kern-.04em}[S]. Novelette will
% automatically apply a kern, when L is the letter T.
%   You may not use \image or \icon within \init.
\DeclareDocumentCommand\init{mO{}}{%
  \strut\smash{% Swainson cv10 is specially designed for this purpose.
    {\ok@imagefalse\ok@iconfalse%
     \add@font@feature{Scale=1.67,RawFeature={+cv10},Numbers=ResetAll}#1}%
  }%
  \IfEndWith{#1}{T}{\kern-.16em}{}%
  \smcp{\obeyspaces#2}% Uppercase remains uppercase.
  \obeyspaces%
}
%%


%%
\endinput
%%
%% End of file `novelette-chapters.sty'.
