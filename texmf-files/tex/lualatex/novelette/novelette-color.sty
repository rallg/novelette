%% This is file `novelette-color.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-color.sty}%
[2023/12/05 v0.23 LaTeX file (alternative to standard color).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).


%% LIMITED GRAY COLOR
%% ----------------------------------------------------------------------------
%   Standard LaTeX color macros are contained in the LaTeX graphics bundle,
% by David Carlisle, Sebastian Rahtz, and other members of the LaTeX project,
% and individual authors. Shout-out to them!
%   But Novelette does not allow color interior. All text and images must be
% in black ink. The only exception is the use of gray, when not in final mode.
%   Typo mode uses color. So Novelette allows it to load the color package,
% do what it needs to do in Preamble, then quickly over-writes color commands.
% The typo color is managed by luacolor, not LaTeX color.
%%


%%
\ifthenelse{\equal{\@mode}{typo}\OR\equal{\@mode}{typo*}}{ % Loads color.
  \definecolor{dkmag}{rgb}{.8,0,.8}
  \begingroup
  \color{dkmag}%
  \directlua{
    nvttypo.colortbl[1]=\the\LuaCol@Attribute
    local tbl = nvttypo.colortbl
    local map = { }
    for i,v in ipairs (nvttypo.colortbl) do
      if i == 1 or v > tbl[i-1] then
         table.insert(map, v)
      end
    end
    nvttypo.map = map
  }%
  \endgroup
}{}
\ifthenelse{\equal{\@mode}{typo*}}{%
  \definecolor{lt@gray}{rgb}{.7,.7,.7}%
  \color{lt@gray}%
}{}
%% Now over-write color commands:


%% Warn if document has a standard LaTeX color command:
\newif\ifsent@colorwarning % When true, prevents color warning duplicates.
\def\color@warning{%
  \ifsent@colorwarning\else%
    \ClassWarning{novelette}{Cannot use color or grayscale in Novelette.^^J%
      Any color-related commands will be ignored.}%
  \fi%
}
\DeclareDocumentCommand\color{O{}m}{\color@warning\ignorespaces}
\def\textcolor#1#2{\leavevmode\color@warning #2}
\def\colorbox#1#2{\leavevmode\color@warning #2}
\def\pagecolor#1{\color@warning}
\def\nopagecolor{\color@warning}
\def\definecolor#1#2#3{\color@warning}
\def\DefineNamedColor#1#2#3#4{\color@warning}
%%


%% Allow only black and (sometimes) gray shades:
\def\normalcolor{}
\def\bl@ck{0 g 0 G}
\def\sh@de{0 g 0 G}
\def\@newcolor{%
  \pdfextension colorstack 0 push{\sh@de}%
  \aftergroup\@prevcolor%
}
\def\@prevcolor{\pdfextension colorstack 0 pop\relax}
\DeclareRobustCommand\gr@y[1]{%
  \def\sh@de{#1 g #1 G}\@newcolor\ignorespaces%
}
%%


%%
\endinput
%%
%% End of file `novelette-color.sty'.
