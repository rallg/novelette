%% This is file `novelette-fonts.sty', part of `novelette' document class.
%% Copyright 2024 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-fonts.sty}%
[2024/01/06 v0.30 LaTeX file (font settings and defaults).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).


%% Math? Bah! Swainson has ssty with math script. Not enough for actual math.
\setmathrm{Swainson}
%%


%% Hat tip to Marcel Krüger, tex.stackexchange.com q. 684762:
\directlua{
  fonts.handlers.otf.addfeature {
    name = 'nvt_liga',
    type = 'ligature',
    data = {
      [0x2014] = {0x2014, 0x002D},
    },
  }
}
\directlua{
  fonts.handlers.otf.addfeature {
    name = 'nvt_shortf',
    type = 'substitution',
    data = {
      ["f"] = "f.short",
    },
  }
}
%%


%% Swainson character `f' does not need ligatures.
\default@font@features{} % Reset.
\default@font@features{Renderer=Node,RawFeature={tlig,nvt_liga,kern}} % All. 
%%


%% Swainson character variants for increased bearings in french.
% In locations where you do not use Swainson, you must manually type the space.
\def\fr@feat{}
\ifthenelse{\equal{\set@lang}{french}}{
  % Option [fr] and default without option: Thin space before :;!? and
  % closing single/double guillemets, emdash, uni2015.
  % Also after opening single/double guillemets. 
  \ifthenelse{\equal{\lang@option}{fr}\OR\equal{\lang@option}{}}{
    \gdef\fr@feat{RawFeature={+cv20,+cv21}} % Thin space punct and colon.
  }{}
  % Option [ch] is like [fr], but with full space before colon.
  \ifthenelse{\equal{\lang@option}{ch}}{
    \gdef\fr@feat{RawFeature={+cv20,+cv22}}
  }{}
  % Option [ca] only provides thin space before colon.
  \ifthenelse{\equal{\lang@option}{ca}}{
   \gdef\fr@feat{RawFeature={+cv21}}
  }{}
  % Option [x] provides no extra spacing.
}{}
%%


%% PROCESS FONTS
\newlength\X@ht % X-height of Swainson.
\newlength\x@ht % x-height of Swainson.
\newlength\chars@ht % Max height of Swainson Latin-1 characters.
\newlength\chars@dp % Max depth of Swainson Latin-1 characters (positive).
\newif\if@libertinus % True if Libertinus fonts are found.
\IfFileExists{LibertinusSerif-Regular.otf}{
  \IfFileExists{LibertinusSans-Regular.otf}{\global\@libertinustrue}{}
}{}
\newcounter{alt@count} % Incremented if \alt{char} without libertinus.
\def\process@fonts{
  % main font, used for body text:
  \setmainfont{Swainson}[\fr@feat, Numbers=OldStyle]
  \let\mainfont\rmfamily\relax
  \let\main\relax
  % sans font, same as main font. Not actually used:
  \setsansfont{Swainson}[\fr@feat, Numbers=OldStyle]
  \let\sffamily\relax % Ignore \sffamily elsewhere.


%%%%%  \let\bfseries\relax % No bold.

  % Provide fallback characters, if available:
  \if@libertinus
    \setmonofont{Libertinus Serif}[Numbers=OldStyle,RawFeature={+nvt_fshort}]
    \let\alt@font\ttfamily\relax
    \gdef\alt##1{% This calculation is specific to Libertinus Serif.
      \StrSubstitute{##1}{‖}{|\kern-.1em|}[\temp@s]% Double bar is too tall.
      \sbox0{\alt@font\temp@s}%
      \@okfalse% lowercase when false, uppercase when true.
      \comp@re{\ht0>.644em}{%
        \comp@re{\ht0<.661em}{\@oktrue}{}%
      }{}%
      \comp@re{\ht0>.799em}{\@oktrue}{}%
      \if@ok%
        {\alt@font\temp@s}%
      \else%
        {\alt@font\addfontfeature{ScaleAgain=.93,FakeStretch=1.02}\temp@s}%
      \fi%
      \obeyspaces%
    }
  \else
    \setmonofont{Swainson}[\fr@feat, Numbers=OldStyle] % Same as main font.
    \gdef\alt##1{%
      \comp@re{\value{alt@count}=0}{}{%
        \nvt@err{Font `Libertinus Serif' not installed for \string\alt{char}}
          {You requested \string\alt, which requires fonts^^J%
           installed by package `libertinus-fonts'. They were not found.^^J%
           Use the TeX package manager to install `libertinus-fonts'.^^J%
           Until then, missing character symbols may appear.}%
        \@lert{\string\alt{text} needs Libertinus Serif font.}%
      }%
      {##1}\obeyspaces%
      \stepcounter{alt@count}%
    }
  \fi
  \let\ttfamily\relax % Ignore \ttfamily elsewhere.
  \newfontface\f@sans{Towhee-Regular.otf}[\fr@feat, Numbers=ResetAll]
  \newfontface\f@light{Towhee-Light.otf}[\fr@feat, Numbers=ResetAll]
  \newfontface\f@dark{Towhee-Medium.otf}[\fr@feat, Numbers=ResetAll]
  \let\head@font\relax
  \ifthenelse{\equal{\hf@font}{sans}}{\let\head@font\f@sans}{}
  \ifthenelse{\equal{\hf@font}{light}}{\let\head@font\f@light}{}
  \ifthenelse{\equal{\hf@font}{dark}}{\let\head@font\f@dark}{}
  % Swainson Metrics:
  \global\deflength\X@ht{.65\type@size}
  \global\deflength\x@ht{.4\type@size}
  \global\deflength\chars@ht{.84\type@size}
  \global\deflength\chars@dp{.26\type@size} % It is actually less.
  \edef\chars@line{\fpeval{trunc(\textwidth / (.41*\type@size),0)}}
  \setlength\temp@l{\m@top+.5\pageheight-.5\trim@h-1in}
  \global\deflength\topmargin{\temp@l+\chars@ht-\@leading}
  \process@protexp % Lower on this page.
}
%%


%% FEATURE COMMANDS
\def\sups#1{\strut%
  {\add@font@feature{Numbers=ResetAll,VerticalPosition=Superior}#1}%
}
\let\sup\sups\relax
%%
\def\subs#1{\strut%
  {\add@font@feature{Numbers=ResetAll,VerticalPosition=Inferior}#1}%
}
\let\sub\subs\relax
%%
\long\def\smcp#1{\strut{\add@font@feature{Letters=SmallCaps}#1}}
\long\def\allsmcp#1{% uppercase+lowercase to small caps
  \strut{\add@font@feature{Letters=UppercaseSmallCaps,Letters=SmallCaps}#1}%
}
\let\textsc\smcp\relax % unified
\let\oldscshape\scshape\relax % unified
\let\scshape\smcp\relax % unified
%%
\long\def\lnum#1{\strut{\add@font@feature{Numbers=ResetAll,Numbers=Lining}#1}}
\long\def\onum#1{%
  \strut{\add@font@feature{Numbers=ResetAll,Numbers=Lowercase}#1}%
}
%% Fake medium caps:
\DeclareDocumentCommand\medcap{m}{%
  \strut\smash{{\add@font@feature{Letters=UppercaseSmallCaps,%
    ScaleAgain=1.22,FakeStretch=.88}#1}\strut}%
}
\let\medcaps\medcap\relax
%%

%% Font expansion and protrusion (does not need microtype).
%  Values 20 20 1 use font expansion (sretch/shrink) +/- 2%, steps 0.1%.
%    The \lpcode and \rpcode values are in font units, 1000/em.
%  Positive codes are set to absorb the left/right bearing of that character.
%  Negative codes are se to push back left\right overhand of that character.
%    The values are specific to Swainson fonts, and are not needed for those
%  places where \alt font (Libertinus Serif) may be used as fallback.
\gdef\process@protexp{
  \expandglyphsinfont\the\font 20 20 1
    \begingroup\itshape\expandglyphsinfont\the\font 20 20 1\endgroup
    \begingroup
      \sffamily\expandglyphsinfont\the\font 20 20 1
      \lpcode\font`\-=57  \rpcode\font`\-=56
      \lpcode\font`\,=17  \rpcode\font`\,=40
      \lpcode\font`\.=40  \rpcode\font`\.=40
      \lpcode\font`\:=40  \rpcode\font`\;=40
      \lpcode\font`\;=17  \rpcode\font`\;=40
      \lpcode\font`\‘=40  \rpcode\font`\‘=40
      \lpcode\font`\’=40  \rpcode\font`\’=40
      \lpcode\font`\“=56  \rpcode\font`\“=56
      \lpcode\font`\”=56  \rpcode\font`\”=56
      \lpcode\font`\«=22  \rpcode\font`\«=37
      \lpcode\font`\»=37  \rpcode\font`\»=22
      \lpcode\font`\‹=22  \rpcode\font`\‹=37
      \lpcode\font`\›=37  \rpcode\font`\›=22

      \lpcode\font`\J=-62 \rpcode\font`\J=0
      \lpcode\font`\Q=0   \rpcode\font`\Q=28
      \lpcode\font`\f=0   \rpcode\font`\f=6

      \lpcode\font`\j=-45 \rpcode\font`\j=0

      %     ‐‑‒–—―‚‛„  florin dotlessj ff Jlining J.c2sc J.sc
      \itshape\expandglyphsinfont\the\font 20 20 1
    \endgroup
    \begingroup
      \ttfamily\expandglyphsinfont\the\font 20 20 1
      \itshape\expandglyphsinfont\the\font 20 20 1
    \endgroup
  \adjustspacing=2 % Necessary, or above expansions do not work.
  \protrudechars=2 % Necessary, or the above protrusions do not work.
}
%%


%%
\endinput
%%
%% End of file `novelette-fonts.sty'
