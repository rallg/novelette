%% This is file `novelette-fonts.sty', part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, version 1.3c.
%%
\ProvidesFile{novelette-fonts.sty}%
[2023/09/26 v0.17 LaTeX file (font settings and defaults).]
%%


%% This file is loaded AtEndPreamble, when processing interior (not cover).

%% Choice of fonts is in novelette-settings.sty.


%% Problem: TeX uses --- for emdash. Word processors use -- instead.
%% Send your file to a human editor, and back comes emdash- there. Wrong.
%% Solution: Use Lua to intercept emdash-, change it to emdash alone.
%% Thanks to Marcel Krüger, tex.stackexchange.com q. 684762:
\directlua{
  fonts.handlers.otf.addfeature {
    name = 'nvth', type = 'ligature',
    data = { [0x2014] = {0x2014, 0x002D}, },
  }
}
%%


\defaultfontfeatures{} % Reset.
\def\std@feat{Kerning=On,Numbers=OldStyle,Ligatures=TeX,RawFeature=nvth}


%%
\def\process@fonts{
  \ifthenelse{\equal{\main@name}{Swainson}\OR\equal{\main@name}{}}{
    \setmainfont{Swainson-Regular.otf}[
      ItalicFont=Swainson-Italic.otf, BoldFont=Swainson-Regular.otf,
      BoldItalicFont=Swainson-Italic.otf, \std@feat, \main@feat]
    \newfontfamily\footnote@font{Towhee-Regular.otf}[
      ItalicFont=Towhee-Italic.otf, BoldFont=Towhee-Regular.otf,
      BoldItalicFont=Towhee-Italic.otf, \std@feat, \main@feat]
  }{
    \setmainfont[\std@feat,\main@feat]{\main@name}
    \let\footnote@font\relax
  }
  \gdef\main##1{{\rmfamily##1}}
  \ifdefined\mono@name
    \setmonofont{\mono@name}[\mono@feat,Scale=MatchLowercase]
  \else
    \setmonofont{Latin Modern Mono}[Scale=MatchLowercase]
    \gdef\mono@name{Latin Modern Mono}
  \fi
  \gdef\mono##1{{\ttfamily##1}}
  \g@addto@macro\std@feat{,Scale=MatchLowercase}
  \ifdefined\sans@name
    \setsansfont{\sans@name}[\std@feat,\sans@feat]
  \else
    \setsansfont{Latin Modern Sans}[\std@feat]
    \gdef\sans@name{Latin Modern Sans}
  \fi
  \gdef\sans##1{{\sffamily##1}}
  \ifdefined\alt@name
    \newfontfamily\alt@font{\alt@name}[\std@feat,\alt@feat]
  \else
    \newfontfamily\alt@font{Latin Modern Roman}[\std@feat]
    \gdef\alt@name{Latin Modern Roman}
  \fi
  \gdef\alt##1{{\alt@font##1}}
  \LetLtxMacro\textfallback\alt\relax
  \ifdefined\drama@name
    \newfontfamily\drama@font{\drama@name}[\std@feat,\drama@feat]
    \gdef\drama##1{{\drama@font##1}}
  \else
    \let\drama\relax % Will be same as mainfont.
    \xdef\drama@name{\main@name} \xdef\drama@feat{\main@feat}
  \fi
  \ifdefined\deco@name
    \newfontface\deco@font{\deco@name}[\std@feat,\deco@feat]
    \gdef\deco##1{{\deco@font##1}}
  \else
    \let\deco\relax % Will be same as mainfont.
    \xdef\deco@name{\main@name} \xdef\deco@feat{\main@feat}
  \fi
  \sbox0{ÀÁÂÃÄÅÇçðþJQgjpqy}
  \edef\temp@n{\fpeval{(\ht0 + \dp0) / \type@size}}
  \comp@re{\temp@n>1.2}{
     \edef\temp@d{\fpeval{(\temp@n / 1.2) * type@size}}
     \edef\temp@d{\fpeval{trunc(\temp@d,2)}}
     \setlength\type@size{\temp@d pt}
     \renewcommand\normalsize{\@setfontsize\normalsize{\type@size}{\le@ding}}
     \normalsize
     \edef\temp@n{\fpeval{round(\temp@n,3,0)}}
     \xdef\typescale@message{\space\space %
       Note: This main font has overly tall or deep Latin-1 characters.^^J%
       \space\space It was automatically scaled to \temp@n x\string\typesize.%      
     }
  }{}
  \sbox0{X}
  \global\deflength\X@ht{\ht0}
  \sbox0{x}
  \global\deflength\x@ht{\ht0}
  \sbox0{ÀÁÂÃÄÅÇçðþJQgjpqy}
  \global\deflength\chars@ht{\ht0}
  \global\deflength\chars@dp{\dp0}
  \global\deflength\line@gap{\le@ding-\chars@ht-\chars@dp}
  \ifthenelse{\dimtest{\ht0}{>}{.7\le@ding}\OR\dimtest{\dp0}{>}{.3\le@ding}}{
     \@error{Incompatible settings (or defaults) for typesize and lines.^^J%
        Current values: typesize=\the\type@size, lines=\lines@pp.^^J%
        Either manually reduce typesize, or manually reduce lines.^^J%
        Or, use a different font.}
  }{}
  \sbox0{eeeeeeeeeeeetttttttttaaaaaaaaiiiiiiiinnn}
  \setlength\temp@l{\wd0}
  \sbox0{nnnnnoooooooosssssssshhhhhhrrrrrrdddddll}
  \addtolength\temp@l{\wd0}
  \sbox0{lluuucccmmmffwwyyg p v k x z WT A. , , ,}
  \addtolength\temp@l{\wd0}
  \edef\temp@n{\fpeval{(120 * \textwidth) / \temp@l}}
  \xdef\chars@line{\fpeval{trunc(\temp@n,0)}}
  \setlength\temp@l{\m@top+.5\pageheight-.5\book@h-1in}
  \global\deflength\topmargin{\temp@l+\chars@ht-\le@ding}
  \setlength\temp@l{\printable@ht}
  \ifhe@der\addtolength\temp@l{-\headheight-\headsep}\fi %%%%%
  \iff@@ter\addtolength\temp@l{-\le@ding-\footskip}\fi %%%%%
  \setlength\@slop{\temp@l-\lines@pp\le@ding+\le@ding-\chars@ht}
}
%%


%% FEATURE COMMANDS
\def\sups#1{{\addfontfeature{Numbers=ResetAll,VerticalPosition=Superior}#1}}
\let\sup\sups\relax
%%
\def\subs#1{{\addfontfeature{Numbers=ResetAll,VerticalPosition=Inferior}#1}}
\let\sub\subs\relax
%%
\long\def\smcp#1{{\addfontfeature{Letters=SmallCaps}#1}}
\long\def\allsmcp#1{% uppercase+lowercase to small caps
  {\addfontfeature{Letters=UppercaseSmallCaps,Letters=SmallCaps}#1}%
}
\let\textsc\smcp\relax % unified
\let\oldscshape\scshape\relax % unified
\let\scshape\smcp\relax % unified
%%
\long\def\lnum#1{{\addfontfeature{Numbers=ResetAll,Numbers=Lining}#1}}
\long\def\onum#1{{\addfontfeature{Numbers=ResetAll,Numbers=Lowercase}#1}}
%% Fake medium caps:
\DeclareDocumentCommand\medcap{+m}{%
  \sbox0{{\addfontfeature{Letters=UppercaseSmallCaps}X}}%
  \ifdimcomp{\ht0}{>}{0pt}{%
    \edef\temp@n{\fpeval{(.5 * (\X@ht + \ht0)) / \ht0}}%
    \edef\temp@d{\fpeval{1 / \temp@n}}
    \smash{{\addfontfeature{Letters=UppercaseSmallCaps,%
      ScaleAgain=\temp@n,FakeStretch=\temp@d}#1}}%
  }{#1}%
}
\let\medcaps\medcap\relax
%%



%%
\endinput
%%
%% End of file `novelette-fonts.sty'
